/*! RiverTrail 10-10-2016 */
if(function(){var narcissus={options:{version:185,hiddenHostGlobals:{Narcissus:!0},desugarExtensions:!1,allowHTMLComments:!1},hostSupportsEvalConst:function(){try{return eval("(function(s) { eval(s); return x })('const x = true;')")}catch(e){return!1}}(),hostGlobal:this};Narcissus=narcissus}(),Narcissus.definitions=function(hostGlobal){function defineGetter(a,b,c,d,e){Object.defineProperty(a,b,{get:c,configurable:!d,enumerable:!e})}function defineGetterSetter(a,b,c,d,e,f){Object.defineProperty(a,b,{get:c,set:d,configurable:!e,enumerable:!f})}function defineMemoGetter(a,b,c,d,e){Object.defineProperty(a,b,{get:function(){var f=c();return defineProperty(a,b,f,d,!0,e),f},configurable:!0,enumerable:!e})}function defineProperty(a,b,c,d,e,f){Object.defineProperty(a,b,{value:c,writable:!e,configurable:!d,enumerable:!f})}function isNativeCode(a){return"function"==typeof a&&a.toString().match(/\[native code\]/)}function apply(a,b,c){return Fpapply.call(a,[b].concat(c))}function getPropertyDescriptor(a,b){for(;a;){if({}.hasOwnProperty.call(a,b))return Object.getOwnPropertyDescriptor(a,b);a=Object.getPrototypeOf(a)}}function getPropertyNames(a){for(var b=Object.create(null,{});a;){for(var c=Object.getOwnPropertyNames(a),d=0,e=c.length;e>d;d++)b[c[d]]=!0;a=Object.getPrototypeOf(a)}return Object.keys(b)}function getOwnProperties(a){var b={};for(var c in Object.getOwnPropertyNames(a))b[c]=Object.getOwnPropertyDescriptor(a,c);return b}function blacklistHandler(a,b){var c=Object.create(null,{}),d=Dict.create(b).mapObject(function(){return c});return mixinHandler(d,a)}function whitelistHandler(a,b){var c=Object.create(null,{}),d=Dict.create(b).mapObject(function(){return a});return mixinHandler(d,c)}function mirrorHandler(a,b){var c=makePassthruHandler(a),d=c.defineProperty;return c.defineProperty=function(a,c){if(!c.enumerable)throw new Error("mirror property must be enumerable");if(!c.configurable)throw new Error("mirror property must be configurable");if(c.writable!==b)throw new Error("mirror property must "+(b?"":"not ")+"be writable");d(a,c)},c.fix=function(){},c.getOwnPropertyDescriptor=c.getPropertyDescriptor,c.getOwnPropertyNames=getPropertyNames.bind(c,a),c.keys=c.enumerate,c["delete"]=function(){return!1},c.hasOwn=c.has,c}function mixinHandler(a,b){function c(c){return hasOwn(a,c)?a[c]:b}function d(a){var b=getPropertyDescriptor(c(a),a);return b&&(b.configurable=!0),b}function e(){var c=Object.getOwnPropertyNames(a).filter(function(b){return b in a[b]}),d=getPropertyNames(b).filter(function(b){return!hasOwn(a,b)});return c.concat(d)}function f(){var c=Object.getOwnPropertyNames(a).filter(function(b){return b in a[b]});for(name in b)hasOwn(a,name)||c.push(name);return c}function g(a){return a in c(a)}return{getOwnPropertyDescriptor:d,getPropertyDescriptor:d,getOwnPropertyNames:e,defineProperty:function(a,b){Object.defineProperty(c(a),a,b)},"delete":function(a){var b=c(a);return delete b[a]},fix:function(){},has:g,hasOwn:g,get:function(a,b){var d=c(b);return d[b]},set:function(a,b,d){var e=c(b);return e[b]=d,!0},enumerate:f,keys:f}}function makePassthruHandler(a){return{getOwnPropertyDescriptor:function(b){var c=Object.getOwnPropertyDescriptor(a,b);return c.configurable=!0,c},getPropertyDescriptor:function(b){var c=getPropertyDescriptor(a,b);return c.configurable=!0,c},getOwnPropertyNames:function(){return Object.getOwnPropertyNames(a)},defineProperty:function(b,c){Object.defineProperty(a,b,c)},"delete":function(b){return delete a[b]},fix:function(){return Object.isFrozen(a)?getOwnProperties(a):void 0},has:function(b){return b in a},hasOwn:function(b){return{}.hasOwnProperty.call(a,b)},get:function(b,c){return a[c]},set:function(b,c,d){return a[c]=d,!0},enumerate:function(){var b=[];for(name in a)b.push(name);return b},keys:function(){return Object.keys(a)}}}function hasOwn(a,b){return hasOwnProperty.call(a,b)}function Dict(a,b){this.table=a||Object.create(null,{}),this.size=b||0}function WeakMap(a){this.array=a||[]}function searchMap(a,b,c,d){for(var e=a.array,f=0,g=e.length;g>f;f++){var h=e[f];if(h.key===b)return c(h,f)}return d()}function Stack(a){this.elts=a||null}for(var tokens=["END","\n",";",",","=","?",":","CONDITIONAL","||","&&","|","^","&","==","!=","===","!==","<","<=",">=",">","<<",">>",">>>","+","-","*","/","%","!","~","UNARY_PLUS","UNARY_MINUS","++","--",".","[","]","{","}","(",")","SCRIPT","BLOCK","LABEL","FOR_IN","CALL","NEW_WITH_ARGS","INDEX","ARRAY_INIT","OBJECT_INIT","PROPERTY_INIT","GETTER","SETTER","GROUP","LIST","LET_BLOCK","ARRAY_COMP","GENERATOR","COMP_TAIL","IDENTIFIER","NUMBER","STRING","REGEXP","break","case","catch","const","continue","debugger","default","delete","do","else","export","false","finally","for","function","if","import","in","instanceof","let","module","new","null","return","switch","this","throw","true","try","typeof","var","void","yield","while","with"],statementStartTokens=["break","const","continue","debugger","do","for","if","return","switch","throw","try","var","yield","while","with"],whitespaceChars=["	","","\f"," "," ","﻿"," ","᠎"," "," "," "," "," "," "," "," "," "," "," "," "," ","　"],whitespace={},i=0;i<whitespaceChars.length;i++)whitespace[whitespaceChars[i]]=!0;for(var opTypeNames={"\n":"NEWLINE",";":"SEMICOLON",",":"COMMA","?":"HOOK",":":"COLON","||":"OR","&&":"AND","|":"BITWISE_OR","^":"BITWISE_XOR","&":"BITWISE_AND","===":"STRICT_EQ","==":"EQ","=":"ASSIGN","!==":"STRICT_NE","!=":"NE","<<":"LSH","<=":"LE","<":"LT",">>>":"URSH",">>":"RSH",">=":"GE",">":"GT","++":"INCREMENT","--":"DECREMENT","+":"PLUS","-":"MINUS","*":"MUL","/":"DIV","%":"MOD","!":"NOT","~":"BITWISE_NOT",".":"DOT","[":"LEFT_BRACKET","]":"RIGHT_BRACKET","{":"LEFT_CURLY","}":"RIGHT_CURLY","(":"LEFT_PAREN",")":"RIGHT_PAREN"},keywords={__proto__:null},tokenIds={},consts=Narcissus.hostSupportsEvalConst?"const ":"var ",i=0,j=tokens.length;j>i;i++){i>0&&(consts+=", ");var t=tokens[i],name;/^[a-z]/.test(t)?(name=t.toUpperCase(),keywords[t]=i):name=/^\W/.test(t)?opTypeNames[t]:t,consts+=name+" = "+i,tokenIds[name]=i,tokens[t]=i}consts+=";";var isStatementStartCode={__proto__:null};for(i=0,j=statementStartTokens.length;j>i;i++)isStatementStartCode[keywords[statementStartTokens[i]]]=!0;var assignOps=["|","^","&","<<",">>",">>>","+","-","*","/","%"];for(i=0,j=assignOps.length;j>i;i++)t=assignOps[i],assignOps[t]=tokens[t];var Fpapply=Function.prototype.apply,applyNew;applyNew=Function.prototype.bind?function(a,b){return new(a.bind.apply(a,[,].concat(b)))}:function applyNew(f,a){switch(a.length){case 0:return new f;case 1:return new f(a[0]);case 2:return new f(a[0],a[1]);case 3:return new f(a[0],a[1],a[2]);default:for(var argStr="a[0]",i=1,n=a.length;n>i;i++)argStr+=",a["+i+"]";return eval("new f("+argStr+")")}};var hasOwnProperty={}.hasOwnProperty;return Dict.create=function(a){for(var b=Object.create(null,{}),c=0,d=Object.getOwnPropertyNames(a),e=0,f=d.length;f>e;e++){var g=d[e];b[g]=a[g],c++}return new Dict(b,c)},Dict.prototype={has:function(a){return hasOwnProperty.call(this.table,a)},set:function(a,b){hasOwnProperty.call(this.table,a)||this.size++,this.table[a]=b},get:function(a){return this.table[a]},getDef:function(a,b){return hasOwnProperty.call(this.table,a)||(this.size++,this.table[a]=b()),this.table[a]},forEach:function(a){var b=this.table;for(var c in b)a.call(this,c,b[c])},map:function(a){var b=(this.table,Object.create(null,{}));return this.forEach(function(c,d){b[c]=a.call(this,d,c)}),new Dict(b,this.size)},mapObject:function(a){var b=(this.table,Object.create(null,{}));return this.forEach(function(c,d){b[c]=a.call(this,d,c)}),b},toObject:function(){return this.mapObject(function(a){return a})},choose:function(){return Object.getOwnPropertyNames(this.table)[0]},remove:function(a){hasOwnProperty.call(this.table,a)&&(this.size--,delete this.table[a])},copy:function(){var a=Object.create(null,{});for(var b in this.table)a[b]=this.table[b];return new Dict(a,this.size)},keys:function(){return Object.keys(this.table)},toString:function(){return"[object Dict]"}},WeakMap.prototype={has:function(a){return searchMap(this,a,function(){return!0},function(){return!1})},set:function(a,b){var c=this.array;searchMap(this,a,function(a){a.value=b},function(){c.push({key:a,value:b})})},get:function(a){return searchMap(this,a,function(a){return a.value},function(){return null})},"delete":function(a){var b=this.array;searchMap(this,a,function(a,c){b.splice(c,1)},function(){})},toString:function(){return"[object WeakMap]"}},Stack.prototype={push:function(a){return new Stack({top:a,rest:this.elts})},top:function(){if(!this.elts)throw new Error("empty stack");return this.elts.top},isEmpty:function(){return null===this.top},find:function(a){for(var b=this.elts;b;b=b.rest)if(a(b.top))return b.top;return null},has:function(a){return Boolean(this.find(function(b){return b===a}))},forEach:function(a){for(var b=this.elts;b;b=b.rest)a(b.top)}},Array.prototype.copy||defineProperty(Array.prototype,"copy",function(){for(var a=[],b=0,c=this.length;c>b;b++)a[b]=this[b];return a},!1,!1,!0),Array.prototype.top||defineProperty(Array.prototype,"top",function(){return this.length&&this[this.length-1]},!1,!1,!0),{tokens:tokens,whitespace:whitespace,opTypeNames:opTypeNames,keywords:keywords,isStatementStartCode:isStatementStartCode,tokenIds:tokenIds,consts:consts,assignOps:assignOps,defineGetter:defineGetter,defineGetterSetter:defineGetterSetter,defineMemoGetter:defineMemoGetter,defineProperty:defineProperty,isNativeCode:isNativeCode,apply:apply,applyNew:applyNew,mirrorHandler:mirrorHandler,mixinHandler:mixinHandler,whitelistHandler:whitelistHandler,blacklistHandler:blacklistHandler,makePassthruHandler:makePassthruHandler,Dict:Dict,WeakMap:hostGlobal.WeakMap||WeakMap,Stack:Stack}}(this),Narcissus.lexer=function(){function isValidIdentifierChar(a,b){if("">=a)return a>="a"&&"z">=a||a>="A"&&"Z">=a||"$"===a||"_"===a||!b&&a>="0"&&"9">=a?!0:!1;var c={};c["x"+a]=!0,c[a]=!0;var d=!1;try{d=Function("x","return (x."+(b?"":"x")+a+");")(c)===!0}catch(e){}return d}function isIdentifier(a){if("string"!=typeof a)return!1;if(0===a.length)return!1;if(!isValidIdentifierChar(a[0],!0))return!1;for(var b=1;b<a.length;b++)if(!isValidIdentifierChar(a[b],!1))return!1;return!0}function Tokenizer(a,b,c){this.cursor=0,this.source=String(a),this.tokens=[],this.tokenIndex=0,this.lookahead=0,this.scanNewlines=!1,this.unexpectedEOF=!1,this.filename=b||"",this.lineno=c||1,this.blackList=blackLists[Narcissus.options.version],this.blockComments=null}var definitions=Narcissus.definitions;eval(definitions.consts);const blackLists={160:{},185:{},harmony:{}};blackLists[160][LET]=!0,blackLists[160][MODULE]=!0,blackLists[160][YIELD]=!0,blackLists[185][MODULE]=!0;var opTokens={};for(var op in definitions.opTypeNames)if("\n"!==op&&"."!==op)for(var node=opTokens,i=0;i<op.length;i++){var ch=op[i];ch in node||(node[ch]={}),node=node[ch],node.op=op}return Tokenizer.prototype={get done(){return this.peek(!0)===END},get token(){return this.tokens[this.tokenIndex]},match:function(a,b,c){return this.get(b,c)===a||this.unget()},mustMatch:function(a,b){if(!this.match(a,!1,b))throw this.newSyntaxError("Missing "+definitions.tokens[a].toLowerCase());return this.token},peek:function(a){var b,c;return this.lookahead?(c=this.tokens[this.tokenIndex+this.lookahead&3],b=this.scanNewlines&&c.lineno!==this.lineno?NEWLINE:c.type):(b=this.get(a),this.unget()),b},peekOnSameLine:function(a){this.scanNewlines=!0;var b=this.peek(a);return this.scanNewlines=!1,b},lastBlockComment:function(){var a=this.blockComments.length;return a?this.blockComments[a-1]:null},skip:function(){var a=this.source;for(this.blockComments=[];;){var b=a[this.cursor++],c=a[this.cursor];if("\r"===b){if("\n"===c)continue;b="\n"}if("\n"!==b||this.scanNewlines){if("/"===b&&"*"===c){for(var d=++this.cursor;;){if(b=a[this.cursor++],void 0===b)throw this.newSyntaxError("Unterminated comment");if("*"===b){if(c=a[this.cursor],"/"===c){var e=this.cursor-1;this.cursor++;break}}else"\n"===b&&this.lineno++}this.blockComments.push(a.substring(d,e))}else if("/"===b&&"/"===c||Narcissus.options.allowHTMLComments&&"<"===b&&"!"===c&&"-"===a[this.cursor+1]&&"-"===a[this.cursor+2]&&(this.cursor+=2))for(this.cursor++;;){if(b=a[this.cursor++],c=a[this.cursor],void 0===b)return;if("\r"===b&&"\n"!==c&&(b="\n"),"\n"===b){this.scanNewlines?this.cursor--:this.lineno++;break}}else if(!(b in definitions.whitespace))return void this.cursor--}else this.lineno++}},lexExponent:function(){var a=this.source,b=a[this.cursor];if("e"===b||"E"===b){if(this.cursor++,ch=a[this.cursor++],("+"===ch||"-"===ch)&&(ch=a[this.cursor++]),"0">ch||ch>"9")throw this.newSyntaxError("Missing exponent");do ch=a[this.cursor++];while(ch>="0"&&"9">=ch);return this.cursor--,!0}return!1},lexZeroNumber:function(a){var b=this.token,c=this.source;if(b.type=NUMBER,a=c[this.cursor++],"."===a){do a=c[this.cursor++];while(a>="0"&&"9">=a);this.cursor--,this.lexExponent(),b.value=parseFloat(c.substring(b.start,this.cursor))}else if("x"===a||"X"===a){do a=c[this.cursor++];while(a>="0"&&"9">=a||a>="a"&&"f">=a||a>="A"&&"F">=a);this.cursor--,b.value=parseInt(c.substring(b.start,this.cursor))}else if(a>="0"&&"7">=a){do a=c[this.cursor++];while(a>="0"&&"7">=a);this.cursor--,b.value=parseInt(c.substring(b.start,this.cursor))}else this.cursor--,this.lexExponent(),b.value=0},lexNumber:function(a){var b=this.token,c=this.source;b.type=NUMBER;var d=!1;do a=c[this.cursor++],"."!==a||d||(d=!0,a=c[this.cursor++]);while(a>="0"&&"9">=a);this.cursor--;var e=this.lexExponent();d=d||e;var f=c.substring(b.start,this.cursor);b.value=d?parseFloat(f):parseInt(f)},lexDot:function(a){var b=this.token,c=this.source,d=c[this.cursor];if(d>="0"&&"9">=d){do a=c[this.cursor++];while(a>="0"&&"9">=a);this.cursor--,this.lexExponent(),b.type=NUMBER,b.value=parseFloat(c.substring(b.start,this.cursor))}else b.type=DOT,b.assignOp=null,b.value="."},lexString:function(ch){var token=this.token,input=this.source;token.type=STRING;var hasEscapes=!1,delim=ch;if(input.length<=this.cursor)throw this.newSyntaxError("Unterminated string literal");for(;(ch=input[this.cursor++])!==delim;){if(this.cursor==input.length)throw this.newSyntaxError("Unterminated string literal");if("\\"===ch&&(hasEscapes=!0,++this.cursor==input.length))throw this.newSyntaxError("Unterminated string literal")}token.value=hasEscapes?eval(input.substring(token.start,this.cursor)):input.substring(token.start+1,this.cursor-1)},lexRegExp:function(ch){var token=this.token,input=this.source;token.type=REGEXP;do if(ch=input[this.cursor++],"\\"===ch)this.cursor++;else if("["===ch){do{if(void 0===ch)throw this.newSyntaxError("Unterminated character class");"\\"===ch&&this.cursor++,ch=input[this.cursor++]}while("]"!==ch)}else if(void 0===ch)throw this.newSyntaxError("Unterminated regex");while("/"!==ch);do ch=input[this.cursor++];while(ch>="a"&&"z">=ch);this.cursor--,token.value=eval(input.substring(token.start,this.cursor))},lexOp:function(a){var b=this.token,c=this.source,d=opTokens[a],e=c[this.cursor];e in d&&(d=d[e],this.cursor++,e=c[this.cursor],e in d&&(d=d[e],this.cursor++,e=c[this.cursor]));var f=d.op;definitions.assignOps[f]&&"="===c[this.cursor]?(this.cursor++,b.type=ASSIGN,b.assignOp=definitions.tokenIds[definitions.opTypeNames[f]],f+="="):(b.type=definitions.tokenIds[definitions.opTypeNames[f]],b.assignOp=null),b.value=f},lexIdent:function(a,b){for(var c=this.token,d=a;null!==(a=this.getValidIdentifierChar(!1));)d+=a;if(c.type=IDENTIFIER,c.value=d,!b){var e=definitions.keywords[d];!e||e in this.blackList||(c.type=e)}},get:function(a,b){for(var c;this.lookahead;)if(--this.lookahead,this.tokenIndex=this.tokenIndex+1&3,c=this.tokens[this.tokenIndex],c.type!==NEWLINE||this.scanNewlines)return c.type;this.skip(),this.tokenIndex=this.tokenIndex+1&3,c=this.tokens[this.tokenIndex],c||(this.tokens[this.tokenIndex]=c={});var d=this.source;if(this.cursor>=d.length)return c.type=END;c.start=this.cursor,c.lineno=this.lineno;var e=this.getValidIdentifierChar(!0),f=null===e?d[this.cursor++]:null;if(null!==e)this.lexIdent(e,b);else if(a&&"/"===f)this.lexRegExp(f);else if(f in opTokens)this.lexOp(f);else if("."===f)this.lexDot(f);else if(f>="1"&&"9">=f)this.lexNumber(f);else if("0"===f)this.lexZeroNumber(f);else if('"'===f||"'"===f)this.lexString(f);else{if(!this.scanNewlines||"\n"!==f&&"\r"!==f)throw this.newSyntaxError("Illegal token");"\r"===f&&"\n"===d[this.cursor]&&this.cursor++,c.type=NEWLINE,c.value="\n",this.lineno++}return c.end=this.cursor,c.type},unget:function(){if(4===++this.lookahead)throw"PANIC: too much lookahead!";this.tokenIndex=this.tokenIndex-1&3},newSyntaxError:function(a){a=(this.filename?this.filename+":":"")+this.lineno+": "+a;var b=new SyntaxError(a,this.filename,this.lineno);return b.source=this.source,b.cursor=this.lookahead?this.tokens[this.tokenIndex+this.lookahead&3].start:this.cursor,b},getValidIdentifierChar:function(a){var b=this.source;if(this.cursor>=b.length)return null;var c=b[this.cursor];if("\\"===c&&"u"===b[this.cursor+1]){try{c=String.fromCharCode(parseInt(b.substring(this.cursor+2,this.cursor+6),16))}catch(d){return null}this.cursor+=5}var e=isValidIdentifierChar(c,a);return e&&this.cursor++,e?c:null}},{isIdentifier:isIdentifier,Tokenizer:Tokenizer}}(),Narcissus.parser=function(){function pushDestructuringVarDecls(a,b){for(var c in a){var d=a[c];d.type===IDENTIFIER?b.varDecls.push(d):pushDestructuringVarDecls(d,b)}}function StaticContext(a,b,c,d){this.parentScript=a,this.parentBlock=b||a,this.inModule=c||!1,this.inFunction=d||!1,this.inForLoopInit=!1,this.topLevel=!0,this.allLabels=new Stack,this.currentLabels=new Stack,this.labeledTargets=new Stack,this.defaultLoopTarget=null,this.defaultTarget=null,this.blackList=blackLists[Narcissus.options.version],Narcissus.options.ecma3OnlyMode&&(this.ecma3OnlyMode=!0),Narcissus.options.parenFreeMode&&(this.parenFreeMode=!0)}function Script(a,b,c){var d=new Node(a,scriptInit());return Statements(a,new StaticContext(d,d,b,c),d),d}function Node(a,b){var c=a.token;c?(this.type=c.type,this.value=c.value,this.lineno=c.lineno,this.start=c.start,this.end=c.end):this.lineno=a.lineno,this.tokenizer=a,this.children=[];for(var d in b)this[d]=b[d]}function SyntheticNode(a,b){this.tokenizer=a,this.children=[];for(var c in b)this[c]=b[c];this.synthetic=!0}function unevalableConst(a){var b=definitions.tokens[a],c=definitions.opTypeNames.hasOwnProperty(b)?definitions.opTypeNames[b]:b in definitions.keywords?b.toUpperCase():b;return{toSource:function(){return c}}}function tokenString(a){var b=definitions.tokens[a];return/^\W/.test(b)?definitions.opTypeNames[b]:b.toUpperCase()}function blockInit(){return{type:BLOCK,varDecls:[]}}function scriptInit(){return{type:SCRIPT,funDecls:[],varDecls:[],modDefns:new Dict,modAssns:new Dict,modDecls:new Dict,modLoads:new Dict,impDecls:[],expDecls:[],exports:new Dict,hasEmptyReturn:!1,hasReturnWithValue:!1,hasYield:!1}}function MaybeLeftParen(a,b){return b.parenFreeMode?a.match(LEFT_PAREN)?LEFT_PAREN:END:a.mustMatch(LEFT_PAREN).type}function MaybeRightParen(a,b){b===LEFT_PAREN&&a.mustMatch(RIGHT_PAREN)}function Statements(a,b,c){try{for(;!a.done&&a.peek(!0)!==RIGHT_CURLY;)c.push(Statement(a,b))}catch(d){throw a.done&&(a.unexpectedEOF=!0),d}}function Block(a,b){a.mustMatch(LEFT_CURLY);var c=new Node(a,blockInit());return Statements(a,b.update({parentBlock:c}).pushTarget(c),c),a.mustMatch(RIGHT_CURLY),c}function Export(a,b){this.node=a,this.isDefinition=b,this.resolved=null}function registerExport(a,b){function c(b,c){if(a.has(b))throw new SyntaxError("multiple exports of "+b);a.set(b,c)}switch(b.type){case MODULE:case FUNCTION:c(b.name,new Export(b,!0));break;case VAR:for(var d=0;d<b.children.length;d++)c(b.children[d].name,new Export(b.children[d],!0));break;case LET:case CONST:throw new Error("NYI: "+definitions.tokens[b.type]);case EXPORT:for(var d=0;d<b.pathList.length;d++){var e=b.pathList[d];switch(e.type){case OBJECT_INIT:for(var f=0;f<e.children.length;f++){var g=e.children[f];g.type===IDENTIFIER?c(g.value,new Export(g,!1)):c(g.children[0].value,new Export(g.children[1],!1))}break;case DOT:c(e.children[1].value,new Export(e,!1));break;case IDENTIFIER:c(e.value,new Export(e,!1));break;default:throw new Error("unexpected export path: "+definitions.tokens[e.type])}}break;default:throw new Error("unexpected export decl: "+definitions.tokens[exp.type])}}function Module(a){var b=a.body.exports,c=a.body.modDefns,d=new Dict;b.forEach(function(a,b){var e=b.node;if(e.type===MODULE)d.set(a,e);else if(!b.isDefinition&&e.type===IDENTIFIER&&c.has(e.value)){var f=c.get(e.value);d.set(a,f)}}),this.node=a,this.exports=b,this.exportedModules=d}function Statement(a,b){var c,d,e,f,g,h,i,j,k=a.get(!0),l=a.blockComments;if(b.blackList[k])throw a.newSyntaxError(definitions.tokens[k]+" statements only allowed in Harmony");if(!b.allow(k))throw a.newSyntaxError(definitions.tokens[k]+" statement in illegal context");switch(k){case IMPORT:d=new Node(a),d.pathList=ImportPathList(a,b),b.parentScript.impDecls.push(d);break;case EXPORT:switch(a.peek()){case MODULE:case FUNCTION:case LET:case VAR:case CONST:return d=Statement(a,b),d.blockComments=l,d.exported=!0,b.parentScript.expDecls.push(d),registerExport(b.parentScript.exports,d),d;default:d=new Node(a),d.pathList=ExportPathList(a,b)}b.parentScript.expDecls.push(d),registerExport(b.parentScript.exports,d);break;case MODULE:return d=new Node(a),d.blockComments=l,a.mustMatch(IDENTIFIER),c=a.token.value,a.match(LEFT_CURLY)?(d.name=c,d.body=Script(a,!0,!1),d.module=new Module(d),a.mustMatch(RIGHT_CURLY),b.parentScript.modDefns.set(d.name,d),d):(a.unget(),ModuleVariables(a,b,d),d);case FUNCTION:return FunctionDefinition(a,b,!0,b.topLevel?DECLARED_FORM:STATEMENT_FORM,l);case LEFT_CURLY:return d=new Node(a,blockInit()),Statements(a,b.update({parentBlock:d}).pushTarget(d).nest(),d),a.mustMatch(RIGHT_CURLY),d;case IF:return d=new Node(a),d.condition=HeadExpression(a,b),i=b.pushTarget(d).nest(),d.thenPart=Statement(a,i),d.elsePart=a.match(ELSE,!0)?Statement(a,i):null,d;case SWITCH:for(d=new Node(a,{cases:[],defaultIndex:-1}),d.discriminant=HeadExpression(a,b),i=b.pushTarget(d).nest(),a.mustMatch(LEFT_CURLY);(k=a.get())!==RIGHT_CURLY;){switch(k){case DEFAULT:if(d.defaultIndex>=0)throw a.newSyntaxError("More than one switch default");case CASE:e=new Node(a),k===DEFAULT?d.defaultIndex=d.cases.length:e.caseLabel=Expression(a,i,COLON);break;default:throw a.newSyntaxError("Invalid switch case")}for(a.mustMatch(COLON),e.statements=new Node(a,blockInit());(k=a.peek(!0))!==CASE&&k!==DEFAULT&&k!==RIGHT_CURLY;)e.statements.push(Statement(a,i));d.cases.push(e)}return d;case FOR:if(d=new Node(a,LOOP_INIT),d.blockComments=l,a.match(IDENTIFIER)&&("each"===a.token.value?d.isEach=!0:a.unget()),b.parenFreeMode||a.mustMatch(LEFT_PAREN),i=b.pushTarget(d).nest(),j=b.update({inForLoopInit:!0}),e=null,(k=a.peek(!0))!==SEMICOLON&&(k===VAR||k===CONST?(a.get(),e=Variables(a,j)):k===LET?(a.get(),a.peek()===LEFT_PAREN?e=LetBlock(a,j,!1):(j.parentBlock=d,d.varDecls=[],e=Variables(a,j))):e=Expression(a,j)),e&&a.match(IN))if(d.type=FOR_IN,d.object=Expression(a,j),e.type===VAR||e.type===LET){if(g=e.children,1!==g.length&&1!==e.destructurings.length)throw new SyntaxError("Invalid for..in left-hand side",a.filename,e.lineno);d.iterator=e.destructurings.length>0?e.destructurings[0]:g[0],d.varDecl=e}else(e.type===ARRAY_INIT||e.type===OBJECT_INIT)&&(e.destructuredNames=checkDestructuring(a,j,e)),d.iterator=e;else{if(j.inForLoopInit=!1,d.setup=e,a.mustMatch(SEMICOLON),d.isEach)throw a.newSyntaxError("Invalid for each..in loop");d.condition=a.peek(!0)===SEMICOLON?null:Expression(a,j),a.mustMatch(SEMICOLON),h=a.peek(!0),d.update=(b.parenFreeMode?h===LEFT_CURLY||definitions.isStatementStartCode[h]:h===RIGHT_PAREN)?null:Expression(a,j)}return b.parenFreeMode||a.mustMatch(RIGHT_PAREN),d.body=Statement(a,i),d;case WHILE:return d=new Node(a,{isLoop:!0}),d.blockComments=l,d.condition=HeadExpression(a,b),d.body=Statement(a,b.pushTarget(d).nest()),d;case DO:if(d=new Node(a,{isLoop:!0}),d.blockComments=l,d.body=Statement(a,b.pushTarget(d).nest()),a.mustMatch(WHILE),d.condition=HeadExpression(a,b),!b.ecmaStrictMode)return a.match(SEMICOLON),d;break;case BREAK:case CONTINUE:if(d=new Node(a),d.blockComments=l,i=b.pushTarget(d),a.peekOnSameLine()===IDENTIFIER&&(a.get(),d.label=a.token.value),d.target=d.label?i.labeledTargets.find(function(a){return a.labels.has(d.label)}):k===CONTINUE?i.defaultLoopTarget:i.defaultTarget,!d.target)throw a.newSyntaxError("Invalid "+(k===BREAK?"break":"continue"));if(!d.target.isLoop&&k===CONTINUE)throw a.newSyntaxError("Invalid continue");break;case TRY:for(d=new Node(a,{catchClauses:[]}),d.blockComments=l,d.tryBlock=Block(a,b);a.match(CATCH);){switch(e=new Node(a),f=MaybeLeftParen(a,b),a.get()){case LEFT_BRACKET:case LEFT_CURLY:a.unget(),e.varName=DestructuringExpression(a,b,!0);break;case IDENTIFIER:e.varName=a.token.value;break;default:throw a.newSyntaxError("missing identifier in catch")}if(a.match(IF)){if(b.ecma3OnlyMode)throw a.newSyntaxError("Illegal catch guard");if(d.catchClauses.length&&!d.catchClauses.top().guard)throw a.newSyntaxError("Guarded catch after unguarded");e.guard=Expression(a,b)}MaybeRightParen(a,f),e.block=Block(a,b),d.catchClauses.push(e)}if(a.match(FINALLY)&&(d.finallyBlock=Block(a,b)),!d.catchClauses.length&&!d.finallyBlock)throw a.newSyntaxError("Invalid try statement");return d;case CATCH:case FINALLY:throw a.newSyntaxError(definitions.tokens[k]+" without preceding try");case THROW:d=new Node(a),d.exception=Expression(a,b);break;case RETURN:d=ReturnOrYield(a,b);break;case WITH:return d=new Node(a),d.blockComments=l,d.object=HeadExpression(a,b),d.body=Statement(a,b.pushTarget(d).nest()),d;case VAR:case CONST:d=Variables(a,b);break;case LET:if(a.peek()===LEFT_PAREN)return d=LetBlock(a,b,!0);d=Variables(a,b);break;case DEBUGGER:d=new Node(a);break;case NEWLINE:case SEMICOLON:return d=new Node(a,{type:SEMICOLON}),d.blockComments=l,d.expression=null,d;default:if(k===IDENTIFIER&&(k=a.peek(),k===COLON)){if(c=a.token.value,b.allLabels.has(c))throw a.newSyntaxError("Duplicate label");return a.get(),d=new Node(a,{type:LABEL,label:c}),d.blockComments=l,d.statement=Statement(a,b.pushLabel(c).nest()),d.target=d.statement.type===LABEL?d.statement.target:d.statement,d}d=new Node(a,{type:SEMICOLON}),a.unget(),d.blockComments=l,d.expression=Expression(a,b),d.end=d.expression.end}return d.blockComments=l,MagicalSemicolon(a),d}function MagicalSemicolon(a){var b;if(a.lineno===a.token.lineno&&(b=a.peekOnSameLine(),b!==END&&b!==NEWLINE&&b!==SEMICOLON&&b!==RIGHT_CURLY))throw a.newSyntaxError("missing ; before statement");a.match(SEMICOLON)}function ReturnOrYield(a,b){var c,d,e=a.token.type,f=b.parentScript;if(e===RETURN){if(!b.inFunction)throw a.newSyntaxError("Return not in function")}else{if(!b.inFunction)throw a.newSyntaxError("Yield not in function");f.hasYield=!0}return c=new Node(a,{value:void 0}),d=e===RETURN?a.peekOnSameLine(!0):a.peek(!0),d!==END&&d!==NEWLINE&&d!==SEMICOLON&&d!==RIGHT_CURLY&&(e!==YIELD||d!==e&&d!==RIGHT_BRACKET&&d!==RIGHT_PAREN&&d!==COLON&&d!==COMMA)?e===RETURN?(c.value=Expression(a,b),f.hasReturnWithValue=!0):c.value=AssignExpression(a,b):e===RETURN&&(f.hasEmptyReturn=!0),c}function ModuleExpression(a,b){return a.match(STRING)?new Node(a):QualifiedPath(a,b)}function ImportPathList(a,b){var c=[];do c.push(ImportPath(a,b));while(a.match(COMMA));return c}function ImportPath(a,b){var c=QualifiedPath(a,b);if(!a.match(DOT)){if(c.type===IDENTIFIER)throw a.newSyntaxError("cannot import local variable");return c}var d=new Node(a);return d.push(c),d.push(ImportSpecifierSet(a,b)),d}function ExplicitSpecifierSet(a,b,c){var d,e,f;if(d=new Node(a,{type:OBJECT_INIT}),a.mustMatch(LEFT_CURLY),!a.match(RIGHT_CURLY))do f=Identifier(a,b),a.match(COLON)?(e=new Node(a,{type:PROPERTY_INIT}),e.push(f),e.push(c(a,b)),d.push(e)):d.push(f);while(!a.match(RIGHT_CURLY)&&a.mustMatch(COMMA));return d}function ImportSpecifierSet(a,b){return a.match(MUL)?new Node(a,{type:IDENTIFIER,name:"*"}):ExplicitSpecifierSet(a,b,Identifier)}function Identifier(a){return a.mustMatch(IDENTIFIER),new Node(a,{type:IDENTIFIER})}function IdentifierName(a){return a.mustMatch(IDENTIFIER,!0),new Node(a,{type:IDENTIFIER})}function QualifiedPath(a,b){var c,d;for(c=Identifier(a,b);a.match(DOT);){if(a.peek()!==IDENTIFIER){a.unget();break}d=new Node(a),d.push(c),d.push(Identifier(a,b)),c=d}return c}function ExportPath(a,b){return a.peek()===LEFT_CURLY?ExplicitSpecifierSet(a,b,QualifiedPath):QualifiedPath(a,b)}function ExportPathList(a,b){var c=[];do c.push(ExportPath(a,b));while(a.match(COMMA));return c}function FunctionDefinition(a,b,c,d,e){var f,g=new Node(a,{params:[],paramComments:[]});if("undefined"==typeof comment&&(comment=null),g.blockComments=e,g.type!==FUNCTION&&(g.type="get"===g.value?GETTER:SETTER),a.match(MUL)&&(g.isExplicitGenerator=!0),a.match(IDENTIFIER,!1,!0))g.name=a.token.value;else if(c)throw a.newSyntaxError("missing function identifier");var h=b?b.inModule:!1,i=new StaticContext(null,null,h,!0);if(a.mustMatch(LEFT_PAREN),!a.match(RIGHT_PAREN)){do switch(f=a.get(),g.paramComments.push(a.lastBlockComment()),f){case LEFT_BRACKET:case LEFT_CURLY:a.unget(),g.params.push(DestructuringExpression(a,i));break;case IDENTIFIER:g.params.push(a.token.value);break;default:throw a.newSyntaxError("missing formal parameter")}while(a.match(COMMA));a.mustMatch(RIGHT_PAREN)}if(f=a.get(!0),f!==LEFT_CURLY&&a.unget(),g.body=f!==LEFT_CURLY?AssignExpression(a,i):Script(a,h,!0),f===LEFT_CURLY&&a.mustMatch(RIGHT_CURLY),g.end=a.token.end,g.functionForm=d,d===DECLARED_FORM&&b.parentScript.funDecls.push(g),"harmony"===Narcissus.options.version&&!g.isExplicitGenerator&&g.body.hasYield)throw a.newSyntaxError("yield in non-generator function");return(g.isExplicitGenerator||g.body.hasYield)&&(g.body=new Node(a,{type:GENERATOR,body:g.body})),g}function ModuleVariables(a,b,c){var d,e;do d=Identifier(a,b),a.match(ASSIGN)&&(e=ModuleExpression(a,b),d.initializer=e,e.type===STRING?b.parentScript.modLoads.set(d.value,e.value):b.parentScript.modAssns.set(d.value,d)),c.push(d);while(a.match(COMMA))}function Variables(a,b,c){var d,e,f,g;switch(g=a.token.type){case VAR:case CONST:f=b.parentScript;break;case LET:f=b.parentBlock;break;case LEFT_PAREN:g=LET,f=c}d=new Node(a,{type:g,destructurings:[]});do if(g=a.get(),g!==LEFT_BRACKET&&g!==LEFT_CURLY){if(g!==IDENTIFIER)throw a.newSyntaxError("missing variable name");if(e=new Node(a,{type:IDENTIFIER,name:a.token.value,readOnly:d.type===CONST}),d.push(e),f.varDecls.push(e),a.match(ASSIGN)){var h=a.lastBlockComment();if(a.token.assignOp)throw a.newSyntaxError("Invalid variable initialization");e.initializer=AssignExpression(a,b)}else var h=a.lastBlockComment();e.blockComment=h}else{a.unget();var i=DestructuringExpression(a,b,!0);if(e=new Node(a,{type:IDENTIFIER,name:i,readOnly:d.type===CONST}),d.push(e),pushDestructuringVarDecls(e.name.destructuredNames,f),d.destructurings.push({exp:i,decl:e}),b.inForLoopInit&&a.peek()===IN)continue;if(a.mustMatch(ASSIGN),a.token.assignOp)throw a.newSyntaxError("Invalid variable initialization");e.blockComment=a.lastBlockComment(),e.initializer=AssignExpression(a,b)}while(a.match(COMMA));return d}function LetBlock(a,b,c){var d,e;return d=new Node(a,{type:LET_BLOCK,varDecls:[]}),a.mustMatch(LEFT_PAREN),d.variables=Variables(a,b,d),a.mustMatch(RIGHT_PAREN),c&&a.peek()!==LEFT_CURLY&&(e=new Node(a,{type:SEMICOLON,expression:d}),c=!1),c?d.block=Block(a,b):d.expression=AssignExpression(a,b),d}function checkDestructuring(a,b,c,d){if(c.type===ARRAY_COMP)throw a.newSyntaxError("Invalid array comprehension left-hand side");if(c.type===ARRAY_INIT||c.type===OBJECT_INIT){for(var e,f,g,h,i={},j=c.children,k=0,l=j.length;l>k;k++)if(e=j[k])if(e.type===PROPERTY_INIT?(h=e.children,g=h[1],f=h[0].value):c.type===OBJECT_INIT?(g=e,f=e.value):(g=e,f=k),g.type===ARRAY_INIT||g.type===OBJECT_INIT)i[f]=checkDestructuring(a,b,g,d);else{if(d&&g.type!==IDENTIFIER)throw a.newSyntaxError("missing name in pattern");
i[f]=g}return i}}function DestructuringExpression(a,b,c){var d=PrimaryExpression(a,b);return d.destructuredNames=checkDestructuring(a,b,d,c),d}function GeneratorExpression(a,b,c){return new Node(a,{type:GENERATOR,expression:c,tail:ComprehensionTail(a,b)})}function ComprehensionTail(a,b){var c,d,e,f,g;c=new Node(a,{type:COMP_TAIL});do{switch(d=new Node(a,{type:FOR_IN,isLoop:!0}),a.match(IDENTIFIER)&&("each"===a.token.value?d.isEach=!0:a.unget()),g=MaybeLeftParen(a,b),a.get()){case LEFT_BRACKET:case LEFT_CURLY:a.unget(),d.iterator=DestructuringExpression(a,b);break;case IDENTIFIER:d.iterator=f=new Node(a,{type:IDENTIFIER}),f.name=f.value,d.varDecl=e=new Node(a,{type:VAR}),e.push(f),b.parentScript.varDecls.push(f);break;default:throw a.newSyntaxError("missing identifier")}a.mustMatch(IN),d.object=Expression(a,b),MaybeRightParen(a,g),c.push(d)}while(a.match(FOR));return a.match(IF)&&(c.guard=HeadExpression(a,b)),c}function HeadExpression(a,b){var c=MaybeLeftParen(a,b),d=ParenExpression(a,b);if(MaybeRightParen(a,c),c===END&&!d.parenthesized){var e=a.peek();if(e!==LEFT_CURLY&&!definitions.isStatementStartCode[e])throw a.newSyntaxError("Unparenthesized head followed by unbraced body")}return d}function ParenExpression(a,b){var c=Expression(a,b.update({inForLoopInit:b.inForLoopInit&&a.token.type===LEFT_PAREN}));if(a.match(FOR)){if(c.type===YIELD&&!c.parenthesized)throw a.newSyntaxError("Yield expression must be parenthesized");if(c.type===COMMA&&!c.parenthesized)throw a.newSyntaxError("Generator expression must be parenthesized");c=GeneratorExpression(a,b,c)}return c}function Expression(a,b){var c,d;if(c=AssignExpression(a,b),a.match(COMMA)){d=new Node(a,{type:COMMA}),d.push(c),c=d;do{if(d=c.children[c.children.length-1],d.type===YIELD&&!d.parenthesized)throw a.newSyntaxError("Yield expression must be parenthesized");c.push(AssignExpression(a,b))}while(a.match(COMMA))}return c}function AssignExpression(a,b){var c,d;if(a.match(YIELD,!0))return ReturnOrYield(a,b);if(c=new Node(a,{type:ASSIGN}),d=ConditionalExpression(a,b),!a.match(ASSIGN))return d;switch(c.blockComment=a.lastBlockComment(),d.type){case OBJECT_INIT:case ARRAY_INIT:d.destructuredNames=checkDestructuring(a,b,d);case IDENTIFIER:case DOT:case INDEX:case CALL:break;default:throw a.newSyntaxError("Bad left-hand side of assignment")}return c.assignOp=d.assignOp=a.token.assignOp,c.push(d),c.push(AssignExpression(a,b)),c}function ConditionalExpression(a,b){var c,d;if(c=OrExpression(a,b),a.match(HOOK)){if(d=c,c=new Node(a,{type:HOOK}),c.push(d),c.push(AssignExpression(a,b.update({inForLoopInit:!1}))),!a.match(COLON))throw a.newSyntaxError("missing : after ?");c.push(AssignExpression(a,b))}return c}function OrExpression(a,b){var c,d;for(c=AndExpression(a,b);a.match(OR);)d=new Node(a),d.push(c),d.push(AndExpression(a,b)),c=d;return c}function AndExpression(a,b){var c,d;for(c=BitwiseOrExpression(a,b);a.match(AND);)d=new Node(a),d.push(c),d.push(BitwiseOrExpression(a,b)),c=d;return c}function BitwiseOrExpression(a,b){var c,d;for(c=BitwiseXorExpression(a,b);a.match(BITWISE_OR);)d=new Node(a),d.push(c),d.push(BitwiseXorExpression(a,b)),c=d;return c}function BitwiseXorExpression(a,b){var c,d;for(c=BitwiseAndExpression(a,b);a.match(BITWISE_XOR);)d=new Node(a),d.push(c),d.push(BitwiseAndExpression(a,b)),c=d;return c}function BitwiseAndExpression(a,b){var c,d;for(c=EqualityExpression(a,b);a.match(BITWISE_AND);)d=new Node(a),d.push(c),d.push(EqualityExpression(a,b)),c=d;return c}function EqualityExpression(a,b){var c,d;for(c=RelationalExpression(a,b);a.match(EQ)||a.match(NE)||a.match(STRICT_EQ)||a.match(STRICT_NE);)d=new Node(a),d.push(c),d.push(RelationalExpression(a,b)),c=d;return c}function RelationalExpression(a,b){var c,d,e=b.update({inForLoopInit:!1});for(c=ShiftExpression(a,e);a.match(LT)||a.match(LE)||a.match(GE)||a.match(GT)||!b.inForLoopInit&&a.match(IN)||a.match(INSTANCEOF);)d=new Node(a),d.push(c),d.push(ShiftExpression(a,e)),c=d;return c}function ShiftExpression(a,b){var c,d;for(c=AddExpression(a,b);a.match(LSH)||a.match(RSH)||a.match(URSH);)d=new Node(a),d.push(c),d.push(AddExpression(a,b)),c=d;return c}function AddExpression(a,b){var c,d;for(c=MultiplyExpression(a,b);a.match(PLUS)||a.match(MINUS);)d=new Node(a),d.push(c),d.push(MultiplyExpression(a,b)),c=d;return c}function MultiplyExpression(a,b){var c,d;for(c=UnaryExpression(a,b);a.match(MUL)||a.match(DIV)||a.match(MOD);)d=new Node(a),d.push(c),d.push(UnaryExpression(a,b)),c=d;return c}function UnaryExpression(a,b){var c,d,e;switch(e=a.get(!0)){case DELETE:case VOID:case TYPEOF:case NOT:case BITWISE_NOT:case PLUS:case MINUS:c=e===PLUS?new Node(a,{type:UNARY_PLUS}):e===MINUS?new Node(a,{type:UNARY_MINUS}):new Node(a),c.push(UnaryExpression(a,b));break;case INCREMENT:case DECREMENT:c=new Node(a),c.push(MemberExpression(a,b,!0));break;default:a.unget(),c=MemberExpression(a,b,!0),a.tokens[a.tokenIndex+a.lookahead-1&3].lineno===a.lineno&&(a.match(INCREMENT)||a.match(DECREMENT))&&(d=new Node(a,{postfix:!0}),d.push(c),c=d)}return c}function MemberExpression(a,b,c){var d,e,f;for(a.match(NEW)?(d=new Node(a),d.push(MemberExpression(a,b,!1)),a.match(LEFT_PAREN)&&(d.type=NEW_WITH_ARGS,d.push(ArgumentList(a,b)))):d=PrimaryExpression(a,b);(f=a.get())!==END;){switch(f){case DOT:e=new Node(a),e.push(d),e.push(IdentifierName(a));break;case LEFT_BRACKET:e=new Node(a,{type:INDEX}),e.push(d),e.push(Expression(a,b)),a.mustMatch(RIGHT_BRACKET);break;case LEFT_PAREN:if(c){e=new Node(a,{type:CALL}),e.push(d),e.push(ArgumentList(a,b));break}default:return a.unget(),d}d=e}return d}function ArgumentList(a,b){var c,d;if(c=new Node(a,{type:LIST}),a.match(RIGHT_PAREN,!0))return c;do{if(d=AssignExpression(a,b),d.type===YIELD&&!d.parenthesized&&a.peek()===COMMA)throw a.newSyntaxError("Yield expression must be parenthesized");if(a.match(FOR)&&(d=GeneratorExpression(a,b,d),c.children.length>1||a.peek(!0)===COMMA))throw a.newSyntaxError("Generator expression must be parenthesized");c.push(d)}while(a.match(COMMA));return a.mustMatch(RIGHT_PAREN),c}function PrimaryExpression(a,b){var c,d,e=a.get(!0);switch(e){case FUNCTION:c=FunctionDefinition(a,b,!1,EXPRESSED_FORM);break;case LEFT_BRACKET:for(c=new Node(a,{type:ARRAY_INIT});(e=a.peek(!0))!==RIGHT_BRACKET;)if(e!==COMMA){if(c.push(AssignExpression(a,b)),e!==COMMA&&!a.match(COMMA))break}else a.get(),c.push(null);1===c.children.length&&a.match(FOR)&&(d=new Node(a,{type:ARRAY_COMP,expression:c.children[0],tail:ComprehensionTail(a,b)}),c=d),a.mustMatch(RIGHT_BRACKET);break;case LEFT_CURLY:var f;c=new Node(a,{type:OBJECT_INIT});a:if(!a.match(RIGHT_CURLY)){do if(e=a.get(),"get"!==a.token.value&&"set"!==a.token.value||a.peek()!==IDENTIFIER){var g=a.blockComments;switch(e){case IDENTIFIER:case NUMBER:case STRING:f=new Node(a,{type:IDENTIFIER});break;case RIGHT_CURLY:if(b.ecma3OnlyMode)throw a.newSyntaxError("Illegal trailing ,");break a;default:if(a.token.value in definitions.keywords){f=new Node(a,{type:IDENTIFIER});break}throw a.newSyntaxError("Invalid property name")}if(a.match(COLON))d=new Node(a,{type:PROPERTY_INIT}),d.push(f),d.push(AssignExpression(a,b)),d.blockComments=g,c.push(d);else{if(a.peek()!==COMMA&&a.peek()!==RIGHT_CURLY)throw a.newSyntaxError("missing : after property");c.push(f)}}else{if(b.ecma3OnlyMode)throw a.newSyntaxError("Illegal property accessor");c.push(FunctionDefinition(a,b,!0,EXPRESSED_FORM))}while(a.match(COMMA));a.mustMatch(RIGHT_CURLY)}break;case LEFT_PAREN:c=ParenExpression(a,b),a.mustMatch(RIGHT_PAREN),c.parenthesized=!0;break;case LET:c=LetBlock(a,b,!1);break;case NULL:case THIS:case TRUE:case FALSE:case IDENTIFIER:case NUMBER:case STRING:case REGEXP:c=new Node(a);break;default:throw a.newSyntaxError("missing operand; found "+definitions.tokens[e])}return c}function parse(a,b,c){var d=new lexer.Tokenizer(a,b,c),e=Script(d,!1,!1);if(!d.done)throw d.newSyntaxError("Syntax error");return e}function parseStdin(a,b,c,d){if(a.match(/^[\s]*\.begin[\s]*$/))return++b.value,parseMultiline(b,c);for(d(a.trim())&&(a="");;)try{var e=new lexer.Tokenizer(a,"stdin",b.value),f=Script(e,!1,!1);return b.value=e.lineno,f}catch(g){if(!e.unexpectedEOF)throw g;var h;do if(c&&putstr(c),h=readline(),!h)throw g;while(d(h.trim()));a+="\n"+h}}function parseMultiline(a,b){for(var c="";;){b&&putstr(b);var d=readline();if(null===d)return null;if(d.match(/^[\s]*\.end[\s]*$/))break;c+="\n"+d}var e=new lexer.Tokenizer(c,"stdin",a.value),f=Script(e,!1,!1);return a.value=e.lineno,f}var lexer=Narcissus.lexer,definitions=Narcissus.definitions;const Dict=definitions.Dict,Stack=definitions.Stack;eval(definitions.consts);const blackLists={160:{},185:{},harmony:{}};blackLists[160][IMPORT]=!0,blackLists[160][EXPORT]=!0,blackLists[160][LET]=!0,blackLists[160][MODULE]=!0,blackLists[160][YIELD]=!0,blackLists[185][IMPORT]=!0,blackLists[185][EXPORT]=!0,blackLists[185][MODULE]=!0,blackLists.harmony[WITH]=!0,StaticContext.prototype={ecma3OnlyMode:!1,parenFreeMode:!1,update:function(a){var b={};for(var c in a)b[c]={value:a[c],writable:!0,enumerable:!0,configurable:!0};return Object.create(this,b)},pushLabel:function(a){return this.update({currentLabels:this.currentLabels.push(a),allLabels:this.allLabels.push(a)})},pushTarget:function(a){var b=a.isLoop,c=b||a.type===SWITCH;return this.currentLabels.isEmpty()?(b&&this.update({defaultLoopTarget:a}),c&&this.update({defaultTarget:a}),this):(a.labels=new Dict,this.currentLabels.forEach(function(b){a.labels.set(b,!0)}),this.update({currentLabels:new Stack,labeledTargets:this.labeledTargets.push(a),defaultLoopTarget:b?a:this.defaultLoopTarget,defaultTarget:c?a:this.defaultTarget}))},nest:function(){return this.topLevel?this.update({topLevel:!1}):this},allow:function(a){switch(a){case EXPORT:if(!this.inModule||this.inFunction||!this.topLevel)return!1;case IMPORT:return!this.inFunction&&this.topLevel;case MODULE:return!this.inFunction&&this.topLevel;default:return!0}}};var Np=Node.prototype=SyntheticNode.prototype={};Np.constructor=Node;const TO_SOURCE_SKIP={type:!0,value:!0,lineno:!0,start:!0,end:!0,tokenizer:!0,assignOp:!0};Np.toSource=function(){var a={};if(a.type=unevalableConst(this.type),this.generatingSource)return a.toSource();this.generatingSource=!0,"value"in this&&(a.value=this.value),"lineno"in this&&(a.lineno=this.lineno),"start"in this&&(a.start=this.start),"end"in this&&(a.end=this.end),this.assignOp&&(a.assignOp=unevalableConst(this.assignOp));for(var b in this)!this.hasOwnProperty(b)||b in TO_SOURCE_SKIP||(a[b]=this[b]);try{return a.toSource()}finally{delete this.generatingSource}},Np.push=function(a){return null!==a&&(a.start<this.start&&(this.start=a.start),this.end<a.end&&(this.end=a.end)),this.children.push(a)},Node.indentLevel=0,Np.toString=function(){var a=[];for(var b in this)this.hasOwnProperty(b)&&"type"!==b&&"target"!==b&&a.push({id:b,value:this[b]});a.sort(function(a,b){return a.id<b.id?-1:1});const c="    ";var d=++Node.indentLevel,e="{\n"+c.repeat(d)+"type: "+tokenString(this.type);for(b=0;b<a.length;b++)e+=",\n"+c.repeat(d)+a[b].id+": "+a[b].value;return d=--Node.indentLevel,e+="\n"+c.repeat(d)+"}"},Np.getSource=function(){return this.tokenizer.source.slice(this.start,this.end)},Np.synth=function(a){var b=new SyntheticNode(this.tokenizer,a);return b.filename=this.filename,b.lineno=this.lineno,b.start=this.start,b.end=this.end,b};const LOOP_INIT={isLoop:!0};definitions.defineGetter(Np,"filename",function(){return this.tokenizer.filename}),definitions.defineGetter(Np,"length",function(){throw new Error("Node.prototype.length is gone; use n.children.length instead")}),definitions.defineProperty(String.prototype,"repeat",function(a){for(var b="",c=this+b;--a>=0;)b+=c;return b},!1,!1,!0);const DECLARED_FORM=0,EXPRESSED_FORM=1,STATEMENT_FORM=2;return{parse:parse,parseStdin:parseStdin,Node:Node,DECLARED_FORM:DECLARED_FORM,EXPRESSED_FORM:EXPRESSED_FORM,STATEMENT_FORM:STATEMENT_FORM,Tokenizer:lexer.Tokenizer,FunctionDefinition:FunctionDefinition,Module:Module,Export:Export}}(),Narcissus.decompiler=function(){function indent(a,b){for(var c="",d=!0,e=0,f=b.length;f>e;e++){if(d)for(var g=0;a>g;g++)c+=" ";c+=b[e],d="\n"===b[e]}return c}function isBlock(a){return a&&a.type===BLOCK}function isNonEmptyBlock(a){return isBlock(a)&&a.children.length>0}function nodeStrEscape(a){return a.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/</g,"\\u003C").replace(/>/g,"\\u003E")}function nodeStr(a){if(/[\u0000-\u001F\u0080-\uFFFF]/.test(a.value)){for(var b="",c=0;c<a.value.length;c++){var d=a.value[c];if("">=d||d>=""){for(var e=d.charCodeAt(0).toString(16);e.length<4;)e="0"+e;b+="\\u"+e}else b+=nodeStrEscape(d)}return'"'+b+'"'}return'"'+nodeStrEscape(a.value)+'"'}function pp(a,b,c){var d=!1;if(!a)return"";if(!(a instanceof Object))return a;b||(d=!0,b=1);var e="";switch(a.parenthesized&&(e+="("),a.type){case FUNCTION:case GETTER:case SETTER:e+=a.type===FUNCTION?"function":a.type===GETTER?"get":"set",e+=(a.name?" "+a.name:"")+"(";for(var f=0,g=a.params.length;g>f;f++)e+=(f>0?", ":"")+pp(a.params[f],b);e+=") "+pp(a.body,b);break;case SCRIPT:case BLOCK:var h=a.children;if(d){for(var f=0,g=h.length;g>f;f++){f>0&&(e+="\n"),e+=pp(h[f],b);var i=e[e.length-1];";"!=i&&(e+=";")}break}e+="{",void 0!==a.id&&(e+=" /* "+a.id+" */"),e+="\n";for(var f=0,g=h.length;g>f;f++){f>0&&(e+="\n"),e+=indent(4,pp(h[f],b));var i=e[e.length-1];";"!=i&&(e+=";")}e+="\n}";break;case LET_BLOCK:e+="let ("+pp(a.variables,b,!0)+") ",e+=a.expression?pp(a.expression,b):pp(a.block,b);break;case IF:e+="if ("+pp(a.condition,b)+") ";var j=a.thenPart,k=a.elsePart,l=isBlock(j)||isBlock(k);l||(e+="{\n"),e+=(l?pp(j,b):indent(4,pp(j,b)))+"\n",k&&(e+=l?" else ":"} else {\n",e+=(l?pp(k,b):indent(4,pp(k,b)))+"\n"),l||(e+="}");break;case SWITCH:e+="switch ("+pp(a.discriminant,b)+") {\n";for(var f=0,g=a.cases.length;g>f;f++){var m=a.cases[f];e+=m.type===CASE?"  case "+pp(m.caseLabel,b)+":\n":"  default:\n",ps=pp(m.statements,b),e+=ps.slice(2,ps.length-2)+"\n"}e+="}";break;case FOR:e+="for ("+pp(a.setup,b)+"; "+pp(a.condition,b)+"; "+pp(a.update,b)+") ";var n=pp(a.body,b);isBlock(a.body)?a.body&&(e+=n):e+="{\n"+indent(4,n)+";\n}";break;case WHILE:e+="while ("+pp(a.condition,b)+") ";var n=pp(a.body,b);e+=isBlock(a.body)?n:"{\n"+indent(4,n)+";\n}";break;case FOR_IN:var o=a.varDecl;e+=a.isEach?"for each (":"for (",e+=(o?pp(o,b):pp(a.iterator,b))+" in "+pp(a.object,b)+") ";var n=pp(a.body,b);isBlock(a.body)?a.body&&(e+=n):e+="{\n"+indent(4,n)+";\n}";break;case DO:e+="do "+pp(a.body,b),e+=" while ("+pp(a.condition,b)+");";break;case BREAK:e+="break"+(a.label?" "+a.label:"")+";";break;case CONTINUE:e+="continue"+(a.label?" "+a.label:"")+";";break;case TRY:e+="try ",e+=pp(a.tryBlock,b);for(var f=0,g=a.catchClauses.length;g>f;f++){var p=a.catchClauses[f];e+=" catch ("+pp(p.varName,b)+(p.guard?" if "+pp(p.guard,b):"")+") ",e+=pp(p.block,b)}a.finallyBlock&&(e+=" finally ",e+=pp(a.finallyBlock,b));break;case THROW:e+="throw "+pp(a.exception,b);break;case RETURN:e+="return",a.value&&(e+=" "+pp(a.value,b));break;case YIELD:e+="yield",a.value&&(e+=" "+pp(a.value,b));break;case GENERATOR:e+=pp(a.expression,b)+" "+pp(a.tail,b);break;case WITH:e+="with ("+pp(a.object,b)+") ",e+=pp(a.body,b);break;case LET:case VAR:case CONST:var h=a.children;c||(e+=tokens[a.type]+" ");for(var f=0,g=h.length;g>f;f++){f>0&&(e+=", ");var o=h[f];e+=pp(o.name,b),o.initializer&&(e+=" = "+pp(o.initializer,b))}break;case DEBUGGER:e+="debugger NYI\n";break;case SEMICOLON:a.expression&&(e+=pp(a.expression,b)+";");break;case LABEL:e+=a.label+":\n"+pp(a.statement,b);break;case COMMA:case LIST:for(var h=a.children,f=0,g=h.length;g>f;f++)f>0&&(e+=", "),e+=pp(h[f],b);break;case ASSIGN:var h=a.children,p=a.assignOp;e+=pp(h[0],b)+" "+(p?tokens[p]:"")+"= "+pp(h[1],b);break;case HOOK:var h=a.children;e+="("+pp(h[0],b)+" ? "+pp(h[1],b)+" : "+pp(h[2],b),e+=")";break;case OR:case AND:var h=a.children;e+="("+pp(h[0],b)+" "+tokens[a.type]+" "+pp(h[1],b),e+=")";break;case BITWISE_OR:case BITWISE_XOR:case BITWISE_AND:case EQ:case NE:case STRICT_EQ:case STRICT_NE:case LT:case LE:case GE:case GT:case IN:case INSTANCEOF:case LSH:case RSH:case URSH:case PLUS:case MINUS:case MUL:case DIV:case MOD:var h=a.children;e+="("+pp(h[0],b)+" "+tokens[a.type]+" "+pp(h[1],b)+")";break;case DELETE:case VOID:case TYPEOF:e+=tokens[a.type]+" "+pp(a.children[0],b);break;case NOT:case BITWISE_NOT:e+=tokens[a.type]+pp(a.children[0],b);break;case UNARY_PLUS:e+="+"+pp(a.children[0],b);break;case UNARY_MINUS:e+="-"+pp(a.children[0],b);break;case INCREMENT:case DECREMENT:e+=a.postfix?pp(a.children[0],b)+tokens[a.type]:tokens[a.type]+pp(a.children[0],b);break;case DOT:var h=a.children;e+=pp(h[0],b)+"."+pp(h[1],b);break;case INDEX:var h=a.children;e+=pp(h[0],b)+"["+pp(h[1],b)+"]";break;case CALL:var h=a.children;e+=pp(h[0],b)+"("+pp(h[1],b)+")";break;case NEW:case NEW_WITH_ARGS:var h=a.children;e+="new "+pp(h[0],b),h[1]&&(e+="("+pp(h[1],b)+")");break;case ARRAY_INIT:e+="[";for(var h=a.children,f=0,g=h.length;g>f;f++)h[f]&&(e+=pp(h[f],b)),e+=",";e+="]";break;case ARRAY_COMP:e+="["+pp(a.expression,b)+" ",e+=pp(a.tail,b),e+="]";break;case COMP_TAIL:for(var h=a.children,f=0,g=h.length;g>f;f++)f>0&&(e+=" "),e+=pp(h[f],b);a.guard&&(e+=" if ("+pp(a.guard,b)+")");break;case OBJECT_INIT:var h=a.children;e+=h[0]&&h[0].type===PROPERTY_INIT?"{\n":"{";for(var f=0,g=h.length;g>f;f++){f>0&&(e+=",\n");var p=h[f];if(p.type===PROPERTY_INIT){var q,r=p.children,s=r[0].value;q="string"!=typeof s||lexer.isIdentifier(s)?pp(r[0],b):nodeStr(r[0]),e+=indent(4,q)+": "+indent(4,pp(r[1],b)).substring(4)}else e+=indent(4,pp(p,b))}e+="\n}";break;case NULL:e+="null";break;case THIS:e+="this";break;case TRUE:e+="true";break;case FALSE:e+="false";break;case IDENTIFIER:case NUMBER:case REGEXP:e+=a.value;break;case STRING:e+=nodeStr(a);break;case GROUP:e+="("+pp(a.children[0],b)+")";break;default:throw"PANIC: unknown operation "+tokens[a.type]+" "+a.toSource()}return a.parenthesized&&(e+=")"),e}const lexer=Narcissus.lexer,parser=Narcissus.parser,definitions=Narcissus.definitions,tokens=definitions.tokens;return eval(definitions.consts),{pp:pp}}(),void 0===RiverTrail)var RiverTrail={};if(RiverTrail.definitions=function(){var a=["CAST","TOINT32","FLATTEN"];const b=Narcissus.definitions.tokens.length;for(var c="const ",d=0;d<a.length;d++)c+=a[d]+"="+(b+d),d<a.length-1&&(c+=",");return c+=";",a=Narcissus.definitions.tokens.concat(a),{consts:c,tokens:a}}(),void 0===RiverTrail)var RiverTrail={};if(RiverTrail.Helper=function(){function traverseAst(a,b,c){if(a){a=b(a,c);for(var d in nodeNames)a[nodeNames[d]]&&(a[nodeNames[d]]=a[nodeNames[d]]instanceof Array?a[nodeNames[d]].map(function(a){return traverseAst(a,b,c)}):traverseAst(a[nodeNames[d]],b,c))}return a}function wrappedPP(a){var b;try{b=Narcissus.decompiler.pp(a)}catch(c){b="<no source>"}return b}function isCData(a){return void 0!==a&&"CData"===a.name}function isWebCLBufferObject(a){return void 0!==a&&"WebCLBuffer"===a._name}function constructorToElementalType(a){var b;for(b=0;b<arrayTypeToCType.length;b++)if(a===arrayTypeToCType[b][0])return arrayTypeToCType[b][1];return void 0}function elementalTypeToConstructor(a){var b;for(b=0;b<arrayTypeToCType.length;b++)if(a===arrayTypeToCType[b][1])return arrayTypeToCType[b][0];return void 0}function inferTypedArrayType(a){var b,c;for(b=0;b<arrayTypeToCType.length;b++)if(a instanceof arrayTypeToCType[b][0]){c=arrayTypeToCType[b][1];break}if(void 0===c)throw new TypeError("Cannot infer type for given Parallel Array data container.");return c}function inferPAType(a){var b=a.getShape();return void 0===a.elementalType&&(void 0===a.data||isWebCLBufferObject(a.data)?isTypedArray(a.hostAllocatedObject)&&(a.elementalType=inferTypedArrayType(a.hostAllocatedObject)):a.elementalType=inferTypedArrayType(a.data)),{dimSize:b,inferredType:a.elementalType}}function stripToBaseType(a){const b=/([a-zA-Z ]|\/\*|\*\/)*/;var c=a.match(b);return c[0]}function getOpenCLSize(a){var b=stripToBaseType(a);if(b!==a)return 8;switch(b){case"signed char":case"unsigned char":case"unsigned /* clamped */ char":return 1;case"short":case"unsigned short":return 2;case"float":case"int":case"unsigned int":return 4;case"double":return 8;default:reportBug("size of type not known: "+a)}}function reportError(a,b){throw"Error: "+a+" [source code was `"+(b?wrappedPP(b):"no context")+"`]"}function reportBug(a){throw"Bug: "+a}function findSelectionRoot(a){switch(a.type){case INDEX:return findSelectionRoot(a.children[0]);case IDENTIFIER:return a;default:throw"malformed lhs sel expression in assignment"}}function isArrayLiteral(a){return a.type===ARRAY_INIT&&(1==a.typeInfo.getOpenCLShape().length||a.children.every(function(a){return a.type===IDENTIFIER||isArrayLiteral(a)}))}function allocateAlignedTA(a,b){if(!RiverTrail.compiler)return new a(b);var c=RiverTrail.compiler.openCLContext.alignmentSize;if(!c)return void 0;var d=new ArrayBuffer(b*a.BYTES_PER_ELEMENT+c),e=RiverTrail.compiler.openCLContext.getAlignmentOffset(d);return new a(d,e,b)}eval(Narcissus.definitions.consts);var nodeNames=["children","body","setup","condition","update","thenPart","elsePart","expression","initializer"],arrayTypeToCType=[[Int8Array,"signed char"],[Uint8Array,"unsigned char"],[Uint8ClampedArray,"unsigned /* clamped */ char"],[Int16Array,"short"],[Uint16Array,"unsigned short"],[Int32Array,"int"],[Uint32Array,"unsigned int"],[Float32Array,"float"],[Float64Array,"double"]],Integer=function(a){return this.value=a,this},FlatArray=function(a,b){for(var c=this.shape=new Array,d=b,e=1,f=0;d instanceof Array;)c.push(d.length),e*=d.length,d=d[0];this.data=new a(e);if(1===c.length){for(var g=0;g<c[0];g++){if("number"!=typeof b[g])throw"Error: Conversion to flat array failed: not a number!";this.data[f++]=b[g]}return this}d=b;var h=new Array;for(h.push(d),f=0;0!==h.length;){var i=h.pop();if(!(i instanceof Array))throw"Error: Non array node pushed!! Flattening kernel argument failed.";if(i[0]instanceof Array)for(var e=i[0].length,j=i.length-1;j>=0;j--){if(!(i[j]instanceof Array)||i[j].length!==e)throw"Error: Invalid array shape !! Flattening kernel argument failed";h.push(i[j])}else{if(i.length!==c[c.length-1])throw"Error: Leaf length and shape are different! Flattening kernel argument failed";for(var k=0;k<i.length;k++){if("number"!=typeof i[k])throw"Error: Conversion to flat array failed: not a number!";this.data[f++]=i[k]}}}return this},FlatArray_fast=function(a,b){for(var c=this.shape=new Array,d=b,e=1;d instanceof Array;)c.push(d.length),e*=d.length,d=d[0];var f=(this.data=new a(e),new Array),g=new Array,h=0,i=0,j=0;for(d=b;e>i;){if(d[j]instanceof Array){if(d[j].length!=c[h+1])throw"inhomogeneous array encountered";f[h]=d,g[h]=j+1,d=d[j],j=0,h++}else{if(h!=c.length-1)throw"inhomogeneous array encountered";for(;j<d.length;j++,i++)if(this.data[i]=d[j],this.data[i]!==d[j])throw new"conversion error"}j===d.length&&(h--,j=g[h],d=f[h])}return this},compareObjectFields=function(a,b){return b.hasOwnProperty(idx)&&a[idx].equals(b[idx])?!0:!1},debugThrow=function(a){throw RiverTrail.compiler.verboseDebug&&console.log("Exception: "+JSON.stringify(a)),a},isTypedArray;isTypedArray="function"==typeof Float32Array&&"object"==typeof Float32Array.prototype?function(a){return a instanceof Float32Array||a instanceof Float64Array||a instanceof Int8Array||a instanceof Int16Array||a instanceof Int32Array||a instanceof Uint8Array||a instanceof Uint16Array||a instanceof Uint32Array||"function"==typeof Uint8ClampedArray&&a instanceof Uint8ClampedArray}:function(){return!1};var nameGen=function(){var a=0;return function(b){return"f"+a++ +"_"+(b||"nameless")}}(),parseFunction=function(a){var b=Narcissus.parser,c=a.toString(),d=new b.Tokenizer(c);d.get(!0);var e=b.FunctionDefinition(d,void 0,!1,b.EXPRESSED_FORM);return e.name||(e.name="nameless"),e},cloneAST=function(a){var b=wrappedPP(a);return parseFunction(b)},cloneFunction=function(a){var b=void 0,c=void 0,d=function(){var a=0;return function(){return a++}}(),e=0,f=function(a){return a.map(j)},g=a?function(){return void 0}:function(a){var c=b[a.label];if(!c){if(a instanceof RiverTrail.Typeinference.FFunction)c=new RiverTrail.Typeinference.FFunction(f(a.params),h(a.result),a.root,void 0);else if(a instanceof RiverTrail.Typeinference.FCall)c=new RiverTrail.Typeinference.FCall(f(a.params),a.frame,h(a.result),void 0),c.frame.uses++;else{if(!(a instanceof RiverTrail.Typeinference.FParam))throw"unknown flow";c=new RiverTrail.Typeinference.FParam(a.number,g(a.call))}b[a.label]=c}return c},h=a?function(){return void 0}:function(a){var c=b[a.label];return c||(c=a.clone(b),a.flowTo&&(c.flowTo=a.flowTo.map(j))),c},i=function(a){if(a.type===IDENTIFIER&&a.cloneLabel&&a.cloneLabel>e)return c[a.cloneLabel-e];var b=new Narcissus.parser.Node(a.tokenizer);for(var f in a)switch(f){case"length":case"specStore":case"adrSpecStore":case"redispatched":break;case"funDecls":b[f]=[];break;default:b[f]=j(a[f])}return b.type===FUNCTION&&b.flowFrame&&(b.flowFrame.ast=b),b.type===CALL&&b.callFrame&&(b.callFrame.ast=b),a.type===IDENTIFIER&&(a.cloneLabel=d(),c[a.cloneLabel-e]=b),b},j=function(a){return a instanceof Array?f(a):a instanceof Narcissus.parser.Node?i(a):a instanceof RiverTrail.Typeinference.Type?h(a):a instanceof RiverTrail.Typeinference.FlowNode?g(a):a};return function(a){b=[],c=[],e=d();var f=i(a);return f.dispatch=nameGen(f.name||(f.name="nameless")),f}};return{traverseAst:traverseAst,wrappedPP:wrappedPP,inferPAType:inferPAType,elementalTypeToConstructor:elementalTypeToConstructor,stripToBaseType:stripToBaseType,getOpenCLSize:getOpenCLSize,Integer:Integer,FlatArray:FlatArray,debugThrow:debugThrow,isTypedArray:isTypedArray,isCData:isCData,isWebCLBufferObject:isWebCLBufferObject,inferTypedArrayType:inferTypedArrayType,cloneFunction:cloneFunction,nameGen:nameGen,parseFunction:parseFunction,reportError:reportError,reportBug:reportBug,findSelectionRoot:findSelectionRoot,isArrayLiteral:isArrayLiteral,compareObjectFields:compareObjectFields,allocateAlignedTA:allocateAlignedTA}}(),void 0===RiverTrail)var RiverTrail={};RiverTrail.SupportedInterfaces={},RiverTrail.SupportedInterfaces.RiverTrailAdapter=function(){var a=function(a,b,c){return setArgument(a.id,b,c.id)},b=function(a,b,c,d,e){return setScalarArgument(a.id,b,c,d,e)},c=function(a,b,c){return run(a.id,b,c)},d=function(a,b,c){return getValue(a.id,b,c)};return{name:"RiverTrailExtension",initContext:window.initContext,is64BitFloatingPointEnabled:window.is64BitFloatingPointEnabled,compileKernel:window.compileKernel,mapData:window.mapData,getBuildLog:window.getBuildLog,setArgument:a,setScalarArgument:b,run:c,getValue:d}},RiverTrail.SupportedInterfaces.WebCLAdapter=function(){var a,b,c,d,e,f=function(){var f=webcl.getPlatforms(),g=null;for(var h in f)0===f[h].getInfo(WebCL.PLATFORM_NAME).indexOf("Intel(R)")&&(g=f[h]);if(null===g)throw"[WebCL Runtime] : No supported OpenCL platforms found!";a=webcl.createContext(g),b=a.getInfo(WebCL.CONTEXT_DEVICES)[0],c=a.createCommandQueue(b),d=new Int32Array(1),d[0]=0,e=null},g=function(){return!1},h=function(f,g){var h=a.createProgram(f);try{h.build([b],"")}catch(j){throw alert("Failed to build WebCL program. Error "+h.getBuildInfo(b,WebCL.PROGRAM_BUILD_STATUS)+":  "+h.getBuildInfo(b,WebCL.PROGRAM_BUILD_LOG)),j}var k;try{k=h.createKernel(g)}catch(j){throw alert("Failed to create kernel: "+j.message),j}try{e=i(d,!0),c.enqueueWriteBuffer(e,!1,0,4,d)}catch(j){throw alert("Failed to create buffer for failureMem: "+j.message),j}return k},i=function(b,c){var d,e=void 0!==c?WebCL.MEM_WRITE_ONLY:WebCL.MEM_READ_WRITE;try{d=a.createBuffer(e,b.byteLength,b)}catch(f){throw alert("Could not create buffer: "+f.message),f}return d},j=1,k=function(a,b,c){var d;try{d=a.setArg(b+j,c)}catch(e){throw alert("SetArgument failed: "+e.message+" at index "+(b+j).toString()),e}return d},l=function(a,b,c,d,e){var f;f=d?Uint32Array:e?Float64Array:Float32Array;var g;try{g=a.setArg(b+j,new f([c]))}catch(h){throw alert("SetScalarArgument failed: "+h.message+" at index "+(b+j).toString()),h}return g},m=function(a,b,d){try{a.setArg(0,e)}catch(f){throw alert("SetArgument for failureMem failed: "+f.message),f}try{c.enqueueNDRangeKernel(a,b,null,d,null)}catch(f){throw alert("kernel run failed: "+f.message),f}},n=function(a,b){c.enqueueReadBuffer(a,!1,0,b.byteLength,b),c.finish()},o=function(){return"BuildLog (WebCL adapter) not implemented yet"};return{name:"WebCL",initContext:f,is64BitFloatingPointEnabled:g,compileKernel:h,mapData:i,setArgument:k,setScalarArgument:l,run:m,getValue:n,getBuildLog:o}},RiverTrail.runtime=function(){if(void 0!==window.riverTrailExtensionIsInstalled)return RiverTrail.SupportedInterfaces.RiverTrailAdapter();if(void 0!==window.webcl)return RiverTrail.SupportedInterfaces.WebCLAdapter();throw"No OpenCL adapters found"}();var ParallelArray=function(){function a(){var d,e=this;for(d=0;d<k.length;d++)i===k[d]&&console.log("(fingerprint === fingerprintTracker)");if(0==arguments.length)e=A.call(this);else if(1==arguments.length)e=C.call(this,arguments[0]);else if(2==arguments.length&&"function"==typeof arguments[0])e=C.call(this,arguments[1],arguments[0]);else if(3==arguments.length&&"reshape"==arguments[0])e=this,e.shape=arguments[2],e.strides=v(arguments[2]),e.offset=arguments[1].offset,e.elementalType=arguments[1].elementalType,e.data=arguments[1].data,e.flat=arguments[1].flat;else if((RiverTrail.Helper.isCData(arguments[0])||RiverTrail.Helper.isWebCLBufferObject(arguments[0]))&&t(arguments[1]))e=B.call(this,arguments[0],arguments[1],arguments[2]);else if("function"==typeof arguments[1]||arguments[1]instanceof low_precision.wrapper){var f;if(arguments.length>2)for(f=new Array(arguments.length-2),d=2;d<arguments.length;d++)f[d-2]=arguments[d];else f=new Array(0);e=D.call(this,arguments[0],arguments[1],f)}else{var h=Array.prototype.slice.call(arguments);e=C.call(this,h)}for(d=0;d<k.length;d++)i===k[d]&&console.log("(fingerprint === fingerprintTracker)");if(e.uniqueFingerprint=i++,e.flat&&e.shape&&e.shape.length<4&&(e=new kb[e.shape.length](e)),b)try{e=Proxy.create(z(e),a.prototype)}catch(j){}return c&&RiverTrail.Helper.isCData(e.data)&&(g?(o(e,"get"),o(e,"concat"),o(e,"join"),o(e,"slice"),o(e,"toString"),o(e,"getArray")):e.materialize()),e}var b=!1,c=!1;try{void 0!==RiverTrail.runtime&&(c=!0)}catch(d){console.log("It looks like the extension isn't installed.")}var e=!1;try{void 0!==RiverTrail.runtime.is64BitFloatingPointEnabled&&(e=RiverTrail.runtime.is64BitFloatingPointEnabled())}catch(d){console.log("It looks like 64-bit floating point isn't supported.")}console.log("enable64BitFloatingPoint: "+e);var f=c?e?Float64Array:Float32Array:Array,g=!1,h=!1;h&&!g&&(console.log("RiverTrail: useUpdateInPlaceScan requires useLazyCommuniation. Disabling..."),h=!1);var i=0,k=[],l={zeroStrideConstant:[],oneStrideConstant:[1],emptyRawArrayConstant:new f,zeroArrayShapeConstant:[0]},m=(Error,Error),n=Error,o=function(a,b){a[b]=function(){if(a.materialize(),!delete a[b])throw new m("Deletion of overloaded "+b+" failed");return a[b].apply(a,arguments)}},p=function(){},q=2e-7,r=function(a,b,c){var d=a-b;0>d&&(d=-d);var e=a>0?a:-a,f=b>0?b:-b,g=(e>f?f:e)*c;return g>=d?!0:!1},s=function(a,b){var c=b?b:f;if(a.constructor===c)return a;var d=new c(a);return void 0===b?a.every(function(a,b){return r(a,d[b],q)})?d:void 0:d},t=function(a){return(t=RiverTrail.Helper.isTypedArray)(a)},u=function(a,b){return a.length==b.length&&Array.prototype.every.call(a,function(a,c){return a==b[c]})},v=function(a){var b,c;if(1==a.length)return l.oneStrideConstant;if(0==a.length)return l.zeroStrideConstant;for(b=new Array(a.length),b[b.length-1]=1,c=b.length-2;c>=0;c--)b[c]=a[c+1]*b[c+1];return b},w=function(a){var b,c;if(0==a.length)return 0;for(c=a[0],b=1;b<a.length;b++)c*=a[b];return c},x=function(b){var c=[],d=void 0,e=new Array,f=0,g=function(a,b){if(b.shape.forEach(function(b,d){if(void 0===c[a+d])c[a+d]=b;else if(c[a+d]!==b)throw"shape mismatch: level "+(a+d)+" expected "+c[a+d]+" found "+b}),void 0===d)d=a+b.shape.length;else if(d!==a+b.shape.length)throw"dimensionality mismatch; expected "+d+" found "+(a+b.shape.length);
var g,h=w(b.shape);for(b.materialize(),g=b.offset;g<b.offset+h;g++)e[f]=b.data[g],f++},h=function j(b,h){var i=0,k=0;if(h instanceof a&&h.flat)return void g(b,h);if(void 0===c[b])c[b]=h.length;else if(c[b]!==h.length)throw"shape mismatch: level "+b+" expected "+c[b]+" found "+h.length;for(k=0;k<h.length;k++)if(h[k]instanceof Array)j(b+1,h[k]);else if(h[k]instanceof a)h[k].flat?g(b+1,h[k]):j(b+1,h[k].get(i));else if(e[f]=h[k],f++,void 0===d)d=b;else if(d!==b)throw"dimensionality mismatch; expected "+d+" found "+b};try{h(0,b)}catch(i){return console.log("flattenArray:",i),null}return e},y=function(b){for(var c=[];b instanceof Array||b instanceof a;)b instanceof Array?(c.push(b.length),b=b[0]):(c.push(b.shape[0]),b=b.get(0));return c},z=function(a){return{getOwnPropertyDescriptor:function(b){var c=Object.getOwnPropertyDescriptor(a,b);return void 0!==c&&(c.configurable=!0),c},getPropertyDescriptor:function(b){var c=Object.getPropertyDescriptor(a,b);return void 0!==c&&(c.configurable=!0),c},getOwnPropertyNames:function(){return Object.getOwnPropertyNames(a)},getPropertyNames:function(){return Object.getPropertyNames(a)},defineProperty:function(b,c){Object.defineProperty(a,b,c)},"delete":function(b){return delete a[b]},fix:function(){return Object.isFrozen(a)?Object.getOwnPropertyNames(a).map(function(b){return Object.getOwnPropertyDescriptor(a,b)}):void 0},has:function(b){return b in a},hasOwn:function(b){return Object.prototype.hasOwnProperty.call(a,b)},get:function(b,c){var d=parseInt(c);return d==c?a.get(d):a[c]},set:function(b,c,d){return a[c]=d,!0},enumerate:function(){var b=[];for(name in a)b.push(name);return b},keys:function(){return Object.keys(a)}}},A=function(){return this.data=l.emptyRawArrayConstant,this.shape=l.zeroArrayShapeConstant,this.strides=l.oneStrideConstant,this.flat=!0,this.offset=0,this},B=function(a,b,c){if(!t(b))throw"Cannot Create ParallelArray: Invalid Typed Array Object";var d=function(a){this.data=a},e=d.bind(this);if(RiverTrail.Helper.isCData(a))RiverTrail.runtime.getValue(a,b,e);else{if(!RiverTrail.Helper.isWebCLBufferObject(a))throw"Error creating new ParallelArray: Invalid CData object";RiverTrail.runtime.getValue(a,b),this.data=b}return this.flat=!0,this.shape=c,this.strides=v(c),this.offset=0,this.isKnownRegular=!0,this},C=function(b,c){if(b instanceof Array){var d=x(b);if(null==d)for(this.data=new Array(b.length),this.flat=!1,e=0;e<b.length;e++)this.data[e]=b[e]instanceof Array?new a(b[e]):b[e];else this.shape=y(b),this.strides=v(this.shape),this.flat=!0,this.offset=0,this.data=s(d,c),void 0===this.data&&(this.data=d)}else if(b instanceof a)this.flat=b.flat,this.flat&&(this.shape=b.shape,this.strides=b.strides,this.offset=b.offset),void 0===c?(this.data=b.data,this.elementalType=b.elementalType):(b.materialize(),this.data=new c(b.data));else if(t(b)){this.flat=!0,this.strides=l.oneStrideConstant,this.offset=0,this.shape=[b.length],this.data=new b.constructor(b.length);for(var e=0;e<b.length;e++)this.data[e]=b[e];this.isKnownRegular=!0}else if(void 0!==b.getContext){var g=b.getContext("2d"),h=g.getImageData(0,0,b.width,b.height);this.data=h.data,this.shape=[b.height,b.width,4],this.strides=[4*b.width,4,1],this.flat=!0,this.offset=0,this.isKnownRegular=!0}else this.data=new f(1),this.data[0]=b,this.data[0]!==b&&(this.data=new Array(1),this.data[0]=b),this.shape=l.oneStrideConstant,this.strides=l.oneStrideConstant,this.flat=!0,this.offset=0;return this},D=function(a,b,c){var d,f,g=!1;a instanceof Array||(f=new Array(1),f[0]=a,a=f,g=!0);try{return RiverTrail.compiler.compileAndGo(null,b,g?"comprehensionScalar":"comprehension",a,c,e)}catch(h){console.log("comprehension failed: "+h)}var i=new Array(0);return d=F(this,i,a,arguments[1],c,g),C.call(this,d),this},E=!1,F=function lb(b,c,d,e,f,g){var h,i,j;if(1==d.length){var k=new Array(c.length+1),l=new Array(f.length+1);for(h=0;h<f.length;h++)l[h+1]=f[h];var j=new Array(d[0]);for(h=0;h<c.length;h++)k[h]=c[h];for(h=0;h<d[0];h++)g?l[0]=h:(k[c.length]=h,l[0]=k),i=e.apply(b,l),j[h]=i instanceof Array?new a(i):i instanceof a?i:i;return j}if(g)throw new m("buildRaw called with scalarIndex === true but higher rank interation space");var n=new Array(c.length+1),o=d.slice(1);for(h=0;h<c.length;h++)n[h]=c[h];n[n.length-1]=d[0];var p=n[n.length-1];for(j=new Array(p),h=0;p>h;h++)n[n.length-1]=h,j[h]=lb(b,n,o,e,f,g);return j},G=function(b){if(this.flat)return H(this,b);var c,d,e=this.length/b,f=new Array(e);if(e*b!=this.length)throw new RangeError("ParallelArray.partition length not evenly divisible by partitionSize.");for(d=0;e>d;d++)c=this.data.slice(d*b,(d+1)*b),f[d]=new a(c);return new a(f)},H=function(b,c){var d,e=new Array(b.shape.length+1);for(d=1;d<e.length;d++)e[d]=b.shape[d-1];if(e[0]=e[1]/c,e[1]=c,w(e)!=w(b.shape))throw new RangeError("Attempt to partition ParallelArray unevenly.");var f=new a("reshape",b,e);return f},I=function(a){if(this.length!=a[0])return!1;if(1==a.length)return!0;var b,c=a.slice(1);for(b=0;b<this.length;b++)if(0==this.get(b).isRegularIndexed(c))return!1;return!0},J=function(){if(void 0===this.isKnownRegular)if(this.flat)this.isKnownRegular=!0;else{for(var b=(new Array(0),new Array(0)),c=this;c instanceof a;)b.push(c.length),c=c.get(0);this.isRegularIndexed(b)?(this.shape=b,this.isKnownRegular=!0):this.isKnownRegular=!1}return this.isKnownRegular},K=function(a){if(!this.isRegular())throw new TypeError("this is not a regular ParallelArray.");return void 0===a?this.shape.slice(0):this.shape.slice(0,a)},L=function(b,c){var d,e,f,g=2;if(("function"==typeof b||b instanceof low_precision.wrapper)&&(c=b,b=1,g=1),c instanceof low_precision.wrapper&&(c=c.unwrap()),!this.isRegular())throw new TypeError("ParallelArray.combineSeq this is not a regular ParallelArray.");if(arguments.length==g)f=new Array;else for(f=new Array(arguments.length-g),d=0;d<f.length;d++)f[d]=arguments[d+g];return e=F(this,new Array(0),this.getShape(b),c,f,!1),new a(e)},M=function(){var a,b,c,d,f,g=2,h="ParallelArray.combine(<optional depth>, function object, <optional extra arguments)";if(arguments.length<1)throw"Not enough arguments to combine. Usage: "+h;if("function"==typeof arguments[0]||arguments[0]instanceof low_precision.wrapper)d=1,f=arguments[0],g=1;else{if(!("function"==typeof arguments[1]||arguments[1]instanceof low_precision.wrapper)||"number"!=typeof arguments[0])throw"Invalid arguments to combine. Usage: "+h;d=arguments[0],f=arguments[1]}if(!this.isRegular())throw new TypeError("ParallelArray.combine: This is not a regular ParallelArray.");if(arguments.length==g)c=new Array(0);else for(c=new Array(arguments.length-g),a=0;a<c.length;a++)c[a]=arguments[a+g];return b=RiverTrail.compiler.compileAndGo(this,f,"combine",d,c,e)},N=function(b){var c,d,e=this.shape[0],f=new Array(arguments.length-1),g=new Array(e);if(b instanceof low_precision.wrapper&&(b=b.unwrap()),1==arguments.length)for(c=0;e>c;c++)g[c]=b.apply(this,[this.get(c)]);else for(c=0;e>c;c++){for(d=1;d<arguments.length;d++)f[d]=arguments[d];f[0]=this.get(c),g[c]=b.apply(this,f)}return this.data.constructor===Float32Array?new a(this.data.constructor,g):new a(g)},O=function(a){var b,c=(this.shape[0],new Array(arguments.length-1));if(1===arguments.length)b=RiverTrail.compiler.compileAndGo(this,a,"map",1,c,e);else{for(var d=1;d<arguments.length;d++)c[d-1]=arguments[d];b=RiverTrail.compiler.compileAndGo(this,a,"map",1,c,e)}return b},P=function(a){a instanceof low_precision.wrapper&&(a=a.unwrap());var b=Array.prototype.slice.call(arguments,0);b.unshift(0);var c,d=this.shape[0];for(b[0]=this.get(0),c=1;d>c;c++)b[1]=this.get(c),b[0]=a.apply(this,b);return b[0]},Q=function(b){if(b instanceof low_precision.wrapper&&(b=b.unwrap()),this.getShape()[0]<2)return this;{var c,d,e=this.length,f=new Array(e),g=Array.prototype.slice.call(arguments,0);g.unshift(0)}if(this.getShape().length<2){for(f[0]=this.get(0),c=1;e>c;c++)g[0]=f[c-1],g[1]=this.get(c),f[c]=b.apply(this,g);return new a(f)}var i=this.strides[0];if(h)try{f[0]=this.get(0),d=this.get(1),g[0]=f[0],g[1]=d,f[1]=b.apply(this,g);var j=f[1];if(j.data instanceof Object&&u(f[0].getShape(),j.getShape())){j.materialize(),this.materialize();var k=RiverTrail.Helper.allocateAlignedTA(j.data.constructor,this.data.length);for(c=0;i>c;c++)k[c]=this.data[c];var l=void 0;for(c=0;i>c;c++)k[c+i]=j.data[c];var m=this.get(0);for(m.data=k,m.updateInPlacePA=m,m.updateInPlaceOffset=i,m.updateInPlaceShape=j.shape,g[0]=m,g[1]=d,d.updateInPlacePA=m,d.updateInPlaceOffset=i,d.updateInPlaceShape=j.shape,c=2;e>c;c++)if(d.offset+=i,m.offset+=i,d.updateInPlaceOffset+=i,m.updateInPlaceOffset+=i,m.updateInPlaceUses=0,l=b.apply(this,g),l.data!==d.updateInPlacePA.data)throw new n("speculation failed: result buffer was not used");return new a(m.data,this.shape,this.inferredType)}}catch(o){console.log("scan: speculation failed, reverting to normal mode"),d=this.get(1),f[0]=this.get(0),g[0]=f[0]}else d=this.get(1),f[0]=this.get(0),g[0]=f[0],g[1]=d,f[1]=b.apply(this,g);for(c=2;e>c;c++)d.offset+=i,g[0]=f[c-1],f[c]=b.apply(this,g);return new a(f)},R=function(){var b,c,d,e=this.length,f=L.apply(this,arguments),g=0;for(c=0;c<this.length;c++)0!=f.get(c)&&g++;for(b=new Array(g),d=0,c=0;e>c;c++)1==f.get(c)&&(b[d]=this.get(c),d++);return new a(b)},S=function(b,c,d,e){var f,g,h=this.shape[0],i=arguments.length>=2,j=arguments.length>=3&&null!=arguments[2],k=arguments.length>=4?e:h,l=new Array(k),m=new Array(k);if(i)for(g=0;k>g;g++)l[g]=c;for(g=0;g<b.length;g++){var n=b instanceof a?b.get(g):b[g];if(n>=k)throw new RangeError("Scatter index out of bounds");if(m[n]){if(!j)throw new RangeError("Duplicate indices in scatter");l[n]=d.call(void 0,this.get(g),l[n])}else l[n]=this.get(g),m[n]=!0}return f=new a(l)},T=function(){var b,c;if(this.flat&&1===this.shape.length)c=Array.prototype.slice.call(this.data,this.offset,this.offset+this.length);else for(c=new Array(this.length),b=0;b<this.length;b++){var d=this.get(b);c[b]=d instanceof a?d.getArray():d}return c},U=function(){var a=new this.data.constructor(this.data);return a},V=function(b){var c,d,e,f;if(this.flat){if(b instanceof Array){e=this.offset;var g=b.length;for(c=0;g>c;c++){if(b[c]<0||b[c]>=this.shape[c])return void 0;e+=b[c]*this.strides[c]}if(this.shape.length<b.length)throw"too many indices in get call";return this.shape.length===b.length?this.data[e]:(d=new a(this),d.offset=e,d.elementalType=this.elementalType,d.shape=this.shape.slice(b.length),d.strides=this.strides.slice(b.length),d.__proto__!==a.prototype&&(d.__proto__=kb[d.shape.length].prototype),d)}return 1==arguments.length?0>b||b>=this.shape[0]?void 0:1==this.shape.length?this.data[this.offset+b]:(e=this.offset+this.strides[0]*b,d=new a(this),d.offset=e,d.elementalType=this.elementalType,d.shape=this.shape.slice(1),d.strides=this.strides.slice(1),d):(f=Array.prototype.slice.call(arguments),this.get(f))}if(1==arguments.length){if(arguments[0]instanceof Array){for(d=this,c=0;c<arguments[0].length;c++)if(d=d.data[arguments[0][c]],void 0===d)return d;return d}return this.data[b]}for(d=this,c=0;c<arguments.length;c++)if(d=d.data[arguments[c]],void 0===d)return d;return d},W=function(a){var b,d=a.getContext("2d"),e=d.getImageData(0,0,a.width,a.height),f=d.createImageData(e.width,e.height),g=f.data;if(c&&this.data instanceof Object)this.data.writeTo(g);else for(var b=0;b<this.data.length;b++)g[b]=this.data[b];d.putImageData(f,0,0)},X=function(){var b,c,d,e,f=arguments.length,g=t(this.data),h=this.data instanceof Array,i=this.length,j=0;c=new Array(arguments.length);for(var d=0;f>d;d++)c[d]=arguments[d],i+=arguments[d].length,g&&(g=t(arguments[d].data),h=!1),h&&(h=arguments[d].data instanceof Array);if(g)return Y.apply(this,c);if(h)return Z.apply(this,c);for(b=new Array(i),d=0;d<this.length;d++)b[j]=this.get(d),j++;for(d=0;d<arguments.length;d++)for(e=0;e<arguments[d].length;e++)b[j]=arguments[d].get(e),j++;return new a(b)},Y=function(){var b,c,d,e=arguments.length,f=this.length;for(c=0;c<arguments.length;c++)f+=arguments[c].length;for(b=this.data.constructor(f),b.set(this.data),d=this.length,c=0;e>c;c++)b.set(arguments[c].data,d),d+=arguments[c].length;return new a(b)},Z=function(){var b,c=new Array;for(c=c.concat(this.data),b=0;b<arguments.length;b++)c=c.concat(arguments.data);return new a(c)},$=function(b){var c;return c=b?this.data.join(b instanceof a?b.data:b):this.data.join()},_=function(){throw new TypeError("ParallelArray has no method 'pop' - it is a read only construct.")},ab=function(){throw new TypeError("ParallelArray has no method 'push' - it is a read only construct.")},bb=function(){throw new TypeError("ParallelArray has no method 'reverse' - it is a read only construct.")},cb=function(){throw new TypeError("ParallelArray has no method 'shift' - it is a read only construct.")},db=function(b,c){return new a(t(this.data)?this.data.subarray(b,c):this.data.slice(b,c))},eb=function(){throw new TypeError("ParallelArray has no method 'sort' - it is a read only construct.")},fb=function(){throw new TypeError("ParallelArray has no method 'splice' - it is a read only construct.")},gb=function(){if(this.flat){for(var a=this.shape.reduce(function(a,b){return a*b})+this.offset,b="[",c=this.offset;a>c;c++)b+=(c===this.offset?"":", ")+this.data[c];return b+="]"}return"["+this.data.join(", ")+"]"},hb=function(){throw new TypeError("ParallelArray has no method 'unshift' - it is a read only construct.")},ib=function(){var b,c,d=this.length,e=0;if(this.flat){if(b=this.getShape(),1==b.length)throw new TypeError("ParallelArray.flatten array is flat");var f=b.slice(1);return f[0]=f[0]*b[0],new a("reshape",this,f)}for(c=0;d>c;c++){if(!(this.get(c)instanceof a))throw new TypeError("ParallelArray.flatten not a ParallelArray of ParallelArrays.");e+=this.get(c).length}var g=new Array(e),h=0;for(c=0;d>c;c++){var i=this.get(c);for(j=0;j<i.length;j++)g[h]=i.get(j),h++}return new a(g)},jb=function(){var b;if(this.flat)return b=new a(this),b.strides=[1],b.shape=[w(this.shape)],b.offset=0,b;var c=function f(b,c,d){if(0!==b.length)if(b.get(0)instanceof a)for(var e=0;e<b.length;e++)c=f(b.get(e),c,d);else for(var e=0;e<b.length;e++)d[c]=b.get(e),c++;return c};if(!this.isRegular())throw new TypeError("ParallelArray.flatten called on non-regular array");var d=this.shape.reduce(function(a,b){return a*b},1),e=new Array(d);return c(this,0,e),new a(e)},kb=function(){var a=function(a){return this.shape=a.shape,this.strides=a.strides,this.offset=a.offset,this.elementalType=a.elementalType,this.data=a.data,this.flat=a.flat,this};a.prototype={get:function(){if(0===arguments.length)return this;throw"too many indices in get call"}};var b=function(a){return this.shape=a.shape,this.strides=a.strides,this.offset=a.offset,this.elementalType=a.elementalType,this.data=a.data,this.flat=a.flat,this};b.prototype={get:function(a){var b=arguments.length;if(1===b)return"number"==typeof a?0>a||a>=this.shape[0]?void 0:this.data[this.offset+a]:this.__proto__.__proto__.get.call(this,a);if(0===b)return this;throw"too many indices in get call"}};var c=function(a){return this.shape=a.shape,this.strides=a.strides,this.offset=a.offset,this.elementalType=a.elementalType,this.data=a.data,this.flat=a.flat,this};c.prototype={get:function(a,c){var d,e=arguments.length;if(2===e)return 0>a||a>=this.shape[0]||0>c||c>=this.shape[1]?void 0:this.data[this.offset+a*this.strides[0]+c];if(1===e)return"number"==typeof a?0>a||a>=this.shape[0]?void 0:(d=new b(this),d.offset=this.offset+a*this.strides[0],d.elementalType=this.elementalType,d.shape=this.shape.slice(1),d.strides=this.strides.slice(1),d):this.__proto__.__proto__.get.call(this,a);if(0===e)return this;throw"too many indices in get call"}};var d=function(a){return this.shape=a.shape,this.strides=a.strides,this.offset=a.offset,this.elementalType=a.elementalType,this.data=a.data,this.flat=a.flat,this};return d.prototype={get:function(a,d,e){var f,g=arguments.length;if(3===g)return 0>a||a>=this.shape[0]||0>d||d>=this.shape[1]||0>e||e>=this.shape[2]?void 0:this.data[this.offset+a*this.strides[0]+d*this.strides[1]+e];if(2===g)return 0>a||a>=this.shape[0]||0>d||d>=this.shape[1]?void 0:(f=new b(this),f.offset=this.offset+a*this.strides[0]+d*this.strides[1],f.elementalType=this.elementalType,f.shape=this.shape.slice(2),f.strides=this.strides.slice(2),f);if(1===g)return"number"==typeof a?0>a||a>=this.shape[0]?void 0:(f=new c(this),f.offset=this.offset+a*this.strides[0],f.elementalType=this.elementalType,f.shape=this.shape.slice(1),f.strides=this.strides.slice(1),f):this.__proto__.__proto__.get.call(this,a);throw"too many indices in get call"}},[a,b,c,d]}();return a.prototype={get length(){return this.flat?this.getShape()[0]:this.data.length},set verboseDebug(a){RiverTrail.compiler.verboseDebug=a},set suppressOpenCL(a){E=a},materialize:p,partition:G,isRegularIndexed:I,isRegular:J,getShape:K,map:O,mapSeq:N,combine:M,combineSeq:L,reduce:P,scan:Q,filter:R,scatter:S,getArray:T,getData:U,get:V,writeToCanvas:W,concat:X,join:$,pop:_,push:ab,reverse:bb,shift:cb,slice:db,sort:eb,splice:fb,toString:gb,unshift:hb,flatten:ib,flattenRegular:jb,get maxPrecision(){return e?64:32}},kb.forEach(function(b){b.prototype.__proto__=a.prototype}),a}(),low_precision=function(a){if("function"!=typeof a)throw new TypeError("low_precision can only be applied to functions");return new low_precision.wrapper(a)};if(low_precision.wrapper=function(a){return this.wrappedFun=a,this},low_precision.wrapper.prototype={unwrap:function(){return this.wrappedFun}},void 0===RiverTrail)var RiverTrail={};RiverTrail.compiler=function(){function a(a,b,c,d,e,f,g){var h=RiverTrail.Helper.parseFunction(d),i=c.length||c;try{RiverTrail.Typeinference.analyze(h,a,b,i,e,f),RiverTrail.RangeAnalysis.analyze(h,a,b,c,e,g),RiverTrail.RangeAnalysis.propagate(h,b),RiverTrail.InferBlockFlow.infer(h),RiverTrail.InferMem.infer(h)}catch(j){RiverTrail.Helper.debugThrow(j)}return h}var b=RiverTrail.Helper.inferPAType,c=!0,d=!0,e=2,f=1,g=2,h=16,i=!0,j=!1,k=!1;RiverTrail.runtime.initContext();var l=RiverTrail.Helper.isTypedArray,m=function(a,b){var c,d;if(a===b)return!0;if(null===a||null===b)return!1;if(a.type!==b.type)return!1;switch(a.type){case"number":return a.val===b.val;case"array":c=a.val,d=b.val;for(var e=0;e<d.length;e++)if(c[e]!==d[e])return!1;return!0;case"flatarray":case"parallelarray":if(c=a.val.data,d=b.val.data,void 0===c.length||void 0===d.length)return!1;for(var e=0;e<d.length;e++)if(c[e]!==d[e])return!1;return!0;default:return!1}},n=function(b,f,g,n,o,s){"use strict";var u,v,w,x=null;f instanceof low_precision.wrapper?(v=!0,f=f.unwrap()):v=!s;var y=v?"float":"double";o=Array.prototype.map.call(o,function(a){return a instanceof Array?"function"==typeof canBeMapped&&canBeMapped(a)?a:new RiverTrail.Helper.FlatArray(v?Float32Array:Float64Array,a):a});var z=t(g,o,n,y),A=null;d&&(A=o.map(function(a){return"number"==typeof a?{val:a,type:"number",seen:1}:l(a)&&a.length<h?{val:a,type:"array",seen:1}:a instanceof RiverTrail.Helper.FlatArray&&a.shape.length<=2&&a.shape[0]*(1|a.shape[1])<h?{val:a,type:"flatarray",seen:1}:a instanceof ParallelArray&&a.shape.length<=2&&a.shape[0]*(1|a.shape[1])<h?{val:a,type:"parallelarray",seen:1}:null}));var B=null,C=null;if(void 0!==f.openCLCache)if(c){if(C=p(f,g,b,z,v,n),null!=C){C.uses++,d&&(C.vals=C.vals.map(function(a,b){if(null===a)return a;var c=A[b];if(a[0]===c)return a;if(null!==a[0]&&null!==c&&m(c,a[0]))return a[0].seen++,a;if(null===c){for(var d=1;d<a.length;d++)if(null===a[d])return a[d]=a[d-1],a[d-1]=null,a;a.push(null)}else{for(var d=1;d<a.length;d++)if(null!==a[d]&&m(a[d],c)){var f=a[d];return a[d]=a[d-1],a[d-1]=f,f.seen++,a}a.push(c)}return a.length>e?null:a}));var D=q(C,A);if(B=r(C,D,A),!B)return x=RiverTrail.compiler.runOCL(b,D.kernel,C.ast,g,n,o,z,v,i)}}else f.openCLCache=void 0;c&&void 0===f.openCLCache&&(f.openCLCache=[]);try{w=a(b,g,n,f.toString(),o,v,B),u=RiverTrail.compiler.codeGen.compile(w,b,n,g)}catch(E){RiverTrail.Helper.debugThrow(E)}if(RiverTrail.compiler.verboseDebug&&(console.log("::parseGenRunOCL:kernelString: ",u),console.log("::parseGenRunOCL:args: ",JSON.stringify(o))),j)return console.log("Not executing OpenCL returning 'this' parseGenRunOCL:surpressOpenCL: ",j),this;var F,G=w.name;if(!G)throw new Error("Invalid ast: Function expected at top level");try{s&&(u="#pragma OPENCL EXTENSION cl_khr_fp64 : enable\n"+u),F=RiverTrail.runtime.compileKernel(u,"RT_"+G)}catch(E){try{var H=getBuildLog();console.log(H)}catch(I){var H="<not available>"}RiverTrail.Helper.debugThrow("The OpenCL compiler failed. Log was `"+H+"'.")}if(k)try{var H=RiverTrail.runtime.getBuildLog();-1!==H.indexOf("was successfully vectorized")&&console.log(G+"was successfully vectorized")}catch(E){}if(c)if(C)C.kernel.push({kernel:F,spec:B});else{var C={ast:w,name:w.name,source:f,paType:b?RiverTrail.Helper.inferPAType(b):void 0,kernel:[{kernel:F,spec:B}],construct:g,lowPrecision:v,argumentTypes:z,iterSpace:n,uses:1,vals:d?A.map(function(a){return[a]}):null};f.openCLCache.push(C)}try{x=RiverTrail.compiler.runOCL(b,F,w,g,n,o,z,v,i)}catch(E){try{RiverTrail.Helper.debugThrow(E+getBuildLog())}catch(I){RiverTrail.Helper.debugThrow(E)}}return x},o=function(a){if(void 0===a.inferredType||void 0===a.dimSize){var b=RiverTrail.Helper.inferPAType(a);a.inferredType=b.inferredType,a.dimSize=b.dimSize}},p=function(a,b,c,d,e,f){var g,h,i=function(a,b){return o(a),o(b),a.inferredType===b.inferredType&&u(a.dimSize,b.dimSize)},j=function(a,b){return a.length!==b.length?!1:a.every(function(a,c){return i(a,b[c])})};for(g=0;g<a.openCLCache.length;g++)if(h=a.openCLCache[g],b===h.construct&&e===h.lowPrecision&&h.source===a&&j(d,h.argumentTypes)&&("comprehension"!==b&&"comprehensionScalar"!==b&&i(c,h.paType)&&u(c.shape,h.paType.dimSize)||("comprehension"==b||"comprehensionScalar"==b)&&u(f,h.iterSpace)))return a.openCLCache[g];return null},q=function(a,b){"use strict";for(var c=0,d=a.kernel[0],e=1;e<a.kernel.length;e++){var f=!0,g=0,h=a.kernel[e].spec;if(null===h){f=!1;break}for(var i=0;i<b.length;i++)if(null!==h[i]){if(!m(h[i],b[i])){f=!1;break}g++}f&&g>c&&(d=a.kernel[e])}return d},r=function(a,b,c){"use strict";if(a.uses<g)return null;if(a.kernel.length>5)return null;var d,e=!1;d=null===b.spec?c.map(function(){return null}):b.spec.map(function(a){return a});for(var h=0;h<d.length;h++)if(null===d[h]){var i=a.vals[h];if(null!==i)for(var j=0;f>j;j++)if(m(i[j],c[h])){d[h]=c[h],e=!0;break}}return RiverTrail.compiler.debug&&console.log("new spec: "+s(d)),e?d:null},s=function(a){"use strict";if(!a)return"null";for(var b="",c=0;c<a.length;c++)b=b+"["+c+", "+(a[c]?a[c].val.toString()+", "+a[c].type:"null")+"]";return b},t=function(a,c,d,e){var f,g=[];for("combine"==a?g.push({inferredType:"int",dimSize:[d],attributes:{isIndex:!0}}):"comprehension"==a?g.push({inferredType:"int",dimSize:[d.length],attributes:{isIndex:!0}}):"comprehensionScalar"==a&&g.push({inferredType:"int",dimSize:[],attributes:{isIndex:!0}}),f=0;f<c.length;f++){var h=c[f];if(h instanceof ParallelArray)g.push(b(h));else if(h instanceof RiverTrail.Helper.FlatArray)g.push({inferredType:e,dimSize:h.shape});else if(h instanceof Array)g.push({inferredType:"/* jsval */ double",dimSize:function i(a,b){return a instanceof Array&&(b.push(a.length),i(a[0],b)),b}(h,[])});else if(RiverTrail.Helper.isTypedArray(h))g.push({inferredType:RiverTrail.Helper.inferTypedArrayType(h),dimSize:[h.length]});else if(h instanceof RiverTrail.Helper.Integer)g.push({inferredType:"int",dimSize:[]});else if("number"==typeof h)g.push({inferredType:e,dimSize:[]});else{if(!(h instanceof Number))throw new Error("Type derivation for argument not implemented yet");g.push({inferredType:e,dimSize:[]})}}return g},u=function(a,b){return a.length==b.length&&Array.prototype.every.call(a,function(a,c){return a==b[c]})};return{verboseDebug:!1,debug:!1,compileAndGo:n}}(),RiverTrail.dotviz=function(){function a(){return"n"+i++}function b(a){return void 0!==a&&null!==a&&"object"==typeof a&&(a instanceof Narcissus.parser.Node||a instanceof Array)}function c(a){return a.replace(l,function(a){return"\\"+a})}function d(e,f){var g="";if(void 0==e)g=g+a(e)+'[label="(undefined)"]\n';else if(e instanceof Array)for(var h=0;h<e.length;h++)g+=d(e[h],f);else{var i=a(e);if(g=g+i+'[label="',e instanceof Narcissus.parser.Node){g+=c(j[e.type]||"undefined");for(var l in k)void 0==e[l]||e[l]instanceof Array&&!(e[l].length>0)||(g=g+"| <"+l+"> "+l,e[l]instanceof Array?g+=" : Array":"function"==typeof e[l]?g+=" : function":"string"==typeof e[l]?g=g+" = '"+c(e[l])+"'":"number"==typeof e[l]?g=g+" = "+e[l]:e[l]instanceof Narcissus.parser.Node?g+=" : Node":"function"==typeof e[l].toString&&(g=g+" = "+c(e[l].toString())))}else g+=c(e.toString());g+='",shape="record"]\n',void 0!=f&&(g=g+f+" -> "+i+"\n");for(var l in k)b(e[l])&&(g+=d(e[l],i+":"+l))}return g}function e(b){var d="";return b.dotname||(b.dotname=a(b),d=d+b.dotname+'[label="'+c(b.toString())+'"]\n',b.flowTo&&(d=b.flowTo.reduce(function(a,c){return a+=e(c),a=a+b.dotname+" -> "+c.dotname+"\n"},d))),d}function f(a,b){if(b||(b="tmp_graph.png"),window.dot_interface){window.dot_interface.generatePng(a,b);var c=window.dot_interface.TargetUrl+b,d=document.getElementById("status");if(d){var e=document.createElement("img");e.setAttribute("src",c),d.appendChild(e)}}}function g(a,b){i=0;var c="digraph {\n";return c+='graph [ rankdir = "LR" ];\n',c+=d(a,void 0),c+="}\n",b||(b="tmp_graph.png"),f(c,b),c}function h(a,b){!a instanceof Array&&(a=[a]),i=0;var c="digraph {\n";return c+='graph [ rankdir = "LR" ];\n',c=a.reduce(function(a,b){return a+e(b)},c),c+="}\n",b||(b="tmp_types.png"),f(c,b),c}var i=0,j=RiverTrail.definitions.tokens,k={children:null,value:null,name:null,body:null,params:null,condition:null,thenPart:null,elsePart:null,setup:null,update:null,iterator:null,discriminant:null,cases:null,statements:null,caseLabel:null,expression:null,initializer:null,"varDecls ":null,"funDecls ":null,"typeInfo ":null,"rangeInfo ":null},l=/[\{\}<>\"\']/g;return{addStatus:g,plotTypes:h}}();var globalInlineObjectTypes=[];if(RiverTrail.Typeinference=function(){function reportError(a,b){a=stackTrace.reduce(function(a,b){return a+" -> "+b.fun.name+" [call was: "+RiverTrail.Helper.wrappedPP(b.ast)+"]"},"In main")+": "+a,RiverTrail.Helper.reportError(a,b)}function drive(ast,tEnv,fEnv){"use strict";var left,right;switch((null===ast||void 0===ast)&&reportBug("malformed syntax tree",ast),ast.type){case CAST:case TOINT32:ast=ast.children[0];case SCRIPT:tEnv=new TEnv(tEnv),ast.varDecls.forEach(function(a){tEnv.bind(a.value)}),ast.funDecls.forEach(function(a){a.name||reportBug("unnamed function in funDecls"),tEnv.bind(a.name)}),fEnv=new FEnv(fEnv),ast.funDecls.forEach(function(a){fEnv.add(a)}),ast.children.map(function(a){return drive(a,tEnv,fEnv)}),tEnv.resetAccu(),ast.symbols=tEnv,ast.funDecls=fEnv.toFunDecls();break;case BLOCK:ast.children.map(function(a){return drive(a,tEnv,fEnv)}),tEnv.resetAccu();break;case FUNCTION:ast.functionForm!==Narcissus.parser.DECLARED_FORM&&reportBug("function literals should not be in statement position",ast);break;case RETURN:ast.value||reportError("functions need to return a value",ast),ast.value=drive(ast.value,tEnv,fEnv),tEnv.functionResult=tEnv.accu;break;case FOR:ast.setup=drive(ast.setup,tEnv,fEnv);case WHILE:ast.condition=drive(ast.condition,tEnv,fEnv);var innerEnv=new TEnv(tEnv);ast.body=drive(ast.body,innerEnv,fEnv),ast.update&&(ast.update=drive(ast.update,innerEnv,fEnv)),innerEnv.tagAllUnitialized(),tEnv.merge(innerEnv);break;case DO:ast.body=drive(ast.body,tEnv,fEnv),ast.condition=drive(ast.condition,tEnv,fEnv);break;case IF:ast.condition=drive(ast.condition,tEnv,fEnv),tEnv.accu.isTruthType()||reportError("illegal predicate in conditional",ast);var thenEnv=new TEnv(tEnv);ast.thenPart=drive(ast.thenPart,thenEnv,fEnv);var elseEnv=new TEnv(tEnv);ast.elsePart&&(ast.elsePart=drive(ast.elsePart,elseEnv,fEnv)),thenEnv.intersect(elseEnv),tEnv.merge(thenEnv);break;case SEMICOLON:ast.expression&&(ast.expression=drive(ast.expression,tEnv,fEnv)),tEnv.resetAccu();break;case VAR:case CONST:ast.children.map(function(a){return a.initializer&&(a.initializer=drive(a.initializer,tEnv,fEnv),tEnv.update(a.name,tEnv.accu),a.typeInfo=tEnv.accu,tEnv.resetAccu()),a});break;case ASSIGN:switch(ast.children[1]=drive(ast.children[1],tEnv,fEnv),left=ast.children[0],ast.children[0].type){case IDENTIFIER:tEnv.update(left.value,tEnv.accu),left=drive(left,tEnv,fEnv);break;case INDEX:left=drive(left,tEnv,fEnv),left.children[0].typeInfo.isObjectType(TObject.ARRAY)||reportError("illegal object in lhs selection; type seen was "+left.children[0].typeInfo,ast),left.typeInfo.equals(ast.children[1].typeInfo)||reportError("mutation of array invalidates types: "+left.typeInfo+" updated with "+ast.children[1].typeInfo,ast),tEnv.accu=ast.children[0].typeInfo.clone();break;case DOT:left=drive(left,tEnv,fEnv),left.children[0].typeInfo.isObjectType("InlineObject")&&left.children[0].typeInfo.properties.fields.hasOwnProperty(left.children[1].value)||reportError("Invalid field "+left.children[1].value+" referenced on object "+left.children[0].value),tEnv.accu=ast.children[0].typeInfo.clone();break;case ARRAY_INIT:default:reportBug("unhandled lhs in assignment")}break;case COMMA:ast.children.map(function(a){return drive(a,tEnv,fEnv)});break;case HOOK:ast.children[0]=drive(ast.children[0],tEnv,fEnv),tEnv.accu.isTruthType()||reportError("illegal predicate in conditional expression",ast),ast.children[1]=drive(ast.children[1],tEnv,fEnv),left=tEnv.accu,ast.children[2]=drive(ast.children[2],tEnv,fEnv),left.equals(tEnv.accu)||reportError("then and else branch in conditional expression have different types",ast),right=tEnv.accu,tEnv.accu=left.clone(),tEnv.accu.registerFlow(right),tEnv.accu.registerFlow(left);break;case PLUS:case BITWISE_OR:case BITWISE_XOR:case BITWISE_AND:case EQ:case NE:case STRICT_EQ:case STRICT_NE:case LT:case LE:case GE:case GT:case LSH:case RSH:case URSH:case MINUS:case MUL:case DIV:case MOD:ast.children[0]=drive(ast.children[0],tEnv,fEnv),tEnv.accu.isArithType()||reportError("first argument not a number (found "+tEnv.accu.toString()+")",ast),ast.children[1]=drive(ast.children[1],tEnv,fEnv),tEnv.accu.isArithType()||reportError("second argument not a number (found "+tEnv.accu.toString()+")",ast),tEnv.accu=new TLiteral(TLiteral.NUMBER);break;case OR:case AND:ast.children[0]=drive(ast.children[0],tEnv,fEnv),tEnv.accu.isArithType()||reportError("first argument not a number (found "+tEnv.accu.toString()+")",ast),ast.children[1]=drive(ast.children[1],tEnv,fEnv),tEnv.accu.isArithType()||reportError("second argument not a number (found "+tEnv.accu.toString()+")",ast),tEnv.accu=new TLiteral(TLiteral.BOOL);break;case NOT:case BITWISE_NOT:case UNARY_PLUS:case UNARY_MINUS:case INCREMENT:case DECREMENT:ast.children[0]=drive(ast.children[0],tEnv,fEnv),tEnv.accu.isArithType()||reportError("argument not a number (found "+tEnv.accu.toString()+")",ast),tEnv.accu=new TLiteral(ast.type===NOT?TLiteral.BOOL:TLiteral.NUMBER);break;case IDENTIFIER:case THIS:var idType=tEnv.lookup(ast.value)||reportError("unbound variable: "+ast.value,ast);idType.initialized||reportError("variable "+ast.value+" might be uninitialized",ast),tEnv.accu=idType.type.clone(),tEnv.accu.registerFlow(idType.type);break;case DOT:ast.children[0]=drive(ast.children[0],tEnv,fEnv);var obj=tEnv.accu;obj.isObjectType()||reportError("dot applied to non-object value",ast),tEnv.accu=obj.getHandler().propertySelection(ast.children[1].value,tEnv,fEnv,ast);break;case NUMBER:tEnv.accu=new TLiteral(TLiteral.NUMBER);break;case TRUE:case FALSE:tEnv.accu=new TLiteral(TLiteral.BOOL);break;case INDEX:ast.children[1]=drive(ast.children[1],tEnv,fEnv),tEnv.accu.isArithType()||reportError("index not a number (found "+tEnv.accu.toString()+")",ast),ast.children[0]=drive(ast.children[0],tEnv,fEnv),tEnv.accu.isObjectType(TObject.ARRAY)||tEnv.accu.isObjectType(TObject.JSARRAY)?(left=tEnv.accu.properties.elements.clone(),left.registerFlow(tEnv.accu),tEnv.accu=left):tEnv.accu.isObjectType(TObject.PARALLELARRAY)?(1===tEnv.accu.properties.shape.length?(left=tEnv.accu.properties.elements.clone(),left.registerFlow(tEnv.accu)):(left=new TObject(TObject.PARALLELARRAY),left.properties.shape=tEnv.accu.properties.shape.slice(1),left.properties.addressSpace=tEnv.accu.properties.addressSpace,left.properties.elements=tEnv.accu.properties.elements.clone(),left.updateOpenCLType(),left.registerFlow(tEnv.accu)),tEnv.accu=left):reportError("Index operator applied to non array value. Type found: "+tEnv.accu.toString(),ast);
break;case ARRAY_INIT:left=[];for(var idx in ast.children)ast.children[idx]=drive(ast.children[idx],tEnv,fEnv),left.push(tEnv.accu);left.length>0||reportError("empty arrays are not supported",ast),left.reduce(function(a,b){return a.equals(b)||reportError("inhomogeneous element types in array initialiser",ast),a}),tEnv.accu=new TObject(TObject.ARRAY),tEnv.accu.properties.elements=left[0].clone(),tEnv.accu.properties.shape=[ast.children.length],tEnv.accu.updateOpenCLType(),tEnv.addRoot(tEnv.accu),tEnv.accu.setAddressSpace("__private");break;case CALL:switch(ast.children[0].type){case DOT:if("RiverTrailUtils"===ast.children[0].children[0].value){RiverTrailUtils_Trap(ast,tEnv,fEnv);break}var dot=ast.children[0];dot.children[0]=drive(dot.children[0],tEnv,fEnv);var objType=tEnv.accu;objType.isObjectType()||reportError("left hand side of method call not an object",ast),tEnv.accu=objType.getHandler().methodCall(objType,dot.children[1].value,tEnv,fEnv,ast);break;case IDENTIFIER:ast.children[1]=drive(ast.children[1],tEnv,fEnv);var argT=tEnv.accu;tEnv.resetAccu();var fname=ast.children[0].value,fun=fEnv.lookup(fname);if(!fun){!tEnv.lookup(fname)||reportError("not a function `"+fname+"`",ast);var obj=eval(fname)||reportError("unknown function `"+fname+"`",ast);"function"==typeof obj||reportError("not a function `"+fname+"`",ast),fun=RiverTrail.Helper.parseFunction(obj.toString()),fEnv.add(fun,ast.children[0].value,!0)}var resType=void 0,rootFun=fun;if(fun.typeInfo){for(var found,cnt=0;cnt<fun.specStore.length;cnt++)if(argT.every(function(a,b){return a.equals(fun.specStore[cnt].typeInfo.parameters[b],!0)})){found=fun.specStore[cnt];break}found?(resType=found.typeInfo.result,fun=found):fun=cloneFunctionNoTypes(fun)}if(!resType){fun.dispatch=nameGen(fun.name);var innerTEnv=new TEnv(tEnv,!0);stackTrace.push({ast:ast,fun:fun}),fun.params.length===argT.length||reportError("number of parameters and arguments in call does not match",ast),fun.params.forEach(function(a,b){innerTEnv.bind(a),innerTEnv.update(a,argT[b].clone())}),fun.body=drive(fun.body,innerTEnv,fEnv),void 0===rootFun.specStore&&(rootFun.specStore=[]),rootFun.specStore.push(fun),resType=innerTEnv.functionResult,stackTrace.pop();var innerArgT=fun.params.map(function(a){return innerTEnv.lookup(a).type});innerArgT.forEach(function(a){innerTEnv.addRoot(a)}),fun.flowFrame=new FFunction(innerArgT,resType,fun),fun.typeInfo=new TFunction(innerArgT,resType),fun.flowRoots=innerTEnv.getRoots(),fun.symbols=innerTEnv}ast.callFrame=new FCall(argT,fun.flowFrame,resType.clone(),ast),argT.forEach(function(a,b){a.registerParamFlow(new FParam(b,ast.callFrame))}),fun.flowFrame.uses++,ast.children[0].dispatch=fun.dispatch,tEnv.accu=ast.callFrame.result;break;default:reportError("unexpected target for function call",ast)}break;case LIST:left=[];for(var idx in ast.children){ast.children[idx]=drive(ast.children[idx],tEnv,fEnv);var inner=tEnv.accu.clone();inner.registerFlow(tEnv.accu),left.push(inner)}tEnv.accu=left;break;case GETTER:case SETTER:reportError("setters/getters not yet implemented",ast);break;case TRY:case THROW:reportError("try/throw/catch/finally not yet implemented",ast);break;case BREAK:reportError("break not yet implemented",ast);break;case CONTINUE:reportError("continue not yet implemented",ast);break;case LABEL:reportError("break/continure2/labels not yet implemented",ast);break;case YIELD:case GENERATOR:reportError("generators/yield not yet implemented",ast);break;case FOR_IN:reportError("for .. in loops not yet implemented",ast);break;case ARRAY_COMP:case COMP_TAIL:reportError("array comprehensions not yet implemented",ast);break;case NEW:case NEW_WITH_ARGS:if(ast.children[0].type===IDENTIFIER&&"ParallelArray"===ast.children[0].value&&ast.children[1].type===LIST&&1===ast.children[1].children.length){ast.children[1].children[0]=drive(ast.children[1].children[0],tEnv,fEnv),right=tEnv.accu.clone(),right.isObjectType(TObject.ARRAY)?(right.name=TObject.PARALLELARRAY,right.properties.shape=right.getOpenCLShape(),right.properties.elements=function a(b){return b.isScalarType()?b:a(b.properties.elements)}(right),ast.type=FLATTEN,ast.children[0]=ast.children[1].children[0],delete ast.children[1]):right.isObjectType(TObject.PARALLELARRAY)?ast=ast.children[1].children[0]:reportError("Only the simple form of ParallelArray's constructor is implemented",ast),tEnv.accu=right;break}reportError("general object construction not yet implemented",ast);case OBJECT_INIT:var property_names=[],property_typeInfo=[],fields={};for(var idx in ast.children){var prop=drive(ast.children[idx],tEnv,fEnv);prop.type===PROPERTY_INIT?(property_names.push(prop.typeInfo.name),property_typeInfo.push(prop.typeInfo.tInfo),fields[prop.typeInfo.name]=prop.typeInfo.tInfo):reportError("Unknown element in Object initializer",ast)}for(var obj_typeinfo=null,found=!1,i=0;i<globalInlineObjectTypes.length;i++){var ofields=globalInlineObjectTypes[i].properties.fields;for(var idx in fields)if(ofields.hasOwnProperty(idx)&&ofields[idx].equals(fields[idx])){obj_typeinfo=globalInlineObjectTypes[i];break}}null===obj_typeinfo&&(obj_typeinfo=new TObject("InlineObject"),obj_typeinfo.properties.fields=fields,obj_typeinfo.baseType="InlineObj_struct"+labelGen(),obj_typeinfo.OpenCLType=obj_typeinfo.baseType+"*",globalInlineObjectTypes.push(obj_typeinfo)),tEnv.accu=obj_typeinfo,tEnv.accu.setAddressSpace("__private");break;case PROPERTY_INIT:var right=drive(ast.children[1],tEnv,fEnv);tEnv.accu={name:ast.children[0].value,tInfo:ast.children[1].typeInfo};break;case WITH:reportError("general objects not yet implemented",ast);break;case LET:case LET_BLOCK:reportError("let not yet implemented",ast);break;case SWITCH:reportError("switch not yet implemented",ast);break;case INSTANCEOF:reportError("instanceof not yet implemented",ast);break;case EQ:case NE:reportError("non-strict equality not yet implemented",ast);break;case IN:reportError("in not yet implemented",ast);break;case NULL:reportError("null not yet implemented",ast);break;case REGEXP:reportError("regular expressions not yet implemented",ast);break;case STRING:reportError("strings not yet implemented",ast);break;case DEBUGGER:default:throw"unhandled node type in analysis: "+ast.type+"�is "+RiverTrail.Helper.wrappedPP(ast)}if(ast.typeInfo=tEnv.accu,ast.typeInfo&&ast.typeInfo._castRequired){var newAst=new Narcissus.parser.Node(ast.tokenizer);newAst.children.push(ast),newAst.type=CAST,newAst.typeInfo=ast.typeInfo._castRequired,delete ast.typeInfo._castRequired,ast=newAst,tEnv.accu=ast.typeInfo}return ast}function RiverTrailUtils_Trap(a,b,c){switch((a.children[1].type!==LIST||2!==a.children[1].children.length)&&reportError("Invalid method signature on RiverTrailUtils",a),a.children[0].children[1].value){case"createArray":var d=drive(a.children[1].children[1],b,c);"LITERAL"===d.typeInfo.kind&&"NUMBER"===d.typeInfo.type?a.initializer=a.children[1].children[1].value:reportError("Invalid value initializer",a);var e=[];a.children[1].children[0]=drive(a.children[1].children[0],b,c);for(var f=a.children[1].children[0].children,g=f.length,h=0;g>h;h++)("LITERAL"!==f[h].typeInfo.kind||"NUMBER"!==f[h].typeInfo.type||61!==f[h].type)&&reportError("Shape description must consist of literals only, e.g: [3, 4, 2]",a),e.push(f[h].value);b.accu=new TObject(TObject.ARRAY);var i,j=[],k="";for(i=0;i<e.length;i++)k+="*";for(i=0;i<e.length;i++)i===e.length-1?(j[i]=d.typeInfo,j[i].properties={}):(j[i]=new TObject(TObject.ARRAY),j[i].OpenCLType=d.typeInfo.OpenCLType+k.slice(0,k.length-i-1),j[i].properties={},j[i].properties.shape=[e[i+1]],j[i].properties.addressSpace="__private"),i>0&&(j[i-1].properties.elements=j[i]);b.accu.properties.elements=j[0],b.accu.properties.shape=[e[0]],b.accu.updateOpenCLType(),b.addRoot(b.accu),b.accu.setAddressSpace("__private");break;default:reportError("Invalid method called on RiverTrailUtils",a)}}function typeOracle(a){"use strict";var b;switch(typeof a){case"number":b=new TLiteral(TLiteral.NUMBER);break;case"object":var c=TObject.deriveObjectType(a)||reportError("unsupported object as argument encountered"),b=TObject.makeType(c,a);b.setAddressSpace("__global");break;default:reportError("unsupported argument kind encountered")}return b}function resetAddressSpaces(a){for(var b=[],c=a.map(function(a){return!a._reset||reportBug("leftover reset flow information!"),a._reset=!0,a});c.length>0;){var d=c.pop();b.push(d),d.flowTo?d.flowTo.forEach(function(a){a._reset||(a._reset=!0,a.setAddressSpace&&a.setAddressSpace(void 0),c.push(a))}):d instanceof FParam?d.call._reset||(d.call._reset=!0,c.push(d.call)):d instanceof FCall&&(d.result._reset||(d.result._reset=!0,c.push(d.result)))}b.forEach(function(a){delete a._reset})}function propagateAddressSpaces(a){for(var b=a.map(function(a){return!a._flow||reportBug("leftover flow information!"),a._flow=!0,a}),c=function(a,c){a._flowVisited||a._flow||(b.push(a),a._flow=!0),a.hasAddressSpace()?a.getAddressSpace()!==c&&"__private"!==a.getAddressSpace()&&(a.setAddressSpace("__private"),a._flow||(b.push(a),a._flow=!0)):(a.setAddressSpace(c),a._flow||(b.push(a),a._flow=!0))};b.length>0;){var d=b.pop();delete d._flow,d._flowVisited=!0;var e=d.getAddressSpace();void 0!==d.flowTo&&d.flowTo.forEach(function(a){if(a instanceof FParam){var b=a.getTarget(),d=a.getFrame();if(void 0===e||b.hasAddressSpace()&&b.getAddressSpace()===e)d._flowVisited||(d._flowVisited=!0,propagateAddressSpaces(d.ast.flowRoots));else{var f=d.root.adrSpecStore,g=void 0;if(f&&f.some(function(b){return b.typeInfo.parameters.every(function(b,c){return c===a.number?b.getAddressSpace()===e:b.getAddressSpace()===d.params[c].getAddressSpace()})?(g=b,!0):!1}),g)a.redispatch(g.flowFrame),b=a.getTarget(),d=a.getFrame();else{if(1!==d.uses){var h=cloneFunction(d.ast);d.root.adrSpecStore||(d.root.adrSpecStore=[d.root]),d.root.adrSpecStore.push(h),a.redispatch(h.flowFrame),b=a.getTarget(),d=a.getFrame()}b.setAddressSpace(e),d._flowVisited=!0,resetAddressSpaces(d.ast.flowRoots),propagateAddressSpaces(d.ast.flowRoots)}}d.result.hasAddressSpace()&&c(a.getCall().result,d.result.getAddressSpace())}else c(a,e)})}}function insertSpecialisations(a,b){a.type===FUNCTION||reportBug("unexpected node found"),a.adrSpecStore&&(b||reportBug("fun specs found but no target to insert into"),a.adrSpecStore.forEach(function(a,c){c>0&&a.flowFrame.uses>0&&b.push(a)})),a.body.funDecls.forEach(function(b){insertSpecialisations(b,a.body.funDecls)})}function analyze(a,b,c,d,e,f){var g=new TEnv(rootEnvironment,!0),h=a.params,i=[];if(0===stackTrace.length||(stackTrace=[]),openCLUseLowPrecision=f===!0,g.openCLFloatType=openCLUseLowPrecision?"float":"double","combine"===c||"map"===c){var j=TObject.makeType(TObject.PARALLELARRAY,b);j.properties.addressSpace="__global",g.bind("this"),g.update("this",j),g.addRoot(j),i.push(j)}if("combine"===c||"comprehension"===c){var k=new TObject(TObject.ARRAY);k.properties.shape=[d],k.properties.elements=new TLiteral(TLiteral.NUMBER),k.updateOpenCLType(),k.properties.addressSpace="__private",g.bind(h[0]),g.update(h[0],k),g.addRoot(k),h=h.slice(1),i.push(k)}else if("comprehensionScalar"===c){var k=new TLiteral(TLiteral.NUMBER);g.bind(h[0]),g.update(h[0],k),h=h.slice(1),i.push(k)}else if("map"===c){var l=g.getType("this").clone();b.getShape().length>d?l.properties.shape=l.properties.shape.slice(d):l=l.properties.elements,g.bind(h[0]),g.update(h[0],l),!l.isObjectType()||g.addRoot(l),h=h.slice(1),i.push(l)}h.length===e.length||reportError("number of arguments does not match number of parameters: "+e.length+" vs. "+h.length),h.forEach(function(a){g.bind(a)}),h.forEach(function(a,b){var c=typeOracle(e[b]);g.update(a,c),c.isObjectType()&&g.addRoot(c),i.push(c)}),a.body=drive(a.body,g,void 0);var m=new TFunction(i,g.functionResult);return a.typeInfo=m,a.symbols=g,propagateAddressSpaces(g.getRoots()),insertSpecialisations(a),a}var stackTrace=[],definitions=Narcissus.definitions;eval(definitions.consts),eval(RiverTrail.definitions.consts);var inferPAType=RiverTrail.Helper.inferPAType,nameGen=RiverTrail.Helper.nameGen;const debug=!1,allowGlobalFuns=!0,lazyJSArrayCheck=!0;var openCLUseLowPrecision=!1,reportBug=RiverTrail.Helper.reportBug,cloneFunctionNoTypes=RiverTrail.Helper.cloneFunction(!0),cloneFunction=RiverTrail.Helper.cloneFunction(!1),labelGen=function(){var a=0;return function(){return a++}}(),Type=function(a){this.kind=a,this.label=labelGen()};Type.OBJECT="OBJECT",Type.LITERAL="LITERAL",Type.FUNCTION="FUNCTION",Type.BOTTOM="BOTTOM";var Tp=Type.prototype;Tp.toString=function(){return"<general type>"},Tp.equals=function(a){return this.kind===a.kind},Tp.isArithType=function(){return this.kind===Type.LITERAL&&(this.type===TLiteral.NUMBER||this.type===TLiteral.BOOL)},Tp.isNumberType=function(){return this.kind===Type.LITERAL&&this.type===TLiteral.NUMBER},Tp.isTruthType=function(){return this.kind===Type.LITERAL&&(this.type===TLiteral.NUMBER||this.type===TLiteral.BOOL)},Tp.isBoolType=function(){return this.kind===Type.LITERAL&&this.type===TLiteral.BOOL},Tp.isScalarType=function(){return this.kind===Type.LITERAL&&(this.type===TLiteral.BOOL||this.type===TLiteral.NUMBER)},Tp.isObjectType=function(a){return this.kind===Type.OBJECT&&(void 0===a||this.name===a)},Tp.isArrayishType=function(){return this.isObjectType(TObject.ARRAY)||this.isObjectType(TObject.JSARRAY)||this.isObjectType(TObject.PARALLELARRAY)},Tp.isBottomType=function(){return this.kind===Type.BOTTOM},Tp.registerFlow=function(a){(a.flowTo||(a.flowTo=[])).push(this)},Tp.registerParamFlow=function(a){(this.flowTo||(this.flowTo=[])).push(a)},Tp.getOpenCLShape=function(){return[]},Tp.getOpenCLSize=function(){reportBug("size of type not known:"+this.kind)},Tp.getOpenCLAddressSpace=function(){return""},Tp.hasAddressSpace=function(){return void 0!==this.getAddressSpace()},Tp.getAddressSpace=function(){return void 0},Tp.setAddressSpace=function(){};var TLiteral=function(a){switch(this.type=a,a){case TLiteral.NUMBER:this.OpenCLType=openCLUseLowPrecision?"float":"double";break;case TLiteral.BOOL:this.OpenCLType="bool";break;case TLiteral.STRING:this.OpenCLType="char *";break;default:reportBug("unknown type for literal "+a)}this.label=labelGen()};TLiteral.NUMBER="NUMBER",TLiteral.STRING="STRING",TLiteral.BOOL="BOOL";var TLp=TLiteral.prototype=new Type(Type.LITERAL);TLp.toString=function(){return"Literal: "+this.type+"<"+this.OpenCLType+">"},TLp.equals=function(a,b){return this.constructor.prototype.equals.call(this,a,b)&&this.type===a.type&&(!b||this.OpenCLType===a.OpenCLType)},TLp.clone=function(a){var b;return a&&(b=a[this.label])?b:(b=new TLiteral(this.type),b.OpenCLType=this.OpenCLType,a&&(a[this.label]=b),b)},TLp.getOpenCLSize=function(){switch(this.OpenCLType){case"signed char":case"unsigned char":case"unsigned /* clamped */ char":return 1;case"short":case"unsigned short":return 2;case"float":case"int":case"unsigned int":return 4;case"double":return 8;default:reportBug("size of type not known:"+this.OpenCLType)}};var TFunction=function(a,b){this.parameters=a,this.result=b,this.label=labelGen()},TFp=TFunction.prototype=new Type(Type.FUNCTION);TFp.toString=function(){for(var a="(",b=0;b<this.parameters.length;b++)a=a+(b>0?", ":"")+this.parameters[b].toString();return a=a+") -> "+this.result.toString()},TFp.equals=function(a,b,c){return this.constructor.prototype.equals.call(this,a,c)&&(b||this.result.equals(a.result,c))&&this.parameters.length===a.parameters.length&&this.parameters.every(function(b,d){return b.equals(a.parameters[d],c)})},TFp.clone=function(a){var b;return a&&(b=a[this.label])?b:(b=new TFunction(this.parameters,this.result),a&&(a[this.label]=b),b.parameters=b.parameters.map(function(b){return b.clone(a)}),b.result=b.result.clone(a),b)};var TObject=function(a){this.name=a,this.properties={},this.properties.__proto__=null,this.label=labelGen()};TObject.ARRAY="Array",TObject.JSARRAY="JSArray",TObject.PARALLELARRAY="ParallelArray",TObject.INLINEOBJECT="InlineObject",TObject.makeType=function(a,b){return this.prototype.registry[a].makeType(b)},TObject.deriveObjectType=function(a){var b,c,d=function(b){return a instanceof b};for(c in this.prototype.registry)if(void 0!==this.prototype.registry[c].constructor&&a instanceof this.prototype.registry[c].constructor||void 0!==this.prototype.registry[c].constructors&&this.prototype.registry[c].constructors.some(d)){b=c;break}return b};var TOp=TObject.prototype=new Type(Type.OBJECT);TOp.registry={},TOp.registry.__proto__=null,TOp.toString=function(){var a="Object: "+this.name+"[";for(var b in this.properties)a=a+b+":"+(this.properties[b]?this.properties[b].toString():"undefined")+", ";return a+="]",a=a+"<"+this.OpenCLType+">"},TOp.equals=function(a,b){return this.constructor.prototype.equals.call(this,a,b)&&this.name===a.name&&this.registry[this.name].equals.call(this,a,b)},TOp.clone=function(a){var b;if(a&&(b=a[this.label]))return b;if(b=new TObject(this.name),a&&(a[this.label]=b),this.properties.fields){b.properties.fields={};for(var c in this.properties.fields)b.properties.fields[c]=this.properties.fields[c].clone(a)}else this.properties.elements&&(b.properties.elements=this.properties.elements.clone(a));return b.properties.shape=this.properties.shape,b.OpenCLType=this.OpenCLType,b.properties.addressSpace=this.properties.addressSpace,b},TOp.updateOpenCLType=function(){this.getHandler().updateOpenCLType.call(this)},TOp.getHandler=function(){return this.registry[this.name]||reportBug("No object handler for class `"+this.name+"`")},TOp.getOpenCLShape=function(){return this.getHandler().getOpenCLShape.call(this)||[]},TOp.getOpenCLSize=function(){return this.getHandler().getOpenCLSize.call(this)||reportBug("unknown OpenCL size for object: "+this.name)},TOp.getOpenCLAddressSpace=function(){return this.properties.addressSpace||""},TOp.getAddressSpace=function(){return this.properties.addressSpace},TOp.setAddressSpace=function(a){return this.registry[this.name].setAddressSpace?this.registry[this.name].setAddressSpace.call(this,a):void(this.properties.adressSpace=a)};var TBottom=function(){this.label=labelGen()},TBp=TBottom.prototype=new Type(Type.BOTTOM);TBp.equals=function(){return!1};var TEnv=function(a,b){this.parent=a,this.bindings={},this.bindings.__proto__=null,this._accu=null,b&&(this._functionResult=null,this._roots=[]),this.openCLFloatType=a?a.openCLFloatType:void 0},TEp=TEnv.prototype;TEp.lookup=function(a){return void 0!==this.bindings[a]?this.bindings[a]:this.parent&&this.parent.lookup(a)||void 0},TEp.getType=function(a){var b=this.lookup(a);return b?b.type:void 0},TEp.bind=function(a,b){a instanceof Array?a.forEach(this.bind):(b||void 0===this.bindings[a])&&(this.bindings[a]={initialized:!1,type:null})},TEp.update=function(a,b){var c=this.lookup(a);if(void 0===c)reportError("variable "+a+" has not been previously declared!");else if(null===c.type){var d=b.clone();d.registerFlow(b),this.bindings[a]={initialized:!0,type:d}}else c.type.equals(b)?(c.type.registerFlow(b),c.initialized=!0):reportError("variable "+a+" is polymorphic: "+c.type.toString()+"/"+b.toString())},TEp.intersect=function(a){for(var b in this.bindings){var c=this.bindings[b],d=a.bindings[b];void 0===d?this.bindings[b].initialized=!1:(c.type.equals(d.type)||reportError("variable "+b+" is polymorphic: "+c.type.toString()+"/"+d.type.toString()),c.type.registerFlow(d.type))}for(var b in a.bindings)void 0===this.bindings[b]&&(this.bindings[b]={initialized:!1,type:a.bindings[b].type},this.bindings[b].type.registerFlow(a.bindings[b].type))},TEp.merge=function(a){for(var b in a.bindings){var c=a.bindings[b];this.bindings[b]={initialized:c.initialized,type:c.type.clone()},this.bindings[b].type.registerFlow(c.type)}},TEp.tagAllUnitialized=function(){for(var a in this.bindings)this.bindings[a].initialized=!1},TEp.toString=function(){var a="";for(var b in this.bindings)a=a+(""===a?"":", ")+b+" => "+this.bindings[b].type.toString();return"{{"+a+"}}"},TEp.__defineGetter__("accu",function(){return this._accu||null}),TEp.__defineSetter__("accu",function(a){this._accu=a}),TEp.resetAccu=function(){this._accu=null},TEp.__defineGetter__("functionResult",function(){return void 0!==this._functionResult?this._functionResult:parent.functionResult}),TEp.__defineSetter__("functionResult",function(a){a&&(void 0===this._functionResult?this.parent.functionResult=a:null===this._functionResult?(this._functionResult=a.clone(),this._functionResult.registerFlow(a)):(this._functionResult.equals(a)||reportError("function has polymorphic return type"),this._functionResult.registerFlow(a)))}),TEp.addRoot=function(a){return this._roots?void this._roots.push(a):this.parent.addRoot(a)},TEp.getRoots=function(){return this._roots?this._roots:this.parent.getRoots()},TEp.emitDeclarations=function(a){var b="";for(var c in this.bindings){var d=this.bindings[c].type;d&&(b=b+" "+d.getOpenCLAddressSpace()+" "+d.OpenCLType+" "+(a?a(c):c)+"; ")}return b};var rootEnvironment=new TEnv;rootEnvironment.bind("Math"),rootEnvironment.update("Math",new TObject("Math")),TOp.registry.Math={methodCall:function(a,b,c,d,e){var f;e.children[1]=drive(e.children[1],c,d);var g=c.accu;switch(c.resetAccu(),b){case"abs":case"acos":case"asin":case"atan":case"ceil":case"cos":case"exp":case"floor":case"log":case"round":case"sin":case"sqrt":case"tan":1===g.length||reportError("too many arguments for Math."+b,e),g[0].isArithType()||reportError("argument to Math."+b+" is not a number (found "+argTypes[0].toString()+")",e),f=new TLiteral(TLiteral.NUMBER);break;case"atan2":case"pow":2===g.length||reportError("too many arguments for Math."+b,e),g[0].isArithType()||reportError("first argument to Math."+b+" is not a number (found "+argTypes[0].toString()+")",e),g[1].isArithType()||reportError("second argument to Math."+b+" is not a number (found "+argTypes[1].toString()+")",e),f=new TLiteral(TLiteral.NUMBER);break;case"max":case"min":g.forEach(function(a,c){a.isArithType()||reportError("argument "+(c+1)+" to Math."+b+" is not a number",e)}),f=new TLiteral(TLiteral.NUMBER);break;case"random":0===g.length||reportError("too many arguments for Math."+b,e),f=new TLiteral(TLiteral.NUMBER);break;default:reportError("Method `"+b+"` of global Math object not supported",e)}return f},propertySelection:function(a,b,c,d){var e;switch(a){case"E":case"LN2":case"LN10":case"LOG2E":case"PI":case"SQRT1_2":case"SQRT2":e=new TLiteral(TLiteral.NUMBER);break;default:reportError("unknown property `Math."+a+"`",d)}return e},constructor:void 0,makeType:null,updateOpenCLType:null,equals:null},TOp.registry.InlineObject={methodCall:function(){reportError("Methods not supported on Objects")},propertySelection:function(a,b,c,d){var e=d.children[0].typeInfo.properties.fields;for(var f in e)if(a===f)return e[f];reportError("Could not find property",a,"in Object")},makeType:function(){var a=new TObject(TObject.INLINEOBJECT);return a.updateOpenCLType(),a},getOpenCLSize:function(){},updateOpenCLType:function(){},setAddressSpace:function(a){this.properties.addressSpace=a},constructor:void 0,equals:function(a,b){if("OBJECT"!==a.kind||"InlineObject"!==a.name)return!1;var c=this.properties.fields,d=a.properties.fields;if(void 0===d)return!1;if(d.length!==c.length)return!1;for(var e in c){if(!d.hasOwnProperty(e))return!1;if(!c[e].equals(d[e],b))return!1}return!0}},TOp.registry[TObject.ARRAY]={methodCall:function(a,b,c,d,e){switch(b){case"pop":case"push":case"shift":case"unshift":case"reverse":case"sort":case"splice":case"concat":case"join":case"slice":reportError("method `"+b+"` not yet implemented on array objects",e);break;default:reportError("method `"+b+"` not supported on array objects",e)}},propertySelection:function(a,b,c,d){var e;switch(a){case"length":e=new TLiteral(TLiteral.NUMBER);break;default:reportError("unknown array property `"+a+"`",d)}return e},constructor:void 0,constructors:[Float64Array,Float32Array,Uint32Array,Int32Array,Uint16Array,Int16Array,Uint8ClampedArray,Uint8Array,Int8Array,RiverTrail.Helper.FlatArray],makeType:function(a){var b;if("number"==typeof a)b=new TLiteral(TLiteral.NUMBER);else if(a instanceof RiverTrail.Helper.FlatArray){b=new TLiteral(TLiteral.NUMBER),b.OpenCLType=RiverTrail.Helper.inferTypedArrayType(a.data);for(var c=a.shape.length-1;c>=0;c--){var d=new TObject(TObject.ARRAY);d.properties.shape=[a.shape[c]],d.properties.elements=b,b=d,b.updateOpenCLType()}}else RiverTrail.Helper.isTypedArray(a)?(b=new TObject(TObject.ARRAY),b.properties.shape=[a.length],b.properties.elements=new TLiteral(TLiteral.NUMBER),b.properties.elements.OpenCLType=RiverTrail.Helper.inferTypedArrayType(a),b.updateOpenCLType()):reportError("unsupported array contents encountered");return b},updateOpenCLType:function(){var a=this.properties.elements;a instanceof TLiteral?this.OpenCLType=this.properties.elements.OpenCLType+"*":"__private"===a.properties.addressSpace&&(a.isObjectType(TObject.ARRAY)||a.isObjectType(TObject.PARALLELARRAY))?this.OpenCLType=a.OpenCLType+"*":a.isObjectType(TObject.ARRAY)||a.isObjectType(TObject.PARALLELARRAY)?this.OpenCLType=a.OpenCLType:a.isObjectType("InlineObject")?this.OpenCLType=a.OpenCLType+"*":reportBug("unhandled element type in Array")},getOpenCLShape:function(){return this.properties.shape.concat(this.properties.elements.getOpenCLShape())},getOpenCLSize:function(){return this.properties.shape.reduce(function(a,b){return a*b},1)*this.properties.elements.getOpenCLSize()},equals:function(a,b){return this.properties.shape.length===a.properties.shape.length&&this.properties.shape.every(function(b,c){return b===a.properties.shape[c]})&&this.properties.elements.equals(a.properties.elements,b)},setAddressSpace:function(a){this.properties.addressSpace=a,this.properties.elements.setAddressSpace(a)}},TOp.registry[TObject.JSARRAY]={methodCall:TOp.registry[TObject.ARRAY].methodCall,propertySelection:TOp.registry[TObject.ARRAY].propertySelection,constructor:Array,makeType:function(a){var b;if("number"==typeof a)b=new TLiteral(TLiteral.NUMBER),b.OpenCLType="double";else if(a instanceof Array){if(b=new TObject(TObject.JSARRAY),b.properties.shape=[a.length],a.length>0){b.properties.elements=this.makeType(a[0])}else reportError("empty arrays are not supported yet");b.updateOpenCLType()}else reportError("unsupported array contents encountered");return b},updateOpenCLType:function(){this.OpenCLType="/* jsval */ double*"},getOpenCLShape:TOp.registry[TObject.ARRAY].getOpenCLShape,getOpenCLSize:TOp.registry[TObject.ARRAY].getOpenCLSize,equals:TOp.registry[TObject.ARRAY].equals,setAddressSpace:TOp.registry[TObject.ARRAY].setAddressSpace},TOp.registry[TObject.PARALLELARRAY]={methodCall:function(a,b,c,d,e){"use strict";var f;e.children[1]=drive(e.children[1],c,d);var g=c.accu;switch(c.resetAccu(),b){case"get":var h;1==g.length&&(g[0].isObjectType(TObject.ARRAY)||g[0].isObjectType(TObject.PARALLELARRAY))?(g[0].isObjectType(TObject.ARRAY)||reportError("invalid index in get call",e),1===g[0].properties.shape.length||reportError("only vectors and scalars are allowed as indices in get",e),g[0].properties.shape[0]<=a.properties.shape.length||reportError("index vector too long",e),h=g[0].properties.shape[0]):(g.every(function(a){return a.isArithType()})||reportError("indices in call to get on parallel array are not numbers",e),g.length<=a.properties.shape.length||reportError("too many indices in get call",e),h=g.length),h===a.properties.shape.length?(f=a.properties.elements.clone(),f.isNumberType()&&(f._castRequired=new TLiteral(TLiteral.NUMBER))):(f=new TObject(TObject.PARALLELARRAY),f.properties.shape=a.properties.shape.slice(h),f.properties.addressSpace=a.properties.addressSpace,f.properties.elements=a.properties.elements.clone(),f.updateOpenCLType()),f.registerFlow(a),f.isScalarType()||(f.properties.isShared=!0);break;case"getShape":0===g.length||reportError("too many argument to getShape"),f=new TObject(TObject.ARRAY),f.properties.shape=[a.properties.shape.length],f.properties.elements=new TLiteral(TLiteral.NUMBER),f.properties.addressSpace="__private",f.updateOpenCLType(),c.addRoot(f);break;case"concat":case"join":case"slice":case"combine":case"map":case"reduce":case"filer":case"scatter":reportError("method `"+b+"` not yet implemented for parallel array objects",e);default:reportError("method `"+b+"` not supported for parallel array objects",e)}return f},propertySelection:function(a,b,c,d){var e;switch(a){case"length":e=new TLiteral(TLiteral.NUMBER);break;default:reportError("unknown parallel array property `"+a+"`",d)}return e},constructor:ParallelArray,makeType:function(a){var b=new TObject(TObject.PARALLELARRAY);return b.properties.shape=a.getShape(),b.properties.elements=new TLiteral(TLiteral.NUMBER),b.properties.elements.OpenCLType=inferPAType(a).inferredType,b.updateOpenCLType(),b},updateOpenCLType:function(){this.OpenCLType=this.properties.elements.OpenCLType+"*"},getOpenCLShape:function(){return this.properties.shape.concat(this.properties.elements.getOpenCLShape())},getOpenCLSize:function(){return this.properties.shape.reduce(function(a,b){return a*b},1)*this.properties.elements.getOpenCLSize()},equals:function(a,b){return this.properties.shape.length===a.properties.shape.length&&this.properties.shape.every(function(b,c){return b===a.properties.shape[c]})&&this.properties.elements.equals(a.properties.elements,b)},setAddressSpace:function(a){this.properties.addressSpace=a,this.properties.elements.setAddressSpace(a)}};var FEnv=function(a){this.parent=a,this.bindings={},this.bindings.__proto__=null},FEp=FEnv.prototype;FEp.lookup=function(a){return this.bindings[a]||this.parent&&this.parent.lookup(a)||void 0},FEp.add=function(a,b,c){if(c&&this.parent)this.parent.add(a,b,c);else{var d=b||a.name||reportBug("unnamed functions cannot be added to environment");void 0!==this.bindings[d]&&reportError("functions need to be uniquely defined within a scope",a),this.bindings[d]=a}},FEp.toFunDecls=function(){var a,b=[];for(var c in this.bindings)a=this.bindings[c],a.specStore&&a.specStore.forEach(function(a){b.push(a)});return b};var FlowNode=function(){return this},FFunction=function(a,b,c,d){this.params=a,this.result=b,this.root=c,this.ast=d||c,this.uses=0,this.label=labelGen()};FFunction.prototype=new FlowNode;var FCall=function(a,b,c,d){this.params=a,this.frame=b,this.result=c,this.ast=d,this.label=labelGen()};FCall.prototype=new FlowNode;var FParam=function(a,b){this.number=a,this.call=b,this.label=labelGen()},FPp=FParam.prototype=new FlowNode;return FPp.getTarget=function(){return this.call.frame.params[this.number]},FPp.getFrame=function(){return this.call.frame},FPp.redispatch=function(a){this.call.frame.uses--,this.call.frame=a,this.call.frame.uses++,this.call.ast.children[0].dispatch=this.call.frame.ast.dispatch},FPp.getCall=function(){return this.call},{analyze:analyze,Type:Type,TLiteral:TLiteral,TObject:TObject,TFunction:TFunction,FlowNode:FlowNode,FFunction:FFunction,FParam:FParam,FCall:FCall,typeOracle:typeOracle}}(),RiverTrail.RangeAnalysis=function(){function eraseRangeInfo(a){RiverTrail.Helper.traverseAst(a,function(a){return delete a.rangeInfo,a})}function annotateRangeInfo(a,b,c){c?a.rangeInfo=b:b&&void 0!==a.rangeInfo&&(a.rangeInfo instanceof RangeArray?a.rangeInfo.setInt(b):a.rangeInfo.isInt=b instanceof RangeArray?b.isInt():b.isInt)}function computeRootRangeInfo(a,b){var c,d,e;switch(a.type){case INDEX:if(expr=a.children[0],c=a.children[1],c.rangeInfo.fixedValue()){var e=expr.rangeInfo.clone();e instanceof RangeArray?e.set(c.rangeInfo.lb,b.clone()):e=new Range(void 0,void 0,!1)}else e=new Range(void 0,void 0,!1);d=computeRootRangeInfo(expr,e);break;case IDENTIFIER:d=b;break;default:throw"unexpected node in computeRootRangeInfo. TI must have let something pass that it should not!"}return d}function computeBinaryRange(a,b,c,d,e,f,g,h){var i;switch(a){case INCREMENT:case PLUS:var j=drive(b,d,e);if(c)var k=drive(c,d,e);else var k=new Range(1,1,!0);i=j.map(k,function(a,b){return a+b},j.isInt&&k.isInt),c||d.update(b.value,i);break;case DECREMENT:case MINUS:var j=drive(b,d,e);if(c)var k=drive(c,d,e);
else var k=new Range(1,1,!0);i=j.cross(k,function(a,b){return a-b},j.isInt&&k.isInt),c||d.update(b.value,i);break;case MUL:var j=drive(b,d,e),k=drive(c,d,e),l=Math.min(j.lb*k.lb,j.ub*k.lb,j.lb*k.ub,j.ub*k.ub),m=Math.max(j.lb*k.lb,j.ub*k.lb,j.lb*k.ub,j.ub*k.ub);i=new Range(isNaN(l)?void 0:l,isNaN(m)?void 0:m,j.isInt&&k.isInt);break;case DIV:var j=drive(b,d,e),k=drive(c,d,e);if(void 0!==j.lb&&void 0!==j.ub&&Math.abs(k.lb)>=1&&Math.abs(k.ub)>=1){var l=Math.min(j.lb/k.lb,j.ub/k.lb,j.lb/k.ub,j.ub/k.ub),m=Math.max(j.lb/k.lb,j.ub/k.lb,j.lb/k.ub,j.ub/k.ub);i=new Range(isNaN(l)?void 0:l,isNaN(m)?void 0:m,!1)}else i=new Range(void 0,void 0,!1);break;case EQ:case NE:case STRICT_EQ:case STRICT_NE:case LT:case LE:case GE:case GT:var k=drive(c,d,e,f,void 0,h),j=drive(b,d,e,f,{type:a,range:k,inverse:h},h);i=new Range(0,1,!0);break;case BITWISE_OR:case BITWISE_XOR:case BITWISE_AND:case LSH:case RSH:case URSH:case MOD:var j=drive(b,d,e),k=drive(c,d,e);i=new Range(void 0,void 0,!1);break;case AND:case OR:if(a===AND&&!h||a===OR&&h)drive(b,d,e,f,void 0,h),drive(c,d,e,f,void 0,h);else{var n=new Constraints;drive(b,d,e,n,void 0,h);var o=new Constraints;drive(c,d,e,o,void 0,h),n.intersect(o),f.merge(n)}i=new Range(0,1,!0);break;case NOT:drive(b,d,e,f,void 0,!h),i=new Range(0,1,!0);break;case UNARY_PLUS:i=drive(b,d,e);break;case UNARY_MINUS:var j=drive(b,d,e);i=new Range(void 0===j.ub?void 0:-j.ub,void 0===j.lb?void 0:-j.lb,j.isInt);break;case BITWISE_NOT:drive(b,d,e),i=new Range(void 0,void 0,!1);break;default:i=new Range(void 0,void 0,!1)}return i}function drive(a,b,c,d,e,f){var g;switch(a||reportBug("malformed syntax tree encountered.",a),a.type||reportBug("missing type information in syntax tree.",a),a.type){case SCRIPT:b=new VarEnv(b),a.rangeSymbols=b,intraFun||a.funDecls.forEach(function(a){var b=new VarEnv;a.params.forEach(function(a){b.update(a,new Range(void 0,void 0,!1))}),drive(a.body,b,!0)});case BLOCK:a.children.forEach(function(a){drive(a,b,c)});break;case FUNCTION:break;case RETURN:drive(a.value,b,c),g=new Range(void 0,void 0,!1),function y(a){a.type===ARRAY_INIT?a.children.forEach(y):a.type!==IDENTIFIER||a.typeInfo.isScalarType()||(b.lookup(a.value).forceInt(!1),a.rangeInfo=b.lookup(a.value))}(a.value);break;case DO:drive(a.body,b,c);case FOR:a.setup&&drive(a.setup,b,c);case WHILE:var h=new Constraints,i=new VarEnv(b);drive(a.condition,i,c,h);var j=new VarEnv(b);j.enforceConstraints(h),drive(a.body,j,c),a.update&&drive(a.update,j,c);var k=new VarEnv(j);k.enforceConstraints(h),drive(a.body,k,!1),a.update&&drive(a.update,k,!1),j.covers(k)&&i.isEmpty()?drive(a.condition,j,c):(j.invalidate(),i.invalidate(),j.merge(i),drive(a.condition,j,c),drive(a.body,j,c),a.update&&drive(a.update,j,c)),b.merge(j);break;case IF:var l=new Constraints;drive(a.condition,b,c,l);var m=new VarEnv(b);m.applyConstraints(l),drive(a.thenPart,m,c);var n=new Constraints;drive(a.condition,b,c,n,void 0,!0);var o=new VarEnv(b);o.applyConstraints(n),a.elsePart&&drive(a.elsePart,o,c),m.merge(o),b.updateAll(m);break;case SEMICOLON:g=a.expression?drive(a.expression,b,c):new Range(void 0,void 0,!1);break;case VAR:case CONST:a.children.forEach(function(a){a.initializer&&b.update(a.value,drive(a.initializer,b,c)),annotateRangeInfo(a,b.lookup(a.value),c)});break;case ASSIGN:drive(a.children[0],b,c);var p=drive(a.children[1],b,c);switch(a.assignOp&&(p=computeBinaryRange(a.assignOp,a.children[0],a.children[1],b,c,d,e,f)),a.children[0].type){case IDENTIFIER:b.update(a.children[0].value,p),annotateRangeInfo(a.children[0],p.clone(),c),g=p;break;case INDEX:var q=computeRootRangeInfo(a.children[0],p),r=findSelectionRoot(a.children[0]);b.update(r.value,q),g=p;case DOT:break;default:reportBug("unhandled lhs in assignment")}break;case COMMA:a.children.forEach(function(a){g=drive(a,b,c,d,e)});break;case HOOK:var l=new Constraints;drive(a.children[0],b,c,l);var m=new VarEnv(b);m.applyConstraints(l),left=drive(a.children[1],m,c);var n=new Constraints;drive(a.children[0],b,c,n,void 0,!0);var o=new VarEnv(b);o.applyConstraints(n),p=drive(a.children[2],o,c),m.merge(o),b.updateAll(m),g=left.union(p);break;case INCREMENT:case PLUS:case DECREMENT:case MINUS:case MUL:case DIV:case EQ:case NE:case STRICT_EQ:case STRICT_NE:case LT:case LE:case GE:case GT:case BITWISE_OR:case BITWISE_XOR:case BITWISE_AND:case LSH:case RSH:case URSH:case MOD:case AND:case OR:case NOT:case UNARY_PLUS:case UNARY_MINUS:case BITWISE_NOT:g=computeBinaryRange(a.type,a.children[0],a.children[1],b,c,d,e,f);break;case IDENTIFIER:case THIS:e&&d&&d.addAccu(a.value,e),g=b.lookup(a.value)||new Range(void 0,void 0,!1);break;case DOT:drive(a.children[0],b,c),g="length"===a.children[1].value&&a.children[0].typeInfo.isArrayishType()?new Range(a.children[0].typeInfo.properties.shape[0],a.children[0].typeInfo.properties.shape[0],!0):new Range(void 0,void 0,!1);break;case NUMBER:g=new Range(a.value,a.value,Math.floor(a.value)===a.value);break;case TRUE:g=new Range(1,1,!0);break;case FALSE:g=new Range(0,0,!0);break;case INDEX:var s=drive(a.children[1],b,c),t=drive(a.children[0],b,c);s.fixedValue()&&(e&&d&&a.children[0].type===IDENTIFIER&&d.addAccu(a.children[0].value,e,s.lb,a.children[0].typeInfo.properties.shape[0]),t&&t instanceof RangeArray&&(g=t.get(s.lb))),g||(g=new Range(void 0,void 0,!1));break;case ARRAY_INIT:g=new RangeArray(a.children,function(a){return drive(a,b,c)});break;case CALL:switch(drive(a.children[0],b,c),drive(a.children[1],b,c),a.children[0].type){case DOT:var u=a.children[0];if("RiverTrailUtils"===u.children[0].value&&"createArray"===u.children[1].value){g=new Range(void 0,void 0,!1);break}g=u.children[0].typeInfo.isObjectType("ParallelArray")&&"getShape"===u.children[1].value?new RangeArray(u.children[0].typeInfo.properties.shape,function(a){return new Range(a,a,!0)}):new Range(void 0,void 0,!1);break;default:if(a.children[1].children.forEach(function(a){a.type===IDENTIFIER&&b.lookup(a.value).forceInt(!1)}),intraFun)if(a.callFrame){var v=a.callFrame.frame.ast;if(!v.rangeUpdate||v.rangeUpdate<maxRangeUpdates){debug&&console.log("inferring/updating range information for "+v.dispatch);var w=new VarEnv,x=!1;v.paramRanges||(v.paramRanges=[]),v.params.forEach(function(b,c){if(v.paramRanges[c]){var d=v.paramRanges[c],e=d.union(a.children[1].children[c].rangeInfo);d.covers(e)||(x=!0,v.paramRanges[c]=e)}else x=!0,v.paramRanges[c]=a.children[1].children[c].rangeInfo.clone();w.update(b,v.paramRanges[c])}),x&&(v.rangeUpdate=(v.rangeUpdate||0)+1,drive(v.body,w,!0))}else if(v.rangeUpdate==maxRangeUpdates){debug&&console.log("neutralizing range information for "+v.dispatch);var w=new VarEnv;v.params.forEach(function(a,b){v.paramRanges[b]=new Range(void 0,void 0,!1),w.update(a,v.paramRanges[b])}),drive(v.body,w,!0),v.rangeUpdate++}g=new Range(void 0,void 0,!1)}else debug&&console.log("missing callFrame"),g=new Range(void 0,void 0,!1);else g=new Range(void 0,void 0,!1)}break;case LIST:g=new RangeArray(a.children,function(a){return drive(a,b,c)});break;case CAST:drive(a.children[0],b,c),g=new Range(void 0,void 0,!1);break;case FLATTEN:drive(a.children[0],b,c),g=a.children[0].rangeInfo.clone();break;case GETTER:case SETTER:reportError("setters/getters not yet implemented",a);break;case TRY:case THROW:reportError("try/throw/catch/finally not yet implemented",a);break;case BREAK:case CONTINUE:case LABEL:reportError("break/continure)/labels not yet implemented",a);break;case YIELD:case GENERATOR:reportError("generators/yield not yet implemented",a);break;case FOR_IN:reportError("for .. in loops not yet implemented",a);break;case ARRAY_COMP:case COMP_TAIL:reportError("array comprehensions not yet implemented",a);break;case NEW:case NEW_WITH_ARGS:case OBJECT_INIT:g=new Range(void 0,void 0,!1);break;case WITH:reportError("general objects not yet implemented",a);break;case LET:case LET_BLOCK:reportError("let not yet implemented",a);break;case SWITCH:reportError("switch not yet implemented",a);break;case INSTANCEOF:reportError("instanceof not yet implemented",a);break;case EQ:case NE:reportError("non-strict equality not yet implemented",a);break;case IN:reportError("in not yet implemented",a);break;case NULL:reportError("null not yet implemented",a);break;case REGEXP:reportError("regular expressions not yet implemented",a);break;case STRING:reportError("strings not yet implemented",a);break;case DEBUGGER:default:throw"unhandled node type in analysis: "+a.type}return annotateRangeInfo(a,g,c),debug&&g&&console.log(RiverTrail.Helper.wrappedPP(a)+" has range "+g.toString()),debug&&a.type===SCRIPT&&(console.log("overall range map for SCRIPT node: "+a.rangeSymbols.toString()),console.log("overall type map for SCRIPT node: "+a.symbols.toString())),g}function specToRange(a){switch(a.type){case"number":return new Range(a.val,a.val,(0|a.val)===a.val);case"array":return new RangeArray(a.val,function(a){return new Range(a,a,(0|a)===a)});case"flatarray":if(1===a.val.shape.length)return new RangeArray(a.val.data,function(a){return new Range(a,a,(0|a)===a)});default:return new Range(void 0,void 0,!1)}}function analyze(a,b,c,d,e,f){var g=new VarEnv,h=0;if("combine"===c){var i=b.getShape().slice(0,d),j=new RangeArray(i,function(a){return new Range(0,a-1,!0)});g.update(a.params[0],j),h=1}else if("comprehension"===c){var j=new RangeArray(d,function(a){return new Range(0,a-1,!0)});g.update(a.params[0],j),h=1}else if("comprehensionScalar"===c){var j=new Range(0,d[0]-1,!0);g.update(a.params[0],j),h=1}a.params.forEach(function(a,b){b>=h&&(f&&f[b-h]?g.update(a,specToRange(f[b-h])):g.update(a,new Range(void 0,void 0,!1)))});try{drive(a.body,g,!0)}catch(k){if(k instanceof TypeError||k instanceof ReferenceError)throw k;console.log("range analysis failed: "+k.toString())}return a.rangeSymbols=g,debug&&console.log(g.toString()),a}function validIntRepresentation(a){return a=stripToBaseType(a),"int"===a||"bool"===a}function isIntValue(a){return a.rangeInfo&&(a.rangeInfo instanceof RangeArray?a.rangeInfo.isInt():a.rangeInfo.isInt)}function updateToNew(a,b,c){debug&&console.log("updating "+(c?c+"::":"")+a.toString()+" to "+b),a.isNumberType()?a.OpenCLType=b:a.isArrayishType()?(updateToNew(a.properties.elements,b,c),a.updateOpenCLType()):a.isBoolType()||reportBug("update to new called on unsupported type")}function makeCast(a,b){if(debug&&console.log("casting "+RiverTrail.Helper.wrappedPP(a)+" to "+b),a.type===CAST)return makeCast(a.children[0],b);if(a.type===ARRAY_INIT)return a.children.map(function(a){return makeCast(a,b)}),updateToNew(a.typeInfo,b),a;var c=new Narcissus.parser.Node(a.tokenizer);return c.type=CAST,c.typeInfo=a.typeInfo.clone(),updateToNew(c.typeInfo,b),c.children=[a],c}function adaptStatusToRoot(a,b){var c=!1;switch(a.type){case IDENTIFIER:c=validIntRepresentation(b.lookup(a.value).type.OpenCLType);break;case INDEX:c=adaptStatusToRoot(a.children[0],b)}return a.rangeInfo.forceInt(c),c}function push(a,b,c){switch(a||reportBug("malformed syntax tree encountered.",a),a.type||reportBug("missing type information in syntax tree.",a),a.type){case SCRIPT:a.funDecls.forEach(function(a){push(a.body)}),a.varDecls.forEach(function(b){var c=a.rangeSymbols.lookup(b.value),d=a.symbols.lookup(b.value).type,e=!1;c&&(e=c instanceof RangeArray?c.isInt():c.isInt),e&&updateToNew(d,"int",b.value)}),b=a.symbols;case BLOCK:a.children=a.children.map(function(a){return push(a,b,void 0)});break;case FUNCTION:break;case RETURN:a.value=push(a.value,b,!1);break;case FOR:a.setup=push(a.setup,b,void 0),a.update=push(a.update,b,void 0);case DO:case WHILE:a.condition=push(a.condition,b,void 0),a.body=push(a.body,b,void 0);break;case IF:a.condition=push(a.condition,b,void 0),a.thenPart=push(a.thenPart,b,void 0),a.elsePart&&(a.elsePart=push(a.elsePart,b,void 0));break;case SEMICOLON:a.expression&&(a.expression=push(a.expression,b,isIntValue(a)));break;case VAR:case CONST:a.children=a.children.map(function(a){var c=b.lookup(a.value).type;return c&&(a.typeInfo=c.clone()),a.initializer&&(a.initializer=isIntValue(a)&&!validIntRepresentation(a.typeInfo.OpenCLType)?push(a.initializer,b,!1):push(a.initializer,b,isIntValue(a))),a});break;case ASSIGN:switch(a.children[0].type){case IDENTIFIER:a.children[1]=push(a.children[1],b,isIntValue(a.children[0])),a.children[0].typeInfo=b.lookup(a.children[0].value).type.clone(),validIntRepresentation(a.children[1].typeInfo.OpenCLType)&&!validIntRepresentation(a.children[0].typeInfo.OpenCLType)&&(a.children[1]=makeCast(a.children[1],b.openCLFloatType));break;case INDEX:adaptStatusToRoot(a.children[0],b),a.children[0]=push(a.children[0],b,void 0),validIntRepresentation(a.children[1].typeInfo.OpenCLType)&&!validIntRepresentation(a.children[0].typeInfo.OpenCLType)&&(a.children[1]=makeCast(a.children[1],b.openCLFloatType)),a.children[1]=push(a.children[1],b,isIntValue(a.children[0]));case DOT:break;default:reportBug("unhandled lhs in assignment")}break;case COMMA:a.children=a.children.map(function(c,d){return push(c,b,d===a.children.length-1?isIntValue(a):void 0)});break;case HOOK:a.children[0]=push(a.children[0],b,void 0),a.children[1]=push(a.children[1],b,isIntValue(a)),a.children[2]=push(a.children[2],b,isIntValue(a));break;case INCREMENT:case PLUS:case DECREMENT:case MINUS:case MUL:case DIV:case MOD:case NOT:case UNARY_PLUS:case UNARY_MINUS:a.children=a.children.map(function(c){return push(c,b,isIntValue(a))});break;case EQ:case NE:case STRICT_EQ:case STRICT_NE:case LT:case LE:case GE:case GT:case AND:case OR:a.children=a.children.map(function(c){return push(c,b,isIntValue(a.children[0])&&isIntValue(a.children[1]))});break;case LSH:case RSH:case URSH:case BITWISE_NOT:case BITWISE_OR:case BITWISE_XOR:case BITWISE_AND:a.children=a.children.map(function(a){return push(a,b,!0)});break;case IDENTIFIER:case THIS:a.typeInfo=b.lookup(a.value).type.clone(),isIntValue(a)&&!validIntRepresentation(a.typeInfo.OpenCLType)&&(a=makeCast(a,"int"),a.rangeInfo=a.children[0].rangeInfo);break;case DOT:a.children[0]=push(a.children[0],b,void 0);break;case NUMBER:break;case TRUE:break;case FALSE:break;case INDEX:a.children[1]=push(a.children[1],b,!0),a.children[0]=push(a.children[0],b,void 0);break;case ARRAY_INIT:a.children=a.children.map(function(d){return push(d,b,isIntValue(a)&&c)});break;case CALL:switch(a.children[0].type){case DOT:var d=a.children[0];if("RiverTrailUtils"===d.children[0].value&&"createArray"===d.children[1].value){a.children[1].children[1]=push(a.children[1].children[1],b,!1);break}if(d.children[0]=push(d.children[0],b,void 0),d.children[0].typeInfo.isObjectType("ParallelArray")&&"get"===d.children[1].value){a.children[1]=push(a.children[1],b,!0);break}default:a.children[1]=push(a.children[1],b,!1)}break;case LIST:a.children=a.children.map(function(a){return push(a,b,c)});break;case CAST:a.children[0]=push(a.children[0],b,isIntValue(a));break;case FLATTEN:a.children[0]=push(a.children[0],b,c);break;case GETTER:case SETTER:reportError("setters/getters not yet implemented",a);break;case TRY:case THROW:reportError("try/throw/catch/finally not yet implemented",a);break;case BREAK:case CONTINUE:case LABEL:reportError("break/continure/labels not yet implemented",a);break;case YIELD:case GENERATOR:reportError("generators/yield not yet implemented",a);break;case FOR_IN:reportError("for .. in loops not yet implemented",a);break;case ARRAY_COMP:case COMP_TAIL:reportError("array comprehensions not yet implemented",a);break;case NEW:case NEW_WITH_ARGS:a.children[1].children[1]=push(a.children[1].children[1],b,!1);break;case PROPERTY_INIT:a.children[1]=push(a.children[1],b,!1);break;case OBJECT_INIT:for(var e in a.children)a.children[e]=push(a.children[e],b,!1);break;case WITH:reportError("general objects not yet implemented",a);break;case LET:case LET_BLOCK:reportError("let not yet implemented",a);break;case SWITCH:reportError("switch not yet implemented",a);break;case INSTANCEOF:reportError("instanceof not yet implemented",a);break;case EQ:case NE:reportError("non-strict equality not yet implemented",a);break;case IN:reportError("in not yet implemented",a);break;case NULL:reportError("null not yet implemented",a);break;case REGEXP:reportError("regular expressions not yet implemented",a);break;case STRING:reportError("strings not yet implemented",a);break;case DEBUGGER:default:throw"unhandled node type in analysis: "+a.type}if(a.type!==LIST)if(isIntValue(a))a.type!==ARRAY_INIT?(a.typeInfo&&updateToNew(a.typeInfo,"int",a.value),c===!1&&(a=makeCast(a,b.openCLFloatType))):(updateToNew(a.typeInfo.properties.elements,c?"int":b.openCLFloatType),a.typeInfo.updateOpenCLType());else if(c&&!validIntRepresentation(a.typeInfo.OpenCLType))if(a.type!==ARRAY_INIT){var f=new Narcissus.parser.Node(a.tokenizer);f.type=TOINT32,f.typeInfo=a.typeInfo.clone(),updateToNew(f.typeInfo,"int"),a.rangeInfo&&(f.rangeInfo=a.rangeInfo.clone()),f.children[0]=a,a=f}else updateToNew(a.typeInfo.properties.elements,"int"),a.typeInfo.updateOpenCLType();return debug&&a.type===SCRIPT&&(console.log("overall range map for SCRIPT node after push: "+a.rangeSymbols.toString()),console.log("overall type map for SCRIPT node after push: "+a.symbols.toString())),a}function propagate(a,b){if("combine"===b||"comprehension"===b||"comprehensionScalar"===b){var c=a.symbols,d=(a.rangeSymbols,a.rangeSymbols.lookup(a.params[0]));(d instanceof RangeArray?d.isInt():d.isInt)&&(updateToNew(c.lookup(a.params[0]).type,"int"),updateToNew(a.typeInfo.parameters["combine"===b?1:0],"int"))}return push(a.body,null,void 0)}var definitions=Narcissus.definitions;eval(definitions.consts),eval(RiverTrail.definitions.consts);var stripToBaseType=RiverTrail.Helper.stripToBaseType,debug=!1,intraFun=!1,maxRangeUpdates=1,RANGE_MAX=2147483647,RANGE_MIN=-2147483647,reportError=RiverTrail.Helper.reportError,reportBug=RiverTrail.Helper.reportBug,findSelectionRoot=RiverTrail.Helper.findSelectionRoot,Constraint=function(a,b){return this.lb=a,this.ub=b,this},CTp=Constraint.prototype;CTp.merge=function(a){var b=void 0!==this.lb?void 0!==a.lb?Math.max(this.lb,a.lb):this.lb:a.lb,c=void 0!==this.ub?void 0!==a.ub?Math.min(this.ub,a.ub):this.ub:a.ub;return new Constraint(b,c)},CTp.intersect=function(a){var b=void 0!==this.lb&&void 0!==a.lb?Math.min(this.lb,a.lb):void 0,c=void 0!==this.ub&&void 0!==a.ub?Math.max(this.ub,a.ub):void 0;return new Constraint(b,c)},CTp.isComplete=function(){return void 0!==this.lb&&void 0!==this.ub},CTp.toString=function(){return"["+(void 0!==this.lb?this.lb.toString():"--")+","+(void 0!==this.ub?this.ub.toString():"--")+"]"};var Constraints=function(){return this.bindings={},this.bindings.__proto__=null,this},CTSp=Constraints.prototype;CTSp.lookup=function(a){return this.bindings[a]},CTSp.add=function(a,b){if(this.bindings[a]){var c=this.bindings[a];b instanceof Array?(c instanceof Array||reportBug("mixed scalar and array constraints?!?"),this.bindings[a]=c.map(function(a,c){return a.merge(b[c])})):(!(c instanceof Array)||reportBug("mixed scalar and array constraints?!?"),this.bindings[a]=c.merge(b))}else this.bindings[a]=b},CTSp.intersect=function(a){for(name in this.bindings){var b=this.bindings[name],a=a.bindings[name];a?this.bindings[name]=b instanceof Array?b.map(function(b,c){return b.intersect(a[c])}):b.intersect(a):delete this.bindings[name]}},CTSp.merge=function(a){for(name in a.bindings)this.add(name,a.bindings[name])},CTSp.addAccu=function(a,b,c,d){var e,f=b.type;if(b.inverse)switch(f){case LT:f=GE;break;case LE:f=GT;break;case GT:f=LE;break;case GE:f=LT;break;case EQ:case STRICT_EQ:break;default:f=void 0}switch(f){case LT:void 0!==b.range.ub&&(e=new Constraint(void 0,b.range.ub-1));break;case LE:e=new Constraint(void 0,b.range.ub);break;case GE:e=new Constraint(b.range.lb,void 0);break;case GT:void 0!==b.range.lb&&(e=new Constraint(b.range.lb+1,void 0));break;case EQ:case STRICT_EQ:e=b.inverse?new Constraint(void 0,void 0):new Constraint(b.range.lb,b.range.ub);break;default:e=void 0}if(e){if(void 0!==c){var g=new Array(d);for(pos=0;pos<d;pos++)g[pos]=pos===c?e:new Constraint(void 0,void 0);e=g}this.add(a,e)}};var Range=function(a,b,c){return this.lb=a,this.ub=b,this.isInt=c&&(this.lb||0)>RANGE_MIN&&(this.ub||0)<RANGE_MAX||!1,this},Rp=Range.prototype;Rp.union=function(a){return new Range(void 0===this.lb||void 0===a.lb?void 0:Math.min(this.lb,a.lb),void 0===this.ub||void 0===a.ub?void 0:Math.max(this.ub,a.ub),this.isInt&&a.isInt)},Rp.constrain=function(a){return new Range(void 0===this.lb?a.lb:void 0===a.lb?this.lb:Math.max(this.lb,a.lb),void 0===this.ub?a.ub:void 0===a.ub?this.ub:Math.min(this.ub,a.ub),this.isInt)},Rp.force=function(a){return new Range(void 0===a.lb?this.lb:a.lb,void 0===a.ub?this.ub:a.ub,this.isInt)},Rp.map=function(a,b,c){return debug&&void 0===c&&reportBug("Rp.map called without isInt argument"),new Range(void 0===this.lb||void 0===a.lb?void 0:b(this.lb,a.lb),void 0===this.ub||void 0===a.ub?void 0:b(this.ub,a.ub),c)},Rp.cross=function(a,b,c){return debug&&void 0===c&&reportBug("Rp.cross called without isInt argument"),new Range(void 0===this.lb||void 0===a.ub?void 0:b(this.lb,a.ub),void 0===this.ub||void 0===a.lb?void 0:b(this.ub,a.lb),c)},Rp.fixedValue=function(){return void 0!==this.lb&&this.lb===this.ub},Rp.covers=function(a){var b=(this.lb===a.lb||this.lb<a.lb)&&(this.ub===a.ub||this.ub>a.ub);return b},Rp.clone=function(){return new Range(this.lb,this.ub,this.isInt)},Rp.isUndefined=function(){return void 0===this.lb&&void 0===this.ub&&!this.isInt},Rp.forceInt=function(a){this.isInt=a},Rp.toString=function(){return"["+(void 0!==this.lb?this.lb.toString():"--")+","+(void 0!==this.ub?this.ub.toString():"--")+"]<"+(this.isInt?"int":"fp")+">"};var RangeArray=function(a,b){if(this._store=[],a)if(a instanceof RangeArray)for(var c=0;c<a._store.length;c++)this._store[c]=b(a._store[c],c);else for(var c=0;c<a.length;c++)this._store[c]=b(a[c],c);return this},RAp=RangeArray.prototype;RAp.get=function(a){return this._store[a]},RAp.set=function(a,b){this._store[a]=b},RAp.map=function(a){return function b(c){for(var d=new RangeArray,e=0;e<this._store.length;e++)d._store[e]=this._store[e]instanceof RangeArray?b.call(this._store[e],c instanceof RangeArray?c._store[e]:c):a.call(this._store[e],c instanceof RangeArray?c._store[e]:c);return d}},RAp.union=RAp.map(Rp.union),RAp.constrain=RAp.map(Rp.constrain),RAp.force=RAp.map(Rp.force),RAp.clone=function(){var a=new RangeArray;return a._store=this._store.map(function(a){return a.clone()}),a},RAp.covers=function(a){return a instanceof RangeArray?this._store.every(function(b,c){return b.covers(a._store[c])}):!1},RAp.isInt=function(){return this._store.every(function(a){return a instanceof RangeArray?a.isInt():a.isInt})},RAp.setInt=function(a,b){this._store.forEach(function(c,d){c instanceof RangeArray?c.setInt(a instanceof RangeArray?a._store[d]:a,b):c.isInt=(a instanceof RangeArray?a._store[d]:a).isInt&&(!b||c.isInt)})},RAp.forceInt=function(a){this._store.forEach(function(b){b.forceInt(a)})},RAp.isUndefined=function(){return!1},RAp.toString=function(){for(var a="[[",b=0;b<this._store.length;b++)b>0&&(a+=", "),a+=this._store[b].toString();return a+="]<",a+=this.isInt()?"int":"fp",a+=">]"};var VarEnv=function(a){this.parent=a,this.bindings={},this.bindings.__proto__=null},VEp=VarEnv.prototype;return VEp.lookup=function(a){var b=this.bindings[a];return!b&&this.parent&&(b=this.parent.lookup(a)),b},VEp.update=function(a,b){var c=this.lookup(a);c?c.isUndefined()||b.isUndefined()?b.isUndefined()?this.bindings[a]=new Range(void 0,void 0,!1):b instanceof RangeArray?(this.bindings[a]=b.clone(),this.bindings[a].setInt(c,!0)):(this.bindings[a]=b.clone(),this.bindings[a].isInt=b.isInt&&c.isInt):c instanceof RangeArray?(b instanceof RangeArray||reportBug("update of array range with scalar range?"),this.bindings[a]=b.clone(),this.bindings[a].setInt(c,!0)):(!(b instanceof RangeArray)||reportBug("update of scalar range with array range?"),this.bindings[a]=b.clone(),this.bindings[a].isInt=b.isInt&&c.isInt):this.bindings[a]=b,debug&&console.log(a+" updated to "+this.bindings[a].toString())},VEp.apply=function(a,b){var c=this.lookup(a);b instanceof Array?(c instanceof RangeArray||c instanceof Array||(c=b.map(function(){return c})),this.bindings[a]=c?new RangeArray(c,function(a,c){return a.constrain(b[c])}):new RangeArray(b,function(a){return new Range(a.lb,a.ub)})):this.bindings[a]=c?c.constrain(b):new Range(b.lb,b.ub),debug&&console.log(a+" merged as "+this.bindings[a].toString())},VEp.enforce=function(a,b){var c=this.lookup(a);this.bindings[a]=b instanceof Array?c?new RangeArray(this.bindings[a],function(a,c){return a.force(b[c])}):new RangeArray(b,function(a){return new Range(a.lb,a.ub)}):c?c.force(b):new Range(b.lb,b.ub),debug&&console.log(a+" enforced as "+this.bindings[a].toString())},VEp.applyConstraints=function(a){for(var b in a.bindings)this.apply(b,a.lookup(b))},VEp.enforceConstraints=function(a){for(var b in a.bindings)this.enforce(b,a.lookup(b))},VEp.isEmpty=function(){return 0===Object.keys(this.bindings).length},VEp.covers=function(a){var b=!0;for(key in a.bindings){var c=this.bindings[key];if(!c){b=!1;break}var d=a.bindings[key];if(!c.covers(d)){b=!1;break}}return b},VEp.merge=function(a){for(var b in a.bindings){var c=this.lookup(b);c?this.update(b,c.union(a.bindings[b])):this.update(b,a.bindings[b])}},VEp.updateAll=function(a){for(var b in a.bindings)this.update(b,a.bindings[b])},VEp.invalidate=function(){for(var a in this.bindings)this.bindings[a]=this.bindings[a]instanceof RangeArray?new RangeArray(this.bindings[a],function(){return new Range(void 0,void 0,!1)}):new Range(void 0,void 0,!1)},VEp.toString=function(){var a="";for(var b in this.bindings)a=a+(""===a?"":", ")+b+" => "+this.bindings[b].toString();return"<<"+a+">>"},{analyze:analyze,propagate:propagate}}(),void 0===RiverTrail)var RiverTrail={};if(RiverTrail.InferBlockFlow=function(){function infer(a,b,c,d){"use strict";switch(void 0===b&&(a.type===FUNCTION||reportBug("you probably wanted to start inference with a function!"),b=new IdSet,c=new IdSet,d=new IdSet,infer(a.body,b,c,d)),a.type){case SCRIPT:a.funDecls.forEach(function(a){infer(a)});case BLOCK:var e=new IdSet,f=new IdSet,g=new IdSet;a.children.forEach(function(a){infer(a,e,f,g)}),a.ins=e.clone(),a.outs=f,a.locals=g,b.union(e.subtract(d)),c.union(f),d.union(g);break;case FUNCTION:break;case RETURN:infer(a.value,b,c,d);break;case DO:var h=new IdSet,i=new IdSet,j=new IdSet;infer(a.body,h,i,j),infer(a.condition,h,i,j),a.ins=h.clone(),a.outs=i,a.locals=j,b.union(h.subtract(d)),c.union(i),d.union(j);break;case FOR:case WHILE:a.setup&&infer(a.setup,b,c,d);var k=new IdSet,l=new IdSet,m=new IdSet;infer(a.condition,k,l,m);var n=k.clone(),o=l.clone(),p=m.clone();infer(a.body,k,l,m),a.update&&infer(a.update,k,l,m),a.ins=k.clone(),a.outs=l,a.locals=m,b.union(k.subtract(d)),c.union(l),b.union(n.subtract(d)),c.union(o),d.union(p);break;case IF:infer(a.condition,b,c,d);var q=new IdSet,r=new IdSet,s=new IdSet;if(infer(a.thenPart,q,r,s),b.union(q.subtract(d)),c.union(r),a.elsePart){var t=new IdSet,u=new IdSet,v=new IdSet;infer(a.elsePart,t,u,v),b.union(t.subtract(d)),c.union(u),s.intersect(v)}d.union(s);break;case SEMICOLON:a.expression&&infer(a.expression,b,c,d);break;case VAR:case CONST:a.children.forEach(function(a){a.initializer&&(infer(a.initializer,b,c,d),d.union(a.value),c.union(a.value))});break;case ASSIGN:switch(a.children[0].type){case IDENTIFIER:infer(a.children[1],b,c,d),d.union(a.children[0].value),c.union(a.children[0].value),a.assignOp&&b.union(a.children[0].value);break;case INDEX:infer(a.children[0],b,c,d),infer(a.children[1],b,c,d),c.union(findSelectionRoot(a.children[0]).value);break;case DOT:infer(a.children[0],b,c,d),infer(a.children[1],b,c,d);break;default:reportBug("unhandled lhs in assignment")}break;case COMMA:a.children.forEach(function(a){infer(a,b,c,d)});break;case HOOK:infer(a.children[0],b,c,d);var t=b.clone(),u=c.clone(),v=d.clone(),s=d.clone();infer(a.children[1],b,c,s),infer(a.children[2],t,u,v),b.union(t),c.union(u),s.intersect(v),d.union(s);break;case INCREMENT:case DECREMENT:b.union(a.value),d.union(a.value),c.union(a.value);break;case PLUS:case MINUS:case MUL:case EQ:case NE:case STRICT_EQ:case STRICT_NE:case LT:case LE:case GE:case GT:case BITWISE_OR:case BITWISE_XOR:case BITWISE_AND:case LSH:case RSH:case URSH:case DIV:case MOD:case AND:case OR:case NOT:case UNARY_PLUS:case UNARY_MINUS:case BITWISE_NOT:a.children.forEach(function(a){infer(a,b,c,d)});break;case CALL:if(a.children[0].type===DOT&&("RiverTrailUtils"===a.children[0].children[0].value||"createArray"===a.children[0].children[1].value)){infer(a.children[1].children[1],b,c,d);break}a.children.forEach(function(a){infer(a,b,c,d)});break;case LIST:case CAST:case TOINT32:case FLATTEN:case ARRAY_INIT:case INDEX:a.children.forEach(function(a){infer(a,b,c,d)});break;case DOT:infer(a.children[0],b,c,d);break;case IDENTIFIER:case THIS:d.contains(a.value)||b.union(a.value);break;case NUMBER:case TRUE:case FALSE:break;case GETTER:case SETTER:reportError("setters/getters not yet implemented",a);break;case TRY:case THROW:reportError("try/throw/catch/finally not yet implemented",a);break;case BREAK:case CONTINUE:case LABEL:reportError("break/continure/labels not yet implemented",a);break;case YIELD:case GENERATOR:reportError("generators/yield not yet implemented",a);break;case FOR_IN:reportError("for .. in loops not yet implemented",a);break;case ARRAY_COMP:case COMP_TAIL:reportError("array comprehensions not yet implemented",a);break;case NEW:case NEW_WITH_ARGS:reportError("general objects not yet implemented",a);break;case OBJECT_INIT:for(var w=0;w<a.children.length;w++)infer(a.children[w].children[1],b,c,d);break;case WITH:reportError("general objects not yet implemented",a);break;case LET:case LET_BLOCK:reportError("let not yet implemented",a);break;case SWITCH:reportError("switch not yet implemented",a);break;case INSTANCEOF:reportError("instanceof not yet implemented",a);break;case EQ:case NE:reportError("non-strict equality not yet implemented",a);break;case IN:reportError("in not yet implemented",a);break;case NULL:reportError("null not yet implemented",a);break;case REGEXP:reportError("regular expressions not yet implemented",a);break;case STRING:reportError("strings not yet implemented",a);break;case DEBUGGER:default:throw"unhandled node type in analysis: "+a.type}}var definitions=Narcissus.definitions;eval(definitions.consts),eval(RiverTrail.definitions.consts);const debug=!1;var reportError=RiverTrail.Helper.reportError,reportBug=RiverTrail.Helper.reportBug,findSelectionRoot=RiverTrail.Helper.findSelectionRoot,IdSet=function(){return this._store={},this._store.__proto__=null,this},ISP=IdSet.prototype={};return ISP.subtract=function(a){if("string"==typeof a)delete this._store[a];else for(var b in a._store)delete this._store[b];return this},ISP.union=function(a){if("string"==typeof a)this._store[a]=null;else for(var b in a._store)this._store[b]=null;return this},ISP.clone=function(){var a=new IdSet;return a.union(this),a},ISP.contains=function(a){return void 0!==this._store[a]},ISP.intersect=function(a){if("string"==typeof a)this.subtract(this).union(a);else for(var b in this._store)a.contains(b)||delete this._store[b];return this},ISP.toString=function(){return"{"+Object.keys(this._store).join(",")+"}"},{infer:infer}}(),void 0===RiverTrail)var RiverTrail={};if(RiverTrail.InferMem=function(){function reportError(a,b){throw"Error: "+a+" <"+(b?RiverTrail.Helper.wrappedPP(b):"no context")+">"}function reportBug(a){throw"Bug: "+a}function allocateArrayMem(a,b){var c=a.typeInfo.getOpenCLShape(),d=c.length;if(1===d)a.allocatedMem=b.allocate(a.typeInfo.getOpenCLSize(),"CALL");else{a.memBuffers={size:0,list:[]};for(var e=1,f=0;d>f;f++){var g=RiverTrail.Helper.getOpenCLSize(a.typeInfo.OpenCLType),h=g*c[f]*e,i=b.allocate(h,"CALL_"+f);a.memBuffers.size+=1,a.memBuffers.list.push(i),e*=c[f]}a.allocatedMem=a.memBuffers.list[0]}}function allocateObjMem(a,b){var c=a.typeInfo.properties.fields,d=0;a.memBuffers={__size:0,__root:null};for(var e in c)if(a.memBuffers[e]=[],c[e].isScalarType()){var f=RiverTrail.Helper.getOpenCLSize(c[e].OpenCLType);
d+=f}else if("InlineObject"===c[e].name)reportError("InlineObject type properties not implemented yet");else if("Array"===c[e].name){var g=c[e].getOpenCLShape(),h=g.length;d+=RiverTrail.Helper.getOpenCLSize(c[e].OpenCLType);for(var i=1,j=0;h>j;j++){var k=RiverTrail.Helper.getOpenCLSize(c[e].OpenCLType),f=k*g[j]*i,l=b.allocate(f,"FLD_"+j);a.memBuffers.__size+=1,a.memBuffers[e].push(l),i*=g[j]}}else reportError("Unknown field type");var m=b.allocate(d,"OBJ");a.memBuffers.size+=1,a.memBuffers.__root=m,a.allocatedMem=m}function infer(a,b,c,d){"use strict";switch(a.type){case SCRIPT:a.funDecls.forEach(function(a){infer(a.body)}),a.memVars=new MemList,a.children.forEach(function(b){infer(b,a.memVars,null,null)});break;case BLOCK:a.children.forEach(function(a){infer(a,b,c,d)});break;case FUNCTION:break;case RETURN:isArrayLiteral(a.value)?a.value.children.forEach(function(a){infer(a,b,c,d)}):infer(a.value,b,c,d);break;case DO:case FOR:a.setup&&infer(a.setup,b,c,d);case WHILE:infer(a.condition,b,c,d),infer(a.body,b,a.ins,a.outs),a.update&&infer(a.update,b,a.ins,a.outs);break;case IF:infer(a.condition,b,c,d);var e=new MemList;if(infer(a.thenPart,e,c,d),a.elsePart){var f=new MemList;infer(a.elsePart,f,c,d),e.overlay(f)}b.join(e);break;case SEMICOLON:a.expression&&infer(a.expression,b,c,d);break;case VAR:case CONST:a.children.forEach(function(a){a.initializer&&infer(a.initializer,b,c,d)});break;case ASSIGN:infer(a.children[0],b,c,d),infer(a.children[1],b,c,d);var g=a.children[0],h=a.children[1],i=function(c){if(!a.typeInfo.isScalarType()){var d=h.typeInfo.getOpenCLShape(),e=d.length;a.memBuffers={size:0,list:[]};for(var f=1,g=0;e>g;g++){var i=RiverTrail.Helper.getOpenCLSize(a.typeInfo.OpenCLType),j=i*d[g]*f,k=b.allocate(j,c+"_"+g);a.memBuffers.size+=1,a.memBuffers.list.push(k),f*=d[g]}a.allocatedMem=a.memBuffers.list[0]}};switch(a.children[0].type){case IDENTIFIER:("__private"===a.children[1].typeInfo.getOpenCLAddressSpace()&&c&&c.contains(g.value)&&d&&d.contains(g.value)||g.typeInfo.getOpenCLAddressSpace()!=a.children[1].typeInfo.getOpenCLAddressSpace()||!g.typeInfo.equals(h.typeInfo,!0))&&i(a.children[0].value);break;case INDEX:g.typeInfo.getOpenCLAddressSpace()==a.children[1].typeInfo.getOpenCLAddressSpace()&&g.typeInfo.equals(h.typeInfo,!0)||i("INDEX");break;case DOT:g.typeInfo.equals(h.typeInfo,!0)||i("DOT");break;default:reportBug("unhandled lhs in assignment")}break;case HOOK:infer(a.children[0],b,c,d);var e=new MemList;infer(a.children[1],e,c,d);var f=new MemList;infer(a.children[2],f,c,d),e.overlay(f),b.join(e);break;case IDENTIFIER:case THIS:case NUMBER:case TRUE:case FALSE:break;case ARRAY_INIT:a.allocatedMem=1===a.typeInfo.properties.shape.length&&a.typeInfo.properties.elements.isScalarType()?b.allocate(a.typeInfo.getOpenCLSize(),"ARRAY_INIT"):b.allocate(RiverTrail.Helper.getOpenCLSize(a.typeInfo.OpenCLType)*a.typeInfo.properties.shape[0],"ARRAY_INIT");case COMMA:case INCREMENT:case PLUS:case DECREMENT:case MINUS:case MUL:case EQ:case NE:case STRICT_EQ:case STRICT_NE:case LT:case LE:case GE:case GT:case BITWISE_OR:case BITWISE_XOR:case BITWISE_AND:case LSH:case RSH:case URSH:case DIV:case MOD:case AND:case OR:case NOT:case UNARY_PLUS:case UNARY_MINUS:case BITWISE_NOT:case DOT:case INDEX:case LIST:case CAST:case FLATTEN:case TOINT32:a.children&&a.children.forEach(function(a){infer(a,b,c,d)});break;case CALL:if(a.children)if(a.children[0].type===DOT&&"RiverTrailUtils"===a.children[0].children[0].value)switch(a.children[0].children[1].value){case"createArray":allocateArrayMem(a,b);break;default:reportError("Invalid method "+a.children[0].children[1].value+" on RiverTrailUtils",a)}else a.children.forEach(function(a){infer(a,b,c,d)});"InlineObject"===a.typeInfo.name?allocateObjMem(a,b):a.typeInfo.isScalarType()||a.typeInfo.properties.isShared||allocateArrayMem(a,b);break;case GETTER:case SETTER:reportError("setters/getters not yet implemented",a);break;case TRY:case THROW:reportError("try/throw/catch/finally not yet implemented",a);break;case BREAK:case CONTINUE:case LABEL:reportError("break/continure/labels not yet implemented",a);break;case YIELD:case GENERATOR:reportError("generators/yield not yet implemented",a);break;case FOR_IN:reportError("for .. in loops not yet implemented",a);break;case ARRAY_COMP:case COMP_TAIL:reportError("array comprehensions not yet implemented",a);break;case NEW:for(var j=0;j<a.children.length;j++)infer(a.children[j].children[1],b,c,d);break;case NEW_WITH_ARGS:case OBJECT_INIT:for(var j=0;j<a.children.length;j++)infer(a.children[j].children[1],b,c,d);break;case WITH:reportError("general objects not yet implemented",a);break;case LET:case LET_BLOCK:reportError("let not yet implemented",a);break;case SWITCH:reportError("switch not yet implemented",a);break;case INSTANCEOF:reportError("instanceof not yet implemented",a);break;case EQ:case NE:reportError("non-strict equality not yet implemented",a);break;case IN:reportError("in not yet implemented",a);break;case NULL:reportError("null not yet implemented",a);break;case REGEXP:reportError("regular expressions not yet implemented",a);break;case STRING:reportError("strings not yet implemented",a);break;case DEBUGGER:default:throw"unhandled node type in analysis: "+a.type}}function doInfer(a){a.type!==FUNCTION?reportBug("you probaly wanted to call the inference on a function node!"):infer(a.body)}var definitions=Narcissus.definitions;eval(definitions.consts),eval(RiverTrail.definitions.consts);const debug=!1;var MemSet=function(){var a={value:0};return function(){return this._store={},this._store.__proto__=null,this._unique=a,this}}(),MSP=MemSet.prototype={};MSP.create=function(a){var b="_mem_"+a+"_"+this._unique.value++;return this.add(b),b},MSP.add=function(a){this._store[a]=null},MSP.union=function(a){for(var b in a._store)null!==a._store[b]?(this._store[b]=new MemSet,this._store[b].union(a._store[b])):this.add(b)},MSP.overlay=function(a){var b=Object.keys(this._store),c=0;for(var d in a._store){var e;if(c<b.length?(null===this._store[b[c]]&&(this._store[b[c]]=new MemSet),e=this._store[b[c]],e.add(d)):(this.add(d),e=this._store[d]=new MemSet),null!==a._store[d])for(var f in a._store[d]._store)e.add(f);c++}},MSP.declare=function(a){var b="";for(var c in this._store)b+="char "+c+"["+a+"];",null!==this._store[c]&&(b+=this._store[c].declareAlias(c));return b},MSP.declareAlias=function(a){result="";for(var b in this._store)result+="char *"+b+" = "+a+";";return result};var MemList=function(){return this._store=[],this},MLP=MemList.prototype={};MLP.allocate=function(a,b){return void 0===this._store[a]&&(this._store[a]=new MemSet),this._store[a].create(b)},MLP.join=function(a){for(var b in a._store)void 0===this._store[b]&&(this._store[b]=new MemSet),this._store[b].union(a._store[b])},MLP.overlay=function(a){for(var b in a._store)void 0===this._store[b]&&(this._store[b]=new MemSet),this._store[b].overlay(a._store[b])},MLP.declare=function(){var a="";for(var b in this._store)a+=this._store[b].declare(b);return a};var isArrayLiteral=RiverTrail.Helper.isArrayLiteral;return{infer:doInfer}}(),void 0===RiverTrail)var RiverTrail={};var doIterationSpaceFlattening=!1;if(RiverTrail.compiler.codeGen=function(){function genCalledFunctionHeader(a){"use strict";var b="",c="";if("function"!=a.value)throw"expecting function found "+a.value;var d=calledScope.inCalledScope();calledScope.enter(a.name),b=b+" "+a.typeInfo.result.OpenCLType+" "+RENAME(a.dispatch),b+="(",b+="int * _FAILRET",c=genFormalParams(a,"ignore"),""!==c&&(b=b+", "+c);var e=a.typeInfo.result.OpenCLType;return a.typeInfo.result.isScalarType()||(b=b+", "+e+" retVal"),b+=" ) ",calledScope.exit(d),b}function inliningMightHelp(a){a.body.children,a.typeInfo.result;return!0}function genCalledFunction(a){"use strict";var b="",c=calledScope.inCalledScope();if(calledScope.enter(a.name),"function"!=a.value)throw"expecting function found "+a.value;var d=a.typeInfo.result.OpenCLType;inliningMightHelp(a)||(b+="__attribute__((noinline)) "),b+=genCalledFunctionHeader(a),b+=" { ",b+=" const int _writeoffset = 0; ",b+=" int _FAIL = 0;",b+=" int _sel_idx_tmp;",b=b+d+" "+boilerplate.localResultName+";";var e=oclStatements(a.body);return b+=tempVars.declare()+e,b+=" } ",calledScope.exit(c),b}function genKernel(a,b,c,d){"use strict";var e;try{e=prelude+genKernelHelper(a,b,c,d)}catch(f){throw console.log(f.toString()),f}return e}function getReturnFormalType(a){return a.isScalarType()?a.OpenCLType+"*":RiverTrail.Helper.stripToBaseType(a.OpenCLType)+"*"}function declareLocalFunctions(a){var b="";if(!a)return b;for(var c=0;c<a.length;c++)b+=declareLocalFunctions(a[c].body.funDecls),b=b+genCalledFunctionHeader(a[c])+";";return b}function generateLocalFunctions(a){var b="";if(!a)return b;for(var c=0;c<a.length;c++)b+=generateLocalFunctions(a[c].body.funDecls),b+=genCalledFunction(a[c]);return b}function genKernelHelper(a,b,c,d){"use strict";var e,f,g,h,i,j,k,l,m,n="",o=(a.name,0);if(l=a,"function"!=l.value)throw new Error("function expected");boilerplate=boilerplateTemplates[d];for(var p=globalInlineObjectTypes.length,o=0;p>o;o++){n+="typedef struct struct_"+globalInlineObjectTypes[o].baseType+" { ";var q=globalInlineObjectTypes[o].properties.fields;for(var r in q)n+=q[r].OpenCLType+" "+r+";";n+="} "+globalInlineObjectTypes[o].baseType+";"}if(n+=declareLocalFunctions(a.body.funDecls),n+=generateLocalFunctions(a.body.funDecls),n=n+"__kernel void RT_"+l.name+"(",n+="__global int *_FAILRET, ",boilerplate.hasThis?(m=l.typeInfo.parameters[0],k=c,f=m.isNumberType(),i=b.getShape(),g=i.slice(0,k),n=f&&"map"===d?n+" __global "+m.OpenCLType+"* opThisVect ":n+" __global "+m.OpenCLType+" opThisVect ",n+=", int opThisVect__offset, "):(g=c,k=c.length),j=genFormalParams(l,d),""!==j&&(n=n+j+","),"combine"!==d&&"map"!==d&&"comprehension"!==d&&"comprehensionScalar"!==d)throw"unimplemented construct "+d;if(l.typeInfo.result.isScalarType()||l.typeInfo.result.isArrayishType())n=n+"__global "+getReturnFormalType(l.typeInfo.result)+" retVal, ",n+="int retVal__offset";else if(l.typeInfo.result.isObjectType("InlineObject")){var q=l.typeInfo.result.properties.fields;for(var r in q)n=n+" __global "+getReturnFormalType(q[r])+" retVal_"+r+", int retVal_"+r+"_offset,";n=n.slice(0,-1)}else reportError("Unknown return type in kernel");if(n+=")",n+=" {",n+="int _sel_idx_tmp; int _FAIL = 0;",doIterationSpaceFlattening&&2==k)n+="int _id_0 = (int)get_global_id(0);",n+="int RT_Fi = (_id_0/"+g[1]+");",n+="int RT_Fj = _id_0 - (RT_Fi * "+g[1]+");",n+="_id_0 = RT_Fi; int _id_1 = RT_Fj;";else for(o=0;k>o;o++)n=n+"int _id_"+o+" = (int)get_global_id("+o+");";if(a.typeInfo.result.isArrayishType()||a.typeInfo.result.isScalarType()){for(n+="int _writeoffset = 0",h=a.typeInfo.result.getOpenCLShape().reduce(function(a,b){return a*b},1),o=k-1;o>=0;o--)n=n+"+"+h+" * _id_"+o,h*=g[o];n+=";"}else if(a.typeInfo.result.isObjectType("InlineObject")){h=0;var q=a.typeInfo.result.properties.fields;q||reportError("Invalid type definition for returned object");for(var r in q){for(n=n+"int _writeoffset_"+r+" = 0",h=q[r].getOpenCLShape().reduce(function(a,b){return a*b},1),o=k-1;o>=0;o--)n=n+"+"+h+" * _id_"+o,h*=g[o];n+=";"}}if("map"===d){if(a.typeInfo.result.isObjectType("InlineObject"))reportError("Not supported");else{n=n+"int _readoffset = "+b.offset;var s=a.typeInfo.result.getOpenCLShape();if(i.length===k+s.length&&s.every(function(a,b){return a===i[b+k]}))n+=" + _writeoffset";else for(e=b.strides.slice(0,k),o=0;k>o;o++)n=n+"+ _id_"+o+" * "+e[o]}n+=";"}if((a.typeInfo.result.isArrayishType()||a.typeInfo.result.isScalarType())&&(n+="_writeoffset += retVal__offset;"),boilerplate.hasThis){{m.getOpenCLShape()}n=n+(f?" ":" __global ")+m.OpenCLType+" "+boilerplate.localThisName+";",n=n+boilerplate.localThisName+" = "+(f?"(":"&(")+boilerplate.localThisDefinition+");"}n=n+l.typeInfo.result.OpenCLType+" "+boilerplate.localResultName+";",n+=genFormalRelativeArg(l,d),n+=adjustFormalsWithOffsets(l,d);var t=oclStatements(l.body);return n=n+tempVars.declare()+t,n+="}"}function genReturn(a){"use strict";return calledScope.inCalledScope()?genSimpleReturn(a):genKernelReturn(a)}function genSimpleReturn_old(a){"use strict";var b,c,d=" ";if(b=a.value,b.typeInfo.isScalarType())d=boilerplate.localResultName+" = "+oclExpression(b)+";",d+="if (_FAIL) {*_FAILRET = _FAIL;}",d=d+" return "+boilerplate.localResultName+";";else{for(var e=b.typeInfo.properties.shape.reduce(function(a,b){return a*b}),f=RiverTrail.Helper.stripToBaseType(b.typeInfo.OpenCLType),g="(("+f+") ",h=")";b.type===CAST;)g=g+"(("+RiverTrail.Helper.stripToBaseType(b.typeInfo.OpenCLType)+")",h=")"+h,b=b.children[0];if(b.type===ARRAY_INIT){for(d+="{",c=0;e>c;c++)d=d+"retVal[_writeoffset + "+c+"] = "+g+oclExpression(b.children[c])+h+";";d+="}"}else d=boilerplate.localResultName+" = "+oclExpression(b)+";",d=d+"{ int _writeback_idx = 0; for (;_writeback_idx < "+e+"; _writeback_idx++) { ",d=d+" retVal[_writeoffset + _writeback_idx] = "+g+"tempResult[_writeback_idx]"+h+";",d+="}";d+="if (_FAIL) {*_FAILRET = _FAIL;}",d+="return retVal;"}return d}function genSimpleReturn(a){"use strict";var b,c,d,e=" ",f=function z(a,b,c,d,e,f){var g="";if(0===e.length)g+=a+b+"="+d+c+";";else{var h=e.slice(1);g+="for (int cpi_"+f+" = 0; cpi_"+f+" < "+e[0]+"; cpi_"+f+"++) {",g+=z(a,b+"[cpi_"+f+"]",c+"[cpi_"+f+"]",d,h,f+1),g+="}"}return g},g=function A(a,b,c,d,e,f){var g="";if(0===e.length)g+=a+b+"="+d+"["+c+"++];";else{var h=e.slice(1);g+="for (int cpi_"+f+" = 0; cpi_"+f+" < "+e[0]+"; cpi_"+f+"++) {",g+=A(a,b+"[cpi_"+f+"]",c,d,h,f+1),g+="}"}return g},h=function B(a,b,c){var d="";if(c.type===ARRAY_INIT)for(var e=0;e<c.children.length;e++)d+=B(a,b+"["+e+"]",c.children[e]);else c.type===IDENTIFIER&&c.typeInfo.getOpenCLShape().length>=1?"__global"===c.typeInfo.getOpenCLAddressSpace()?(d+="{ int _readidx = 0;",d+=g(a,b,"_readidx",oclExpression(c),c.typeInfo.getOpenCLShape(),0),d+="}"):d+=f(a,b,"",oclExpression(c),c.typeInfo.getOpenCLShape(),0):d+=a+b+" = "+oclExpression(c)+";";return d};if(c=a.value,c.typeInfo.isScalarType())e=boilerplate.localResultName+" = "+oclExpression(c)+";",e+="if (_FAIL) {*_FAILRET = _FAIL;}",e=e+" return "+boilerplate.localResultName+";";else{if(isArrayLiteral(c))e=e+"{"+h("(retVal + _writeoffset)","",c)+"}";else if(c.typeInfo.isObjectType("InlineObject")){var i=0,j="tempResult_p",k="tempResult_s",l="";for(var m in c.typeInfo.properties.fields){var n=c.typeInfo.properties.fields[m],o=n.isScalarType();if(l=o?k:j,e+=o?"{ double "+k+";":"{ void * "+j+";",o||"__global"!==n.properties.addressSpace){for(var p=0;;){if(c.children[p++].children[0].value===m){e+=l+" = "+oclExpression(c.children[p-1].children[1])+"; ";break}p>=c.typeInfo.properties.fields.length&&reportError("Statement return: Field",m,"could not be found! ",a)}var d,q,r=n.getOpenCLShape(),s=r.length,t="",u="";for(d=0;s>d;d++)q="_idx"+d,e+=" { int "+q+"; ",e+="for ("+q+"= 0; "+q+" < "+r[d]+"; "+q+"++) {",t+="["+q+"]",u+="}}";e+=" (retVal->"+m+")"+t+" = (("+n.OpenCLType+")"+l+")"+t+";"+u}else e+="{ __global "+n.OpenCLType+" "+j+"_g","NaN = "+oclExpression(c.children[i].children[1])+";",e+=" int _idx1; ",e+="for ( _idx1 = 0; _idx1 < "+b+"; _idx1++) {",e+=" retVal[_idx1] = "+j+"_g[_idx1]; } }",i++;e+="}"}}else{var b=c.typeInfo.getOpenCLShape().reduce(function(a,b){return a*b});if("__global"===c.typeInfo.properties.addressSpace)e="__global "+c.typeInfo.OpenCLType+" "+boilerplate.localResultName+"_g = "+oclExpression(c)+";",e+=" int _idx1; ",e+="for ( _idx1 = 0; _idx1 < "+b+"; _idx1++) {",e+=" retVal[_idx1] = "+boilerplate.localResultName+"_g[_idx1]; }";else{var v=c,w=v.typeInfo,x=w.getOpenCLShape();e=boilerplate.localResultName+" = "+oclExpression(c)+";";var d,m,y=x.length,t="",u="";for(e+="{ int _writeback_idx = 0 ;",d=0;y>d;d++)m="_idx"+d,e+=" { int "+m+"; ",e+="for ("+m+"= 0; "+m+" < "+x[d]+"; "+m+"++) {",t+="["+m+"]",u+="}}";e+=" retVal"+t+" = (("+w.OpenCLType+")"+boilerplate.localResultName+")"+t+";"+u+"}"}}e+="if (_FAIL) {*_FAILRET = _FAIL;}",e+=" return retVal; "}return e}function genKernelReturn(a){"use strict";var b,c,d,e=" ";c=a.value;var f=function s(a,b,c,d,e,f){var g="";if(0===e.length)g+=a+"["+b+"++]="+d+c+";";else{var h=e.slice(1);g+="for (int cpi_"+f+" = 0; cpi_"+f+" < "+e[0]+"; cpi_"+f+"++) {",g+=s(a,b,c+"[cpi_"+f+"]",d,h,f+1),g+="}"}return g},g=function(a,b,c,d){var e=d.reduce(function(a,b){return a*b}),f="for (int cpi = 0; cpi < "+e+"; cpi++) {";return f+=a+"["+b+"++] = "+c+"[cpi];",f+="}"},h=function t(a,b,c){var d="";if(c.type===ARRAY_INIT)for(var e=0;e<c.children.length;e++)d+=t(a,b,c.children[e]);else d+=c.type===IDENTIFIER&&c.typeInfo.getOpenCLShape().length>=1?"__global"===c.typeInfo.getOpenCLAddressSpace()?g(a,b,oclExpression(c),c.typeInfo.getOpenCLShape()):f(a,b,"",oclExpression(c),c.typeInfo.getOpenCLShape(),0):a+"["+b+"++] = "+oclExpression(c)+";";return d};if(c.typeInfo.isScalarType())e=boilerplate.localResultName+" = "+oclExpression(c)+";",e=e+"retVal[_writeoffset] = "+boilerplate.localResultName+";";else if(isArrayLiteral(c))e=e+"{ int writeidx = 0; "+h("(retVal + _writeoffset)","writeidx",c)+"}";else if("__global"===c.typeInfo.properties.addressSpace){e=boilerplate.localResultName+" = "+oclExpression(c)+";";var b=c.typeInfo.getOpenCLShape().reduce(function(a,b){return a*b});e+="{ int _writeback_idx = 0 ;",e+="for (_writeback_idx = 0; _writeback_idx < "+b+"; _writeback_idx++) {",e+=" retVal[_writeoffset + _writeback_idx]  = "+boilerplate.localResultName+"[_writeback_idx] ; } }"}else if(c.typeInfo.isObjectType("InlineObject")){var i=c.typeInfo.properties.fields;e="";var j=0;for(var k in i){j++;var l=i[k];if(i[k].isScalarType())e+="{ int _writeback_idx_"+k+" = 0;",e+=" retVal_"+k+"[_writeoffset_"+k+" + _writeback_idx_"+k+"] = "+oclExpression(c.children[j-1].children[1])+"; }";else{var m=l.getOpenCLShape();e+="{"+l.OpenCLType+" tempResult_"+k+" = ("+oclExpression(c.children[j-1].children[1])+");";var d,n,o=m.length,p="",q="";for(e+="{ int _writeback_idx_"+k+" = 0 ;",d=0;o>d;d++)n="_idx"+d,e+=" { int "+n+";",e+="for ("+n+"= 0; "+n+" < "+m[d]+"; "+n+"++) {",p+="["+n+"]",q+="}}";e+=" retVal_"+k+"[_writeoffset_"+k+" + _writeback_idx_"+k+"++]  = (("+l.OpenCLType+")tempResult_"+k+")"+p+";"+q+"} }"}}}else{var r=c,l=r.typeInfo,m=l.getOpenCLShape();e=boilerplate.localResultName+" = "+oclExpression(c)+";";var d,n,o=m.length,p="",q="";for(e+="{ int _writeback_idx = 0 ;",d=0;o>d;d++)n="_idx"+d,e+=" { int "+n+";",e+="for ("+n+"= 0; "+n+" < "+m[d]+"; "+n+"++) {",p+="["+n+"]",q+="}}";e+=" retVal[_writeoffset + _writeback_idx++]  = (("+l.OpenCLType+")"+boilerplate.localResultName+")"+p+";"+q+"}"}return e+="if (_FAIL) {*_FAILRET = _FAIL;}",e+=" return; "}function genOCL(){"use strict";var a="";return console.log("Call to genOCL line 1456 that probable shouldn't be there"),a}function oclStatements(a){"use strict";var b,c="";if(a.type===BLOCK||a.type===SCRIPT)for(a.symbols&&(c+=a.symbols.emitDeclarations(RENAME)),a.memVars&&(c+=a.memVars.declare()),b=0;b<a.children.length;b++)c=c+oclStatement(a.children[b])+";";else c+=oclStatement(a);return"{"+c+"}"}function stripCasts(a){return a.type===CAST?stripCasts(a.children[0]):a}function initNestedArrayStructure(a,b){b===!0&&void 0===a.initializer&&reportError("Invalid value initializer while creating array",a);for(var c=a.typeInfo.getOpenCLShape(),d=c.length,e="",f=1,g="",h="",i=0;d>i&&(i!==d-1||b);i++){for(var j=0;j<c[i]*f;j++)h="("+getPointerCast(i,d,a.typeInfo.OpenCLType)+a.memBuffers.list[i]+")["+j+"]",g=i===d-1&&b?a.initializer:"&(("+getPointerCast(i+1,d,a.typeInfo.OpenCLType)+a.memBuffers.list[i+1]+")["+j*c[i+1]+"])",e+=h+" = "+g+" ,";f*=c[i]}return e}function wrapIntoCheck(a,b,c,d){var e="",f="",g=!1;if(0===b)throw new Error("selection from empty array encountered!");return(void 0===a||void 0===a.lb||a.lb<0)&&(f+="(_sel_idx_tmp < 0 ? (_FAIL ? 0 : (_FAIL = "+newError("index "+c+" smaller than zero in "+RiverTrail.Helper.wrappedPP(d))+", 0)) : ",e=")"+e,g=!0),(void 0===a||void 0===a.ub||a.ub>=b)&&(f+="(_sel_idx_tmp >= "+b+" ? (_FAIL ? 0: (_FAIL = "+newError("index "+c+" greater than upper bound "+b+" in "+RiverTrail.Helper.wrappedPP(d))+", 0)) : ",e=")"+e,g=!0),f=g?"(_sel_idx_tmp = "+c+", "+f+"_sel_idx_tmp"+e+")":c}function getPointerCast(a,b,c){for(var d=b-a,e=RiverTrail.Helper.stripToBaseType(c)+" ",f=0;d>f;f++)e+="*";return"("+e+")"}function oclExpression(a){"use strict";var b,c=" ";if(a.type===CAST)a.typeInfo.isScalarType()||reportError("non-scalar cast encountered",a),c="(("+a.typeInfo.OpenCLType+")"+oclExpression(a.children[0])+")";else if(a.type===FLATTEN)a.typeInfo.getOpenCLShape().length>1&&reportError("flattening of nested arrays not yet implemented.",a.children[0]),c+=oclExpression(a.children[0]);else if(a.type===NUMBER)c+=toCNumber(a.value,a.typeInfo);else if(a.type===THIS)c+=" tempThis ";else if(a.type===CALL)if(a.children[0].type===DOT){var d=a.children[0].children[0],e=a.children[0].children[1];if("get"===e.value)c+=compileSelectionOperation(a,a.children[0].children[0],a.children[1]);else if("getShape"===e.value&&d.typeInfo.isObjectType("ParallelArray")){c+="(";for(var f=d.typeInfo.properties.shape,g=0;g<f.length;g++)c=c+"((int*)"+a.allocatedMem+")["+g+"]="+f[g]+",";c=c+"(int*)"+a.allocatedMem+")"}else"Math"===d.value?c+=mathOCLMethod(a):"RiverTrailUtils"===d.value?(c+="("+initNestedArrayStructure(a,!0),c=c+"("+a.typeInfo.OpenCLType+")("+a.allocatedMem+") )"):c+=" 628 oclExpression not complete probable some sort of method call "}else{var h="";h=oclExpression(a.children[1]);var i="";if("InlineObject"===a.typeInfo.name){var j=a.memBuffers.__root;c+="(";for(var k in a.typeInfo.properties.fields){var l=a.typeInfo.properties.fields[k];if(!l.isScalarType()){var m=l.getOpenCLShape(),n=m.length,i="",o=1,e="",d="";i=")";for(var b=0;n-1>b;b++){for(var p=0;p<m[b]*o;p++)d="("+getPointerCast(b,n,l.OpenCLType)+a.memBuffers[k][b]+")["+p+"]",e="&(("+getPointerCast(b+1,n,l.OpenCLType)+a.memBuffers[k][b+1]+")["+p*m[b+1]+"])",c+=d+" = "+e+" ,";o*=m[b]}c+="(("+a.typeInfo.OpenCLType+")"+j+")->"+k+"=("+l.OpenCLType+")"+a.memBuffers[k][0]+","}}c=c+RENAME(a.children[0].dispatch)+"( &_FAIL"+(""!==h?", ":"")+h,c+=", ("+a.typeInfo.OpenCLType+")"+j+"))"}else!a.typeInfo.isScalarType()&&a.typeInfo.getOpenCLShape().length>1?(c+="("+initNestedArrayStructure(a,!1),i=")",c=c+RENAME(a.children[0].dispatch)+"( &_FAIL"+(""!==h?", ":"")+h,a.typeInfo.isScalarType()||(c=c+", ("+a.typeInfo.OpenCLType+") "+a.allocatedMem),c+=")",c+=i):(c=c+RENAME(a.children[0].dispatch)+"( &_FAIL"+(""!==h?", ":"")+h,a.typeInfo.isScalarType()||(c=c+", ("+a.typeInfo.OpenCLType+") "+a.allocatedMem),c+=")",c+=i)}else c=oclStatement(a);return c}function generateCopyExpression(a,b){"use strict";var c="",d=b.children[1].typeInfo.getOpenCLShape(),e=b.children[1].typeInfo.OpenCLType,f=d.length,g="__global"==b.children[1].typeInfo.getOpenCLAddressSpace()?"__global":"";if(!b.children[1].typeInfo.isScalarType()&&f>=1){var h="tmp_"+b.memBuffers.list[0];c+="(",tempVars.push("/* Copying Assignment */ "+g+" "+e+" "+h),c+=h+" = "+oclExpression(b.children[1])+",";var i="",j=1,k="",l="";i=")";for(var m=0;f>m;m++){for(var n=0;n<d[m]*j;n++){if(m===f-1){l="("+getPointerCast(m,f,b.typeInfo.OpenCLType)+b.memBuffers.list[m]+")["+n+"]";var o=n,p="";if("__global"===g)p="["+o+"]";else for(var q=f-1;q>=0;q--)p="["+o%d[q]+"]"+p,o=Math.floor(o/d[q]);k=h+p}else l="("+getPointerCast(m,f,b.typeInfo.OpenCLType)+b.memBuffers.list[m]+")["+n+"]",k="&(("+getPointerCast(m+1,f,b.typeInfo.OpenCLType)+b.memBuffers.list[m+1]+")["+n*d[m+1]+"])";c+=l+" = "+k+" ,"}j*=d[m]}c+=" ("+e+")"+b.memBuffers.list[0]+")",c="("+a+(b.assignOp?tokens[b.assignOp]:"")+"= "+c+")"}else if(b.typeInfo.isScalarType())throw new Error("Compiler bug: Memory allocated for scalar copy");return c}function pp(a){"use strict";return console.log("Get rid of this call line 1750."),oclStatement(a)}function oclStatement(a){"use strict";var b="";if(!a)return"";if(!(a instanceof Object))return a;switch(a.parenthesized&&(b+="("),a.type){case SCRIPT:b+="SCRIPT TBD ";case BLOCK:a.children.forEach(function(a){oclStatement(a)});break;case FUNCTION:break;case RETURN:b+=genReturn(a);break;case FOR:b+="for ( "+oclExpression(a.setup)+"; "+oclExpression(a.condition)+";"+oclExpression(a.update)+") ",b+=oclStatements(a.body);break;case WHILE:b+="while ( "+oclExpression(a.condition)+") ",b+=oclStatements(a.body);break;case DO:b+="do "+oclStatements(a.body)+" while ("+oclExpression(a.condition)+");";break;case IF:b+="if ("+oclExpression(a.condition)+") {",b+=oclStatements(a.thenPart)+"} ",a.elsePart&&(b+="else {"+oclStatements(a.elsePart)+"}");break;case SEMICOLON:a.expression&&(b+=oclStatement(a.expression)+";");break;case VAR:case CONST:b+=a.children.reduce(function(a,b){if(b.initializer)switch(b.type){case IDENTIFIER:""!==a&&(a+=", "),a+=RENAME(b.value)+" = "+oclExpression(b.initializer);break;default:reportBug("unhandled lhs in var/const")}return a},"");break;case ASSIGN:switch(a.children[0].type){case IDENTIFIER:a.allocatedMem?b+=generateCopyExpression(RENAME(a.children[0].value),a):b=b+"("+RENAME(a.children[0].value)+(a.assignOp?tokens[a.assignOp]:"")+"= "+oclExpression(a.children[1])+")";break;case INDEX:"__global"!==findSelectionRoot(a.children[0]).typeInfo.getOpenCLAddressSpace()||reportError("global arrays are immutable",a),a.allocatedMem?b+=generateCopyExpression(oclExpression(a.children[0]),a):b=b+"(("+oclExpression(a.children[0])+")"+(a.assignOp?tokens[a.assignOp]:"")+"= "+oclExpression(a.children[1])+")";break;case DOT:a.allocatedMem?b+=generateCopyExpression("("+oclExpression(a.children[0].children[0])+"->"+a.children[0].children[1].value+")",a):b=b+"(("+oclExpression(a.children[0].children[0])+"->"+a.children[0].children[1].value+")"+(a.assignOp?tokens[a.assignOp]:"")+"= "+oclExpression(a.children[1])+")";break;default:reportBug("unhandled lhs in assignment")}break;case COMMA:for(var c=0;c<a.children.length;c++)c>0&&(b+=", "),b+=oclExpression(a.children[c]);break;case HOOK:b+="("+oclExpression(a.children[0])+"?"+oclExpression(a.children[1])+":"+oclExpression(a.children[2])+")";break;case STRICT_EQ:case STRICT_NE:a.value=a.value.substring(0,2);case PLUS:case BITWISE_OR:case BITWISE_XOR:case BITWISE_AND:case EQ:case NE:case LT:case LE:case GE:case GT:case LSH:case RSH:case URSH:case MINUS:case MUL:case DIV:b=b+"("+oclExpression(a.children[0])+a.value+oclExpression(a.children[1])+")";break;case MOD:b=b+"(fmod(("+oclExpression(a.children[0])+"), ("+oclExpression(a.children[1])+")))";break;case OR:b+="("+oclExpression(a.children[0])+" || "+oclExpression(a.children[1])+")";break;case AND:b+="("+oclExpression(a.children[0])+" && "+oclExpression(a.children[1])+")";break;case NOT:case BITWISE_NOT:case UNARY_PLUS:case UNARY_MINUS:b=b+a.value+oclExpression(a.children[0]);break;case INCREMENT:case DECREMENT:var d=stripCasts(a.children[0]),e=d.typeInfo.OpenCLType,f=a.children[0].typeInfo.OpenCLType;switch(e){case"float":case"double":if(!a.postfix)throw new Error("prefix increment/decrement on floats is not implemented, yet.");b="(("+f+") ("+RENAME(d.value)+" "+a.value.substring(0,1)+"= (("+e+") 1)))";break;default:b=a.postfix?b+oclExpression(a.children[0])+a.value:b+a.value+oclExpression(a.children[0])}break;case IDENTIFIER:b+=RENAME(a.value);break;case THIS:b+=" tempThis ";break;case DOT:a.children[0].typeInfo.isObjectType("InlineObject")?b=b+" "+RENAME(a.children[0].value)+"->"+a.children[1].value:a.children[0].typeInfo.isArrayishType()&&"length"===a.children[1].value?b+=a.children[0].typeInfo.getOpenCLShape()[0]:reportBug("unsupported property selection in back end",a);break;case CAST:case FLATTEN:case NUMBER:b+=oclExpression(a);break;case TRUE:b+="true";break;case FALSE:b+="false";break;case INDEX:b+=compileSelectionOperation(a,a.children[0],a.children[1],!0);break;case ARRAY_INIT:b+="(";for(var c=0;c<a.children.length;c++)c>0&&(b+=", "),b+="(("+a.typeInfo.OpenCLType+") "+a.allocatedMem+")["+c+"] = "+oclExpression(a.children[c]);c>0&&(b+=", "),b=b+"(("+a.typeInfo.OpenCLType+") "+a.allocatedMem+"))";break;case CALL:b+=oclExpression(a);break;case LIST:for(var c=0;c<a.children.length;c++)c>0&&(b+=", "),b+=oclExpression(a.children[c]);break;case GETTER:case SETTER:reportError("setters/getters not yet implemented",a);break;case TRY:case THROW:reportError("try/throw/catch/finally not yet implemented",a);break;case BREAK:case CONTINUE:case LABEL:reportError("break/continure/labels not yet implemented",a);break;case YIELD:case GENERATOR:reportError("generators/yield not yet implemented",a);break;case FOR_IN:reportError("for .. in loops not yet implemented",a);break;case ARRAY_COMP:case COMP_TAIL:reportError("array comprehensions not yet implemented",a);break;case NEW:reportError("general object construction not yet implemented",a);break;case NEW_WITH_ARGS:case OBJECT_INIT:reportError("general object construction not yet implemented",a);break;case WITH:reportError("general objects not yet implemented",a);break;case LET:case LET_BLOCK:reportError("let not yet implemented",a);break;case SWITCH:reportError("switch not yet implemented",a);break;case INSTANCEOF:reportError("instanceof not yet implemented",a);break;case EQ:case NE:reportError("non-strict equality not yet implemented",a);break;case IN:reportError("in not yet implemented",a);break;case NULL:reportError("null not yet implemented",a);break;case REGEXP:reportError("regular expressions not yet implemented",a);break;case STRING:reportError("strings not yet implemented",a);break;case TOINT32:if(!a.typeInfo.isNumberType())throw"TOINT32 applied to non scalar data structure";b=b+"((int)"+oclExpression(a.children[0])+")";break;case DEBUGGER:default:throw"unhandled node type in analysis: "+tokens[a.type]}return a.parenthesized&&(b+=")"),b}const verboseDebug=!1,checkBounds=!0,checkall=!1,disableVectorization=!1,conditionalInline=!1,verboseErrors=!0,parser=Narcissus.parser,definitions=Narcissus.definitions,tokens=RiverTrail.definitions.tokens;var RENAME=function(a){return"RTl_"+a};eval(definitions.consts),eval(RiverTrail.definitions.consts);var reportError=RiverTrail.Helper.reportError,reportBug=RiverTrail.Helper.reportBug,findSelectionRoot=RiverTrail.Helper.findSelectionRoot,errorMsgs=[],newError=function(a){return errorMsgs[errorMsgs.length]="AT "+(calledScope.inCalledScope()||"<top level>")+": "+a,errorMsgs.length},getError=function(a){return errorMsgs[a-1]||"unknown error"},tempVars=[];tempVars.declare=function(){var a=this.join(";")+";";return this.splice(0,this.length),a};var calledScope=function(){"use strict";var a=!1,b=function(b){a=b||!0},c=function(b){a=b},d=function(){return a};return{enter:b,exit:c,inCalledScope:d}}(),toCNumber=function(a,b){var c="";return"float"===b.OpenCLType||"double"===b.OpenCLType?(c=a,-1===String.prototype.indexOf.call(c,".")&&-1===String.prototype.indexOf.call(c,"e")&&(c+=".0"),"float"===b.OpenCLType&&(c+="f")):"int"===b.OpenCLType?c=a:"boolean"===b.OpenCLType?c=a:reportBug("unexpected number value in toCNumber"),c},genFormalParams=function(a,b){"use strict";return calledScope.inCalledScope()?genNonKernelFormalParams(a):genKernelFormalParams(a,b)},genNonKernelFormalParams=function(a){"use strict";var b,c="",d=a.params,e=a.typeInfo.parameters;for(b=0;b<e.length;b++)""!==c&&(c+=", "),e[b].isArrayishType()&&(c=c+e[b].getOpenCLAddressSpace()+" "),c=c+e[b].OpenCLType+" "+RENAME(d[b]);return c},genKernelFormalParams=function(a,b){"use strict";var c,d="",e=a.params,f=a.typeInfo.parameters;for("combine"===b?(e=e.slice(1),f=f.slice(2)):"comprehension"===b||"comprehensionScalar"===b?(f=f.slice(1),e=e.slice(1)):"map"===b&&(f=f.slice(2),e=e.slice(1)),c=0;c<f.length;c++)""!==d&&(d+=", "),f[c].isArrayishType()&&(d=d+f[c].getOpenCLAddressSpace()+" "),d=d+f[c].OpenCLType+" "+RENAME(e[c]),f[c].isObjectType("ParallelArray")&&(d=d+", int "+RENAME(e[c])+"__offset");return d},adjustFormalsWithOffsets=function(a,b){"use strict";var c,d="",e=0,f=a.params,g=a.typeInfo.parameters;for(("map"===b||"combine"===b||"comprehension"===b||"comprehensionScalar"===b)&&(e=2),"combine"===b?(f=f.slice(1),g=g.slice(2)):"comprehension"===b||"comprehensionScalar"===b?(g=g.slice(1),f=f.slice(1)):"map"===b&&(g=g.slice(2),f=f.slice(1)),c=0;c<g.length;c++)g[c].isObjectType("ParallelArray")?d=d+RENAME(f[c])+" = &"+RENAME(f[c])+"["+RENAME(f[c])+"__offset];":g[c].isObjectType("JSArray")&&(d=d+RENAME(f[c])+" = *(("+RENAME(g[c]).getOpenCLAddressSpace()+" double **)"+RENAME(f[c])+");");
return d},genFormalRelativeArg=function(a,b){"use strict";var c,d,e,f,g=" ";if("combine"===b||"comprehension"===b||"comprehensionScalar"===b)if(f="combine"===b?a.typeInfo.parameters[1]:a.typeInfo.parameters[0],e=RENAME(a.params[0]),f.isObjectType("Array")){d=f.getOpenCLShape();var h=RiverTrail.Helper.stripToBaseType(f.OpenCLType);for(g=g+f.getOpenCLAddressSpace()+" "+h+" "+e+"["+d.toString()+"] = ",g+=" { ",c=0;c<d[0];c++)c>0&&(g+=", "),g=g+"("+h+") _id_"+c;g+="};"}else g=g+" "+f.OpenCLType+" "+e+" = _id_0;";else"map"===b&&(e=a.params[0],f=a.typeInfo.parameters[1],g=f.isScalarType()?g+" "+f.OpenCLType+" "+RENAME(e)+" = tempThis[_readoffset];":g+f.getOpenCLAddressSpace()+" "+f.OpenCLType+" "+RENAME(e)+" = &(tempThis[_readoffset]);");return g},prelude32="double __JS_array_sel_S(__global double *src, int idx) {            if (!src) {                /* previous selection failed */                return 0;            } else {                unsigned int *asInt = (unsigned int *) &(src[idx]);                if (asInt[1] == 0xFFFFFF81) return (double) asInt[0]; else return src[idx];            }}__global double *__JS_array_sel_A(__global double *src, int idx, int exp_len, int *_FAIL) {            if (!src) {                /* previous selection failed */                return src;            }            unsigned int *asInt = (unsigned int *) &(src[idx]);            double **asPtr = (double **) asInt[0];            unsigned int len = ((unsigned int*) (asPtr[3]-2))[2];            if (exp_len != len) {                *_FAIL = "+newError("JavaScript native array argument was not homogeneous")+";                 return (__global double *) 0;            } else {                return (__global double *) asPtr[3];            }}",prelude64="double __JS_array_sel_S(__global double *src, int idx) {            if (!src) {                /* previous selection failed */                return 0;            } else {                unsigned long asLong = ((unsigned long *) src)[idx];                if (((unsigned int) (asLong >> 47)) == 0x1FFF1) return (double) ((unsigned int) asLong); else return src[idx];            }} /* end prelude */__global double *__JS_array_sel_A(__global double *src, int idx, int exp_len, bool *_FAIL) {            if (!src) {                /* previous selection failed */                return src;            }            unsigned long asLong = ((unsigned long *) src)[idx];            double **asPtr = (double **) (asLong & 0x00007FFFFFFFFFFFLL);            unsigned int len = ((unsigned int*) (asPtr[3]-2))[2];            if (exp_len != len) {                *_FAIL = "+newError("JavaScript native array argument was not homogeneous")+";                 return (__global double *) 0;            } else {                return (__global double *) asPtr[3];            }} /* end prelude */",prelude="",boilerplateTemplates={map:{hasThis:!0,localThisName:" tempThis",localThisDefinition:" opThisVect[opThisVect__offset]",localResultName:" tempResult"},combine:{hasThis:!0,localThisName:" tempThis",localThisDefinition:" opThisVect[opThisVect__offset]",localResultName:" tempResult"},comprehension:{hasThis:!1,localThisName:void 0,localThisDefinition:" opThisVect[opThisVect__offset]",localResultName:" tempResult"},comprehensionScalar:{hasThis:!1,localThisName:void 0,localThisDefinition:" opThisVect[opThisVect__offset]",localResultName:" tempResult"}},boilerplate=null,isArrayLiteral=RiverTrail.Helper.isArrayLiteral,compileSelectionOperation=function(a,b,c){"use strict";var d,e,f,g,h,i="",j=b.typeInfo,k=j.getOpenCLShape(),l=k.length,m=a.typeInfo.getOpenCLShape().length;if(j.isObjectType("JSArray"))h=c.rangeInfo,i=0===m?i+"__JS_array_sel_S("+oclExpression(b)+", "+wrapIntoCheck(h,k[0],oclExpression(c),a)+")":i+"__JS_array_sel_A("+oclExpression(b)+", "+wrapIntoCheck(h,k[0],oclExpression(c),a)+", "+k[1]+", &_FAIL)";else{var n=j.isObjectType("ParallelArray"),o="__global"===j.getOpenCLAddressSpace();if(0!==m&&(i+=n||o?"( &":"("),e=a.typeInfo.getOpenCLShape().reduce(function(a,b){return a*b},1),n||o?i=i+" ( "+oclExpression(b)+"[0 ":i+=oclExpression(b),f=e,c.type!==LIST)h=c.rangeInfo,i=n||o?i+" + "+f+" * ("+wrapIntoCheck(h,k[0],oclExpression(c),a)+")":i+"["+wrapIntoCheck(h,k[0],oclExpression(c),a)+"]";else for(c.children[0]&&c.children[0].type===ARRAY_INIT&&(c=c.children[0]),h=c.rangeInfo,g=0!==c.children[0].typeInfo.getOpenCLShape().length,d=l-m-1;d>=0;d--)i=i+" + "+f+" * (",i=g?i+wrapIntoCheck(h?h.get(0).get(d):void 0,k[d],oclExpression(c.children[0],a)+"["+d+"]")+")":i+wrapIntoCheck(h?h.get(d):void 0,k[d],oclExpression(c.children[d]),a)+")",f*=j.getOpenCLShape()[d];(n||o)&&(i+="])"),0!==m&&(i+=" )")}return i},mathOCLMethod=function(a){"use strict";var b=a.children[0].children[1].value.toLowerCase();if("abs"===b)return"float"!==a.children[1].typeInfo[0].OpenCLType&&"double"!==a.children[1].typeInfo[0].OpenCLType?"(("+a.children[1].typeInfo[0].OpenCLType+") fabs((float) "+oclExpression(a.children[1])+"))":"fabs("+oclExpression(a.children[1])+")";if("round"===b)return"floor(.5 + "+oclExpression(a.children[1])+")";if("atan2"===b)return"atan2("+oclExpression(a.children[1])+","+oclExpression(a.children[1])+")";if("random"===b)return"(rand()/(RAND_MAX-1))";if("min"===b||"max"===b)throw new Error("Math."+b+"Not supported");return b+"("+oclExpression(a.children[1])+")"};return{compile:genKernel,getError:getError}}(),void 0===RiverTrail)var RiverTrail={};RiverTrail.compiler.runOCL=function(){var a=function(a,c,e,f,g,h,i,j,k){var l,m,n,o,p,q=[];"comprehension"===f||"comprehensionScalar"===f?(n=void 0,o=g,p=o.length):(n=RiverTrail.Helper.inferPAType(a),p=g,o=n.dimSize.slice(0,p));var r=function(a,b){if(b instanceof ParallelArray){if("CData"===b.name)a.push(b.data);else if(RiverTrail.Helper.isWebCLBufferObject(b.cachedOpenCLMem))a.push(b.cachedOpenCLMem);else{if(!RiverTrail.Helper.isTypedArray(b.data))throw new Error("Cannot transform regular array to OpenCL kernel arguments");var c;c=b.cachedOpenCLMem?b.cachedOpenCLMem:RiverTrail.runtime.mapData(b.data),a.push(c),k&&(b.cachedOpenCLMem=c)}a.push(new RiverTrail.Helper.Integer(0))}else if(b instanceof RiverTrail.Helper.FlatArray)a.push(RiverTrail.runtime.mapData(b.data));else if(b instanceof Array)a.push(RiverTrail.runtime.mapData(b));else if("number"==typeof b)a.push(b);else if(b instanceof Number)a.push(b.valueOf());else if(b instanceof RiverTrail.Helper.Integer)console.log("(object instanceof RiverTrail.Helper.Integer) encountered unexpectedly"),a.push(b);else{if(!RiverTrail.Helper.isTypedArray(b))throw new Error("only typed arrays and scalars are currently supported as OpenCL kernel arguments");a.push(RiverTrail.runtime.mapData(b))}return a};if("comprehension"!==f&&"comprehensionScalar"!==f&&r(q,a),void 0!==h&&Array.prototype.reduce.call(h,r,q),a&&void 0!==a.updateInPlacePA){if(e.typeInfo.result.isObjectType("InlineObject"))throw new Error("the impossible happened: in place scan operation with multiple returns!");var s;if(s=e.typeInfo.result.isScalarType()?o:o.concat(e.typeInfo.result.getOpenCLShape()),s.some(function(b,c){return b!==a.updateInPlaceShape[c]}))throw new Error("shape mismatch during update in place!");if(1!==++a.updateInPlacePA.updateInPlaceUses)throw new Error("preallocated memory used more than once!");"CData"!==a.updateInPlacePA.data.name&&(a.updateInPlacePA.cachedOpenCLMem?(a.updateInPlacePA.data=a.updateInPlacePA.cachedOpenCLMem,delete a.updateInPlacePA.cachedOpenCLMem):(a.updateInPlacePA.data=RiverTrail.runtime.mapData(a.updateInPlacePA.data),k&&(a.updateInPlacePA.cachedOpenCLMem=a.updateInPlacePA.data))),m={mem:a.updateInPlacePA.data,shape:s,type:RiverTrail.Helper.stripToBaseType(e.typeInfo.result.OpenCLType),offset:a.updateInPlaceOffset},q.push(m.mem),q.push(new RiverTrail.Helper.Integer(a.updateInPlaceOffset))}else{var t=function(a){var b,c=RiverTrail.Helper.stripToBaseType(a.OpenCLType);b=a.properties?o.concat(a.getOpenCLShape()):o;var e=RiverTrail.Helper.elementalTypeToConstructor(c);if(void 0==e)throw new Error("cannot map inferred type to constructor");var f=new e(d(b)),g=RiverTrail.runtime.mapData(f);return q.push(g),q.push(new RiverTrail.Helper.Integer(0)),{mem:g,shape:b,type:c,offset:0,hostAllocatedObject:f}};if(e.typeInfo.result.isObjectType("InlineObject")){m={};for(var u in e.typeInfo.result.properties.fields)m[u]=t(e.typeInfo.result.properties.fields[u])}else m=t(e.typeInfo.result)}for(var v=0;v<q.length;v++){var w=q[v];try{if("number"==typeof w)RiverTrail.runtime.setScalarArgument(c,v,w,!1,!j);else if(w instanceof RiverTrail.Helper.Integer)RiverTrail.runtime.setScalarArgument(c,v,w.value,!0,!1);else if("object"==typeof w&&"CData"===w.name)RiverTrail.runtime.setArgument(c,v,w);else{if("object"!=typeof w||"WebCLBuffer"!==w._name)throw new Error("unexpected kernel argument type!");RiverTrail.runtime.setArgument(c,v,w)}}catch(x){throw console.log("reduce error: ",x," index: ",v,"arg: ",w),x}}if("map"===f||"combine"==f||"comprehension"==f||"comprehensionScalar"==f){try{var y=!1;if(doIterationSpaceFlattening&&2==p){for(var z=[1],A=0;p>A;A++)z[0]*=o[A];y=RiverTrail.runtime.run(c,1,z,o.map(function(){return 1}))}else y=RiverTrail.runtime.run(c,p,o,o.map(function(){return 1}))}catch(x){throw console.log("kernel.run fails: ",x),x}if(y)throw new Error("kernel execution failed: "+RiverTrail.compiler.codeGen.getError(y))}else alert("runOCL only deals with comprehensions, map and combine (so far).");if(RiverTrail.Helper.isCData(m.mem)||RiverTrail.Helper.isWebCLBufferObject(m.mem))l=new ParallelArray(m.mem,m.hostAllocatedObject,m.shape),k&&(l.cachedOpenCLMem=m.mem);else{var B={};for(var u in m)B[u]=new ParallelArray(m[u].mem,m[u].shape,m[u].type,m[u].offset),k&&(B[u].cachedOpenCLMem=m[u].mem);l=new b(B)}return l},b=function(a){return this.unzip=function(){return a},this},c=function(a){return function(){throw"`"+a+"' not implemented for ParallelArray of objects. Please call `unzip' first!"}};b.prototype={},b.prototype.map=c("map"),b.prototype.combine=c("combine"),b.prototype.scan=c("scan"),b.prototype.filter=c("filter"),b.prototype.scatter=c("scatter"),b.prototype.reduce=c("reduce"),b.prototype.get=c("get"),b.prototype.partition=c("partition"),b.prototype.flatten=c("flatten"),b.prototype.toString=c("toString"),b.prototype.getShape=c("getShape"),b.prototype.getData=c("getData"),b.prototype.getArray=c("getArray");var d=function(a){var b,c;if(0==a.length)return 0;for(c=a[0],b=1;b<a.length;b++)c*=a[b];return c};return a}();